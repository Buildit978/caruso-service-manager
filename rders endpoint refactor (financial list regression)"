[1mdiff --git a/backend/src/models/invoice.model.ts b/backend/src/models/invoice.model.ts[m
[1mindex b8ec819..4d7e108 100644[m
[1m--- a/backend/src/models/invoice.model.ts[m
[1m+++ b/backend/src/models/invoice.model.ts[m
[36m@@ -1,7 +1,9 @@[m
 // backend/src/models/invoice.model.ts[m
 import { model, type Document, type Types } from "mongoose";[m
 import mongoose, { Schema } from "mongoose";[m
[32m+[m
 export type InvoiceStatus = "draft" | "sent" | "paid" | "void";[m
[32m+[m[32mexport type FinancialStatus = "paid" | "partial" | "due"; // âœ… NEW[m
 export type PaymentMethod = "cash" | "card" | "e-transfer" | "cheque";[m
 export type InvoiceEmailStatus = "never_sent" | "sending" | "sent" | "failed";[m
 [m
[36m@@ -40,9 +42,7 @@[m [mexport type InvoiceEmailMeta = {[m
   lastMessageId?: string;[m
   lastError?: string;[m
   attempts?: number;[m
[31m-}[m
[31m-[m
[31m-[m
[32m+[m[32m};[m
 [m
 export interface IInvoice extends Document {[m
   accountId: Types.ObjectId;[m
[36m@@ -50,22 +50,24 @@[m [mexport interface IInvoice extends Document {[m
   invoiceNumber: string;[m
   status: InvoiceStatus;[m
 [m
[32m+[m[32m  // âœ… NEW: canonical financial truth[m
[32m+[m[32m  financialStatus: FinancialStatus;[m
[32m+[m
   // âœ… lifecycle stamps (used for snapshot locking + finance status)[m
   sentAt?: Date;[m
   paidAt?: Date;[m
   voidedAt?: Date;[m
   voidReason?: string;[m
 [m
[31m- payments: Array<{[m
[31m-  method: PaymentMethod;[m
[31m-  reference?: string;[m
[31m-  amount: number;[m
[31m-  paidAt: string; // ISO string from API[m
[31m-}>;[m
[31m-[m
[31m-paidAmount: number;   // total paid so far[m
[31m-balanceDue: number;   // total - paidAmount[m
[32m+[m[32m  payments: Array<{[m
[32m+[m[32m    method: PaymentMethod;[m
[32m+[m[32m    reference?: string;[m
[32m+[m[32m    amount: number;[m
[32m+[m[32m    paidAt: string; // ISO string from API[m
[32m+[m[32m  }>;[m
 [m
[32m+[m[32m  paidAmount: number; // total paid so far[m
[32m+[m[32m  balanceDue: number; // total - paidAmount[m
 [m
   workOrderId: Types.ObjectId;[m
   customerId: Types.ObjectId;[m
[36m@@ -85,14 +87,13 @@[m [mbalanceDue: number;   // total - paidAmount[m
 [m
   notes?: string;[m
 [m
[31m- // âœ… email meta[m
[32m+[m[32m  // âœ… email meta[m
   email?: InvoiceEmailMeta;[m
 [m
   createdAt: Date;[m
   updatedAt: Date;[m
 }[m
 [m
[31m-[m
 const InvoiceLineItemSchema = new Schema<IInvoiceLineItem>([m
   {[m
     type: {[m
[36m@@ -154,21 +155,19 @@[m [mconst InvoiceVehicleSnapshotSchema = new Schema<IInvoiceVehicleSnapshot>([m
   { _id: false }[m
 );[m
 [m
[31m-  const InvoicePaymentSchema = new Schema([m
[31m-    {[m
[31m-      method: {[m
[31m-        type: String,[m
[31m-        enum: ["cash", "card", "e-transfer", "cheque"],[m
[31m-        required: true,[m
[31m-      },[m
[31m-      reference: { type: String, trim: true, default: "" },[m
[31m-      amount: { type: Number, required: true, min: 0.01 },[m
[31m-      paidAt: { type: Date, required: true, default: Date.now },[m
[32m+[m[32mconst InvoicePaymentSchema = new Schema([m
[32m+[m[32m  {[m
[32m+[m[32m    method: {[m
[32m+[m[32m      type: String,[m
[32m+[m[32m      enum: ["cash", "card", "e-transfer", "cheque"],[m
[32m+[m[32m      required: true,[m
     },[m
[31m-    { _id: false }[m
[31m-  );[m
[31m-[m
[31m-[m
[32m+[m[32m    reference: { type: String, trim: true, default: "" },[m
[32m+[m[32m    amount: { type: Number, required: true, min: 0.01 },[m
[32m+[m[32m    paidAt: { type: Date, required: true, default: Date.now },[m
[32m+[m[32m  },[m
[32m+[m[32m  { _id: false }[m
[32m+[m[32m);[m
 [m
 const InvoiceSchema = new Schema([m
   {[m
[36m@@ -195,6 +194,16 @@[m [mconst InvoiceSchema = new Schema([m
       index: true,[m
     },[m
 [m
[32m+[m[32m    // âœ… NEW: canonical financial status (backend truth)[m
[32m+[m[32m    financialStatus: {[m
[32m+[m[32m      type: String,[m
[32m+[m[32m      enum: ["paid", "partial", "due"],[m
[32m+[m[32m      default: "due",[m
[32m+[m[32m      lowercase: true,[m
[32m+[m[32m      trim: true,[m
[32m+[m[32m      index: true,[m
[32m+[m[32m    },[m
[32m+[m
     // âœ… lifecycle stamps[m
     sentAt: { type: Date },[m
     paidAt: { type: Date },[m
[36m@@ -202,26 +211,24 @@[m [mconst InvoiceSchema = new Schema([m
     voidReason: { type: String, trim: true },[m
 [m
     payments: {[m
[31m-    type: [InvoicePaymentSchema],[m
[31m-    required: true,[m
[31m-    default: [],[m
[31m-  },[m
[31m-  paidAmount: { type: Number, required: true, default: 0, min: 0 },[m
[31m-  balanceDue: { type: Number, required: true, default: 0, min: 0 },[m
[32m+[m[32m      type: [InvoicePaymentSchema],[m
[32m+[m[32m      required: true,[m
[32m+[m[32m      default: [],[m
[32m+[m[32m    },[m
 [m
[32m+[m[32m    paidAmount: { type: Number, required: true, default: 0, min: 0 },[m
[32m+[m[32m    balanceDue: { type: Number, required: true, default: 0, min: 0 },[m
 [m
     kind: {[m
[31m-          type: String,[m
[31m-          enum: ["standard", "deposit", "final", "credit", "revision"],[m
[31m-          default: "standard",[m
[31m-          index: true,[m
[31m-          },[m
[31m-[m
[31m-revision: { type: Number, default: 0, min: 0 },[m
[31m-[m
[31m-parentInvoiceId: { type: Schema.Types.ObjectId, ref: "Invoice" },[m
[32m+[m[32m      type: String,[m
[32m+[m[32m      enum: ["standard", "deposit", "final", "credit", "revision"],[m
[32m+[m[32m      default: "standard",[m
[32m+[m[32m      index: true,[m
[32m+[m[32m    },[m
 [m
[32m+[m[32m    revision: { type: Number, default: 0, min: 0 },[m
 [m
[32m+[m[32m    parentInvoiceId: { type: Schema.Types.ObjectId, ref: "Invoice" },[m
 [m
     workOrderId: {[m
       type: Schema.Types.ObjectId,[m
[36m@@ -309,9 +316,6 @@[m [mparentInvoiceId: { type: Schema.Types.ObjectId, ref: "Invoice" },[m
   { timestamps: true }[m
 );[m
 [m
[31m-[m
[31m-[m
[31m-[m
 export type Invoice = mongoose.InferSchemaType<typeof InvoiceSchema>;[m
 export type InvoiceDoc = mongoose.HydratedDocument<Invoice>;[m
 [m
[36m@@ -323,13 +327,8 @@[m [mInvoiceSchema.index({ accountId: 1, status: 1, createdAt: -1 }); // helpful for[m
 InvoiceSchema.index({ accountId: 1, status: 1, paidAt: -1 });[m
 InvoiceSchema.index({ accountId: 1, status: 1, sentAt: -1 });[m
 [m
[32m+[m[32m// âœ… NEW (optional but helpful): finance filtering/sorting[m
[32m+[m[32mInvoiceSchema.index({ accountId: 1, financialStatus: 1, createdAt: -1 });[m
[32m+[m
 const InvoiceModel = mongoose.model<Invoice>("Invoice", InvoiceSchema);[m
 export default InvoiceModel;[m
[31m-[m
[31m-[m
[31m-[m
[31m-[m
[31m-[m
[31m-[m
[31m-[m
[31m-[m
[1mdiff --git a/backend/src/routes/invoice.routes.ts b/backend/src/routes/invoice.routes.ts[m
[1mindex 9bbdd6f..a472620 100644[m
[1m--- a/backend/src/routes/invoice.routes.ts[m
[1m+++ b/backend/src/routes/invoice.routes.ts[m
[36m@@ -8,10 +8,10 @@[m [mimport { Vehicle } from "../models/vehicle.model";[m
 import { Customer } from "../models/customer.model";[m
 import { buildInvoicePdfBuffer } from "../utils/invoicePdf";[m
 import { getMailer } from "../utils/mailer";[m
[31m-import {[m
[31m-  assertCanEditInvoice,[m
[31m-  assertValidInvoiceTransition,[m
[31m-} from "../domain/invoices/invoiceLifecycle";[m
[32m+[m[32mimport { assertCanEditInvoice, assertValidInvoiceTransition, } from "../domain/invoices/invoiceLifecycle";[m
[32m+[m[32mimport { requireInvoiceEditable, requireInvoiceNotPaid, } from "../middleware/invoiceLocks";[m
[32m+[m[32mimport { applyInvoiceFinancials, computeInvoiceFinancials } from "../utils/invoiceFinancials";[m
[32m+[m
 [m
 const router = Router();[m
 [m
[36m@@ -70,202 +70,210 @@[m [masync function getNextInvoiceNumber(accountId: Types.ObjectId): Promise<string>[m
  */[m
 [m
 // GET /api/invoices/financial/summary[m
[31m-router.get("/financial/summary", async (req: Request, res: Response, next: NextFunction) => {[m
[31m-  try {[m
[31m-    const accountId = req.accountId;[m
[31m-    if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m[32mrouter.get([m
[32m+[m[32m  "/financial/summary",[m
[32m+[m[32m  async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const accountId = req.accountId;[m
[32m+[m[32m      if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
 [m
[31m-    const now = new Date();[m
[31m-    const startDefault = new Date(now.getFullYear(), now.getMonth(), 1);[m
[31m-    const endDefault = new Date(now.getFullYear(), now.getMonth() + 1, 1);[m
[32m+[m[32m      const now = new Date();[m
[32m+[m[32m      const startDefault = new Date(now.getFullYear(), now.getMonth(), 1);[m
[32m+[m[32m      const endDefault = new Date(now.getFullYear(), now.getMonth() + 1, 1);[m
 [m
[31m-    const fromStr = typeof req.query.from === "string" ? req.query.from : "";[m
[31m-    const toStr = typeof req.query.to === "string" ? req.query.to : "";[m
[32m+[m[32m      const fromStr = typeof req.query.from === "string" ? req.query.from : "";[m
[32m+[m[32m      const toStr = typeof req.query.to === "string" ? req.query.to : "";[m
 [m
[31m-    const from = fromStr ? new Date(fromStr) : startDefault;[m
[31m-    const to = toStr ? new Date(toStr) : endDefault;[m
[32m+[m[32m      const from = fromStr ? new Date(fromStr) : startDefault;[m
[32m+[m[32m      const to = toStr ? new Date(toStr) : endDefault;[m
 [m
[31m-    if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) {[m
[31m-      return res.status(400).json({ message: "Invalid from/to date. Use YYYY-MM-DD." });[m
[31m-    }[m
[32m+[m[32m      if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) {[m
[32m+[m[32m        return res.status(400).json({ message: "Invalid from/to date. Use YYYY-MM-DD." });[m
[32m+[m[32m      }[m
 [m
[31m-    const baseMatch = { accountId };[m
[31m-[m
[31m-    const [totals] = await Invoice.aggregate([[m
[31m-      { $match: baseMatch },[m
[31m-      {[m
[31m-        $facet: {[m
[31m-          revenuePaid: [[m
[31m-            { $match: { status: "paid", paidAt: { $gte: from, $lt: to } } },[m
[31m-            {[m
[31m-              $group: {[m
[31m-                _id: null,[m
[31m-                count: { $sum: 1 },[m
[31m-                amount: { $sum: "$total" },[m
[31m-                tax: { $sum: "$taxAmount" },[m
[31m-                subtotal: { $sum: "$subtotal" },[m
[32m+[m[32m      const baseMatch = { accountId };[m
[32m+[m
[32m+[m[32m      const [totals] = await Invoice.aggregate([[m
[32m+[m[32m        { $match: baseMatch },[m
[32m+[m[32m        {[m
[32m+[m[32m          $facet: {[m
[32m+[m[32m            // âœ… Paid = canonical (status is only set to paid when balanceDue hits 0 in our backend logic)[m
[32m+[m[32m            revenuePaid: [[m
[32m+[m[32m              { $match: { status: "paid", paidAt: { $gte: from, $lt: to } } },[m
[32m+[m[32m              {[m
[32m+[m[32m                $group: {[m
[32m+[m[32m                  _id: null,[m
[32m+[m[32m                  count: { $sum: 1 },[m
[32m+[m[32m                  amount: { $sum: "$total" },[m
[32m+[m[32m                  tax: { $sum: "$taxAmount" },[m
[32m+[m[32m                  subtotal: { $sum: "$subtotal" },[m
[32m+[m[32m                },[m
               },[m
[31m-            },[m
[31m-          ],[m
[31m-          outstandingSent: [[m
[31m-            { $match: { status: "sent", sentAt: { $exists: true } } },[m
[31m-            {[m
[31m-              $group: {[m
[31m-                _id: null,[m
[31m-                count: { $sum: 1 },[m
[31m-                amount: { $sum: "$total" },[m
[32m+[m[32m            ],[m
[32m+[m
[32m+[m[32m            // âœ… Outstanding = sent + money still due (prevents "sent but actually paid" drift)[m
[32m+[m[32m            outstandingSent: [[m
[32m+[m[32m              {[m
[32m+[m[32m                $match: {[m
[32m+[m[32m                  status: "sent",[m
[32m+[m[32m                  sentAt: { $exists: true },[m
[32m+[m[32m                  balanceDue: { $gt: 0 },[m
[32m+[m[32m                },[m
               },[m
[31m-            },[m
[31m-          ],[m
[31m-          drafts: [[m
[31m-            { $match: { status: "draft", createdAt: { $gte: from, $lt: to } } },[m
[31m-            {[m
[31m-              $group: {[m
[31m-                _id: null,[m
[31m-                count: { $sum: 1 },[m
[31m-                amount: { $sum: "$total" },[m
[32m+[m[32m              {[m
[32m+[m[32m                $group: {[m
[32m+[m[32m                  _id: null,[m
[32m+[m[32m                  count: { $sum: 1 },[m
[32m+[m[32m                  amount: { $sum: "$balanceDue" }, // outstanding dollars[m
[32m+[m[32m                },[m
               },[m
[31m-            },[m
[31m-          ],[m
[31m-          voided: [[m
[31m-            { $match: { status: "void", voidedAt: { $gte: from, $lt: to } } },[m
[31m-            {[m
[31m-              $group: {[m
[31m-                _id: null,[m
[31m-                count: { $sum: 1 },[m
[31m-                amount: { $sum: "$total" },[m
[32m+[m[32m            ],[m
[32m+[m
[32m+[m[32m            drafts: [[m
[32m+[m[32m              { $match: { status: "draft", createdAt: { $gte: from, $lt: to } } },[m
[32m+[m[32m              {[m
[32m+[m[32m                $group: {[m
[32m+[m[32m                  _id: null,[m
[32m+[m[32m                  count: { $sum: 1 },[m
[32m+[m[32m                  amount: { $sum: "$total" },[m
[32m+[m[32m                },[m
               },[m
[31m-            },[m
[31m-          ],[m
[31m-          aging: [[m
[31m-            { $match: { status: "sent", sentAt: { $exists: true } } },[m
[31m-            {[m
[31m-              $addFields: {[m
[31m-                daysOutstanding: {[m
[31m-                  $dateDiff: { startDate: "$sentAt", endDate: now, unit: "day" },[m
[32m+[m[32m            ],[m
[32m+[m
[32m+[m[32m            voided: [[m
[32m+[m[32m              { $match: { status: "void", voidedAt: { $gte: from, $lt: to } } },[m
[32m+[m[32m              {[m
[32m+[m[32m                $group: {[m
[32m+[m[32m                  _id: null,[m
[32m+[m[32m                  count: { $sum: 1 },[m
[32m+[m[32m                  amount: { $sum: "$total" },[m
                 },[m
               },[m
[31m-            },[m
[31m-            {[m
[31m-              $group: {[m
[31m-                _id: {[m
[31m-                  $switch: {[m
[31m-                    branches: [[m
[31m-                      { case: { $lte: ["$daysOutstanding", 7] }, then: "0-7" },[m
[31m-                      { case: { $lte: ["$daysOutstanding", 14] }, then: "8-14" },[m
[31m-                      { case: { $lte: ["$daysOutstanding", 30] }, then: "15-30" },[m
[32m+[m[32m            ],[m
[32m+[m
[32m+[m[32m            // âœ… Aging only for invoices that are truly still outstanding[m
[32m+[m[32m            aging: [[m
[32m+[m[32m              {[m
[32m+[m[32m                $match: {[m
[32m+[m[32m                  status: "sent",[m
[32m+[m[32m                  sentAt: { $exists: true },[m
[32m+[m[32m                  balanceDue: { $gt: 0 },[m
[32m+[m[32m                },[m
[32m+[m[32m              },[m
[32m+[m[32m              {[m
[32m+[m[32m                $addFields: {[m
[32m+[m[32m                  daysOutstanding: {[m
[32m+[m[32m                    $dateDiff: { startDate: "$sentAt", endDate: now, unit: "day" },[m
[32m+[m[32m                  },[m
[32m+[m[32m                },[m
[32m+[m[32m              },[m
[32m+[m[32m              {[m
[32m+[m[32m                $group: {[m
[32m+[m[32m                  _id: {[m
[32m+[m[32m                    $switch: {[m
[32m+[m[32m                      branches: [[m
[32m+[m[32m                        { case: { $lte: ["$daysOutstanding", 7] }, then: "0-7" },[m
[32m+[m[32m                        { case: { $lte: ["$daysOutstanding", 14] }, then: "8-14" },[m
[32m+[m[32m                        { case: { $lte: ["$daysOutstanding", 30] }, then: "15-30" },[m
[32m+[m[32m                      ],[m
[32m+[m[32m                      default: "31+",[m
[32m+[m[32m                    },[m
[32m+[m[32m                  },[m
[32m+[m[32m                  count: { $sum: 1 },[m
[32m+[m[32m                  amount: { $sum: "$balanceDue" }, // outstanding dollars in bucket[m
[32m+[m[32m                },[m
[32m+[m[32m              },[m
[32m+[m[32m              { $sort: { _id: 1 } },[m
[32m+[m[32m            ],[m
[32m+[m[32m          },[m
[32m+[m[32m        },[m
[32m+[m[32m        {[m
[32m+[m[32m          $project: {[m
[32m+[m[32m            revenuePaid: {[m
[32m+[m[32m              $let: {[m
[32m+[m[32m                vars: {[m
[32m+[m[32m                  r: {[m
[32m+[m[32m                    $ifNull: [[m
[32m+[m[32m                      { $arrayElemAt: ["$revenuePaid", 0] },[m
[32m+[m[32m                      { count: 0, amount: 0, tax: 0, subtotal: 0 },[m
                     ],[m
[31m-                    default: "31+",[m
                   },[m
                 },[m
[31m-                count: { $sum: 1 },[m
[31m-                amount: { $sum: "$total" },[m
[32m+[m[32m                in: {[m
[32m+[m[32m                  count: "$$r.count",[m
[32m+[m[32m                  amount: { $round: ["$$r.amount", 2] },[m
[32m+[m[32m                  tax: { $round: ["$$r.tax", 2] },[m
[32m+[m[32m                  subtotal: { $round: ["$$r.subtotal", 2] },[m
[32m+[m[32m                },[m
               },[m
             },[m
[31m-            { $sort: { _id: 1 } },[m
[31m-          ],[m
[31m-        },[m
[31m-      },[m
[31m-      {[m
[31m-  $project: {[m
[31m-    revenuePaid: {[m
[31m-      $let: {[m
[31m-        vars: {[m
[31m-          r: {[m
[31m-            $ifNull: [[m
[31m-              { $arrayElemAt: ["$revenuePaid", 0] },[m
[31m-              { count: 0, amount: 0, tax: 0, subtotal: 0 }[m
[31m-            ][m
[31m-          }[m
[31m-        },[m
[31m-        in: {[m
[31m-          count: "$$r.count",[m
[31m-          amount: { $round: ["$$r.amount", 2] },[m
[31m-          tax: { $round: ["$$r.tax", 2] },[m
[31m-          subtotal: { $round: ["$$r.subtotal", 2] }[m
[31m-        }[m
[31m-      }[m
[31m-    },[m
 [m
[31m-    outstandingSent: {[m
[31m-      $let: {[m
[31m-        vars: {[m
[31m-          o: {[m
[31m-            $ifNull: [[m
[31m-              { $arrayElemAt: ["$outstandingSent", 0] },[m
[31m-              { count: 0, amount: 0 }[m
[31m-            ][m
[31m-          }[m
[31m-        },[m
[31m-        in: {[m
[31m-          count: "$$o.count",[m
[31m-          amount: { $round: ["$$o.amount", 2] }[m
[31m-        }[m
[31m-      }[m
[31m-    },[m
[32m+[m[32m            outstandingSent: {[m
[32m+[m[32m              $let: {[m
[32m+[m[32m                vars: {[m
[32m+[m[32m                  o: {[m
[32m+[m[32m                    $ifNull: [{ $arrayElemAt: ["$outstandingSent", 0] }, { count: 0, amount: 0 }],[m
[32m+[m[32m                  },[m
[32m+[m[32m                },[m
[32m+[m[32m                in: {[m
[32m+[m[32m                  count: "$$o.count",[m
[32m+[m[32m                  amount: { $round: ["$$o.amount", 2] },[m
[32m+[m[32m                },[m
[32m+[m[32m              },[m
[32m+[m[32m            },[m
 [m
[31m-    drafts: {[m
[31m-      $let: {[m
[31m-        vars: {[m
[31m-          d: {[m
[31m-            $ifNull: [[m
[31m-              { $arrayElemAt: ["$drafts", 0] },[m
[31m-              { count: 0, amount: 0 }[m
[31m-            ][m
[31m-          }[m
[31m-        },[m
[31m-        in: {[m
[31m-          count: "$$d.count",[m
[31m-          amount: { $round: ["$$d.amount", 2] }[m
[31m-        }[m
[31m-      }[m
[31m-    },[m
[32m+[m[32m            drafts: {[m
[32m+[m[32m              $let: {[m
[32m+[m[32m                vars: {[m
[32m+[m[32m                  d: { $ifNull: [{ $arrayElemAt: ["$drafts", 0] }, { count: 0, amount: 0 }] },[m
[32m+[m[32m                },[m
[32m+[m[32m                in: {[m
[32m+[m[32m                  count: "$$d.count",[m
[32m+[m[32m                  amount: { $round: ["$$d.amount", 2] },[m
[32m+[m[32m                },[m
[32m+[m[32m              },[m
[32m+[m[32m            },[m
 [m
[31m-    voided: {[m
[31m-      $let: {[m
[31m-        vars: {[m
[31m-          v: {[m
[31m-            $ifNull: [[m
[31m-              { $arrayElemAt: ["$voided", 0] },[m
[31m-              { count: 0, amount: 0 }[m
[31m-            ][m
[31m-          }[m
[32m+[m[32m            voided: {[m
[32m+[m[32m              $let: {[m
[32m+[m[32m                vars: {[m
[32m+[m[32m                  v: { $ifNull: [{ $arrayElemAt: ["$voided", 0] }, { count: 0, amount: 0 }] },[m
[32m+[m[32m                },[m
[32m+[m[32m                in: {[m
[32m+[m[32m                  count: "$$v.count",[m
[32m+[m[32m                  amount: { $round: ["$$v.amount", 2] },[m
[32m+[m[32m                },[m
[32m+[m[32m              },[m
[32m+[m[32m            },[m
[32m+[m
[32m+[m[32m            aging: {[m
[32m+[m[32m              $map: {[m
[32m+[m[32m                input: "$aging",[m
[32m+[m[32m                as: "a",[m
[32m+[m[32m                in: {[m
[32m+[m[32m                  _id: "$$a._id",[m
[32m+[m[32m                  count: "$$a.count",[m
[32m+[m[32m                  amount: { $round: ["$$a.amount", 2] },[m
[32m+[m[32m                },[m
[32m+[m[32m              },[m
[32m+[m[32m            },[m
[32m+[m[32m          },[m
         },[m
[31m-        in: {[m
[31m-          count: "$$v.count",[m
[31m-          amount: { $round: ["$$v.amount", 2] }[m
[31m-        }[m
[31m-      }[m
[31m-    },[m
[32m+[m[32m      ]);[m
 [m
[31m-    aging: {[m
[31m-      $map: {[m
[31m-        input: "$aging",[m
[31m-        as: "a",[m
[31m-        in: {[m
[31m-          _id: "$$a._id",[m
[31m-          count: "$$a.count",[m
[31m-          amount: { $round: ["$$a.amount", 2] }[m
[31m-        }[m
[31m-      }[m
[32m+[m[32m      return res.json({[m
[32m+[m[32m        range: { from: from.toISOString(), to: to.toISOString() },[m
[32m+[m[32m        revenuePaid: totals?.revenuePaid ?? { count: 0, amount: 0, tax: 0, subtotal: 0 },[m
[32m+[m[32m        outstandingSent: totals?.outstandingSent ?? { count: 0, amount: 0 },[m
[32m+[m[32m        drafts: totals?.drafts ?? { count: 0, amount: 0 },[m
[32m+[m[32m        voided: totals?.voided ?? { count: 0, amount: 0 },[m
[32m+[m[32m        aging: totals?.aging ?? [],[m
[32m+[m[32m      });[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m      next(err);[m
     }[m
   }[m
[31m-}[m
[31m-[m
[31m-    ]);[m
[31m-[m
[31m-    return res.json({[m
[31m-      range: { from: from.toISOString(), to: to.toISOString() },[m
[31m-      revenuePaid: totals?.revenuePaid ?? { count: 0, amount: 0, tax: 0, subtotal: 0 },[m
[31m-      outstandingSent: totals?.outstandingSent ?? { count: 0, amount: 0 },[m
[31m-      drafts: totals?.drafts ?? { count: 0, amount: 0 },[m
[31m-      voided: totals?.voided ?? { count: 0, amount: 0 },[m
[31m-      aging: totals?.aging ?? [],[m
[31m-    });[m
[31m-  } catch (err) {[m
[31m-    next(err);[m
[31m-  }[m
[31m-});[m
[32m+[m[32m);[m
 [m
 /**[m
  * âœ… 2) Collection routes[m
[36m@@ -283,186 +291,272 @@[m [mrouter.get("/", async (req: Request, res: Response, next: NextFunction) => {[m
       .populate("workOrderId", "status")[m
       .lean();[m
 [m
[31m-    res.json(invoices);[m
[32m+[m[32m    const withFinancials = invoices.map((inv: any) => {[m
[32m+[m[32m      const fin = computeInvoiceFinancials(inv);[m
[32m+[m[32m      return { ...inv, ...fin };[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    return res.json(withFinancials);[m
   } catch (err) {[m
     next(err);[m
   }[m
 });[m
 [m
[31m-/**[m
[31m- * âœ… 3) Creation routes (specific)[m
[31m- */[m
 [m
[31m-// POST /api/invoices/from-work-order/:workOrderId[m
[31m-router.post("/from-work-order/:workOrderId", async (req: Request, res: Response) => {[m
[32m+[m
[32m+[m[32m// GET /api/invoices/:id[m
[32m+[m[32mrouter.get("/:id", async (req: Request, res: Response, next: NextFunction) => {[m
   try {[m
     const accountId = req.accountId;[m
     if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
 [m
[31m-    const { workOrderId } = req.params;[m
[31m-[m
[31m-    const workOrder = await WorkOrder.findOne({ _id: workOrderId, accountId }).populate([m
[31m-      "customerId",[m
[31m-      "firstName lastName phone email address vehicles"[m
[31m-    );[m
[32m+[m[32m    const { id } = req.params;[m
[32m+[m[32m    if (!Types.ObjectId.isValid(id)) return res.status(400).json({ message: "Invalid invoice id" });[m
 [m
[31m-    if (!workOrder) return res.status(404).json({ message: "Work order not found" });[m
[32m+[m[32m    const invoice = await Invoice.findOne({ _id: id, accountId })[m
[32m+[m[32m      .populate("customerId", "firstName lastName phone email address vehicles")[m
[32m+[m[32m      .populate("workOrderId", "status")[m
[32m+[m[32m      .lean();[m
 [m
[31m-    const allowedStatuses = ["open", "in_progress", "completed"];[m
[31m-    if (!allowedStatuses.includes(workOrder.status)) {[m
[31m-      return res.status(400).json({[m
[31m-        message: `Cannot create invoice from work order with status "${workOrder.status}".`,[m
[31m-      });[m
[31m-    }[m
[32m+[m[32m    if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
 [m
[31m-    const existingInvoice = await Invoice.findOne({[m
[31m-      accountId,[m
[31m-      workOrderId: workOrder._id,[m
[31m-    })[m
[31m-      .select("_id invoiceNumber status")[m
[31m-      .lean();[m
[32m+[m[32m    res.json(invoice);[m
[32m+[m[32m  } catch (err) {[m
[32m+[m[32m    next(err);[m
[32m+[m[32m  }[m
[32m+[m[32m});[m
 [m
[31m-    if (existingInvoice) {[m
[31m-      if (!workOrder.invoiceId) workOrder.invoiceId = existingInvoice._id as any;[m
[31m-      if (workOrder.status !== "invoiced") workOrder.status = "invoiced";[m
[31m-      await workOrder.save();[m
[32m+[m[32m/**[m
[32m+[m[32m * âœ… 3) Creation routes (specific)[m
[32m+[m[32m */[m
 [m
[31m-      return res.status(200).json({[m
[31m-        ok: true,[m
[31m-        alreadyExists: true,[m
[31m-        invoice: {[m
[31m-          _id: existingInvoice._id,[m
[31m-          invoiceNumber: existingInvoice.invoiceNumber,[m
[31m-          status: existingInvoice.status,[m
[31m-        },[m
[31m-      });[m
[31m-    }[m
[32m+[m[32m// POST /api/invoices/from-work-order/:workOrderId[m
[32m+[m[32mrouter.post([m
[32m+[m[32m  "/from-work-order/:workOrderId",[m
[32m+[m[32m  async (req: Request, res: Response) => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const accountId = req.accountId;[m
[32m+[m[32m      if (!accountId)[m
[32m+[m[32m        return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m
[32m+[m[32m      const { workOrderId } = req.params;[m
[32m+[m
[32m+[m[32m      const workOrder = await WorkOrder.findOne({[m
[32m+[m[32m        _id: workOrderId,[m
[32m+[m[32m        accountId,[m
[32m+[m[32m      }).populate("customerId", "firstName lastName phone email address vehicles");[m
[32m+[m
[32m+[m[32m      if (!workOrder)[m
[32m+[m[32m        return res.status(404).json({ message: "Work order not found" });[m
[32m+[m
[32m+[m[32m      // âœ… allow creating invoice from these statuses only[m
[32m+[m[32m      const allowedStatuses = ["open", "in_progress", "completed"];[m
[32m+[m[32m      if (!allowedStatuses.includes(workOrder.status)) {[m
[32m+[m[32m        return res.status(400).json({[m
[32m+[m[32m          message: `Cannot create invoice from work order with status "${workOrder.status}".`,[m
[32m+[m[32m        });[m
[32m+[m[32m      }[m
 [m
[31m-    const customer: any = workOrder.customerId;[m
[31m-    if (!customer || !customer._id) {[m
[31m-      return res.status(400).json({ message: "Work order has no valid customer" });[m
[31m-    }[m
[32m+[m[32m      // âœ… If invoice already exists, return it (include financialStatus)[m
[32m+[m[32m      const existingInvoice = await Invoice.findOne({[m
[32m+[m[32m        accountId,[m
[32m+[m[32m        workOrderId: workOrder._id,[m
[32m+[m[32m      })[m
[32m+[m[32m        // include what computeInvoiceFinancials needs[m
[32m+[m[32m        .select([m
[32m+[m[32m          "_id invoiceNumber status total payments paidAmount balanceDue sentAt paidAt voidedAt"[m
[32m+[m[32m        )[m
[32m+[m[32m        .lean();[m
[32m+[m
[32m+[m[32m      if (existingInvoice) {[m
[32m+[m[32m        if (!workOrder.invoiceId) workOrder.invoiceId = existingInvoice._id as any;[m
[32m+[m[32m        if (workOrder.status !== "invoiced") workOrder.status = "invoiced";[m
[32m+[m[32m        await workOrder.save();[m
[32m+[m
[32m+[m[32m        const total = Number(existingInvoice.total ?? 0);[m
[32m+[m[32m        const payments = Array.isArray(existingInvoice.payments)[m
[32m+[m[32m          ? existingInvoice.payments[m
[32m+[m[32m          : [];[m
[32m+[m
[32m+[m[32m        // âœ… authoritative financial truth[m
[32m+[m[32m        const fin = computeInvoiceFinancials({ total, payments } as any);[m
[32m+[m
[32m+[m[32m        return res.status(200).json({[m
[32m+[m[32m          ok: true,[m
[32m+[m[32m          alreadyExists: true,[m
[32m+[m[32m          invoice: {[m
[32m+[m[32m            _id: existingInvoice._id,[m
[32m+[m[32m            invoiceNumber: existingInvoice.invoiceNumber,[m
[32m+[m
[32m+[m[32m            // lifecycle (keep)[m
[32m+[m[32m            status: existingInvoice.status,[m
[32m+[m
[32m+[m[32m            // financial truth (add)[m
[32m+[m[32m            financialStatus: fin.financialStatus,[m
[32m+[m
[32m+[m[32m            // helpful totals (consistent with other endpoints)[m
[32m+[m[32m            total,[m
[32m+[m[32m            paidAmount: fin.paidAmount,[m
[32m+[m[32m            balanceDue: fin.balanceDue,[m
[32m+[m
[32m+[m[32m            // timestamps if you need them in UI[m
[32m+[m[32m            sentAt: existingInvoice.sentAt ?? null,[m
[32m+[m[32m            paidAt: existingInvoice.paidAt ?? null,[m
[32m+[m[32m            voidedAt: existingInvoice.voidedAt ?? null,[m
[32m+[m[32m          },[m
[32m+[m[32m        });[m
[32m+[m[32m      }[m
 [m
[31m-    const rawLineItems: any[] = Array.isArray(workOrder.lineItems) ? workOrder.lineItems : [];[m
[31m-    const normalizedLineItems = rawLineItems.map((item: any) => {[m
[31m-      const quantity = Number(item?.quantity) || 0;[m
[31m-      const unitPrice = Number(item?.unitPrice) || 0;[m
[31m-      const lineTotal = typeof item?.lineTotal === "number" ? item.lineTotal : quantity * unitPrice;[m
[31m-      return {[m
[31m-        type: item?.type,[m
[31m-        description: item?.description ?? "",[m
[31m-        quantity,[m
[31m-        unitPrice,[m
[31m-        lineTotal,[m
[31m-      };[m
[31m-    });[m
[32m+[m[32m      const customer: any = workOrder.customerId;[m
[32m+[m[32m      if (!customer || !customer._id) {[m
[32m+[m[32m        return res[m
[32m+[m[32m          .status(400)[m
[32m+[m[32m          .json({ message: "Work order has no valid customer" });[m
[32m+[m[32m      }[m
 [m
[31m-    const subtotal =[m
[31m-      typeof (workOrder as any).subtotal === "number"[m
[31m-        ? (workOrder as any).subtotal[m
[31m-        : normalizedLineItems.reduce((sum: number, item: any) => sum + (item.lineTotal || 0), 0);[m
[32m+[m[32m      // âœ… normalize line items[m
[32m+[m[32m      const rawLineItems: any[] = Array.isArray(workOrder.lineItems)[m
[32m+[m[32m        ? workOrder.lineItems[m
[32m+[m[32m        : [];[m
[32m+[m[32m      const normalizedLineItems = rawLineItems.map((item: any) => {[m
[32m+[m[32m        const quantity = Number(item?.quantity) || 0;[m
[32m+[m[32m        const unitPrice = Number(item?.unitPrice) || 0;[m
[32m+[m[32m        const lineTotal =[m
[32m+[m[32m          typeof item?.lineTotal === "number"[m
[32m+[m[32m            ? item.lineTotal[m
[32m+[m[32m            : quantity * unitPrice;[m
[32m+[m
[32m+[m[32m        return {[m
[32m+[m[32m          type: item?.type,[m
[32m+[m[32m          description: item?.description ?? "",[m
[32m+[m[32m          quantity,[m
[32m+[m[32m          unitPrice,[m
[32m+[m[32m          lineTotal,[m
[32m+[m[32m        };[m
[32m+[m[32m      });[m
 [m
[31m-    const taxRate =[m
[31m-      typeof (workOrder as any).taxRate === "number" && !Number.isNaN((workOrder as any).taxRate)[m
[32m+[m[32m      // âœ… totals[m
[32m+[m[32m      const subtotal =[m
[32m+[m[32m        typeof (workOrder as any).subtotal === "number"[m
[32m+[m[32m          ? (workOrder as any).subtotal[m
[32m+[m[32m          : normalizedLineItems.reduce([m
[32m+[m[32m              (sum: number, item: any) => sum + (item.lineTotal || 0),[m
[32m+[m[32m              0[m
[32m+[m[32m            );[m
[32m+[m
[32m+[m[32m      const taxRate =[m
[32m+[m[32m        typeof (workOrder as any).taxRate === "number" &&[m
[32m+[m[32m        !Number.isNaN((workOrder as any).taxRate)[m
         ? (workOrder as any).taxRate[m
         : 13;[m
 [m
[31m-    const taxAmount =[m
[31m-      typeof (workOrder as any).taxAmount === "number"[m
[31m-        ? (workOrder as any).taxAmount[m
[31m-        : subtotal * (taxRate / 100);[m
[31m-[m
[31m-    const total =[m
[31m-      typeof (workOrder as any).total === "number"[m
[31m-        ? (workOrder as any).total[m
[31m-        : subtotal + taxAmount;[m
[31m-[m
[31m-    const customerSnapshot = {[m
[31m-      customerId: customer._id,[m
[31m-      firstName: customer.firstName,[m
[31m-      lastName: customer.lastName,[m
[31m-      phone: customer.phone,[m
[31m-      email: customer.email,[m
[31m-      address: customer.address,[m
[31m-    };[m
[32m+[m[32m      const taxAmount =[m
[32m+[m[32m        typeof (workOrder as any).taxAmount === "number"[m
[32m+[m[32m          ? (workOrder as any).taxAmount[m
[32m+[m[32m          : subtotal * (taxRate / 100);[m
[32m+[m
[32m+[m[32m      const total =[m
[32m+[m[32m        typeof (workOrder as any).total === "number"[m
[32m+[m[32m          ? (workOrder as any).total[m
[32m+[m[32m          : subtotal + taxAmount;[m
[32m+[m
[32m+[m[32m      // âœ… customer snapshot[m
[32m+[m[32m      const customerSnapshot = {[m
[32m+[m[32m        customerId: customer._id,[m
[32m+[m[32m        firstName: customer.firstName,[m
[32m+[m[32m        lastName: customer.lastName,[m
[32m+[m[32m        phone: customer.phone,[m
[32m+[m[32m        email: customer.email,[m
[32m+[m[32m        address: customer.address,[m
[32m+[m[32m      };[m
 [m
[31m-    let vehicleSnapshot: any = undefined;[m
[31m-    const vehicles = await Vehicle.find({ accountId, customerId: customer._id })[m
[31m-      .sort({ createdAt: 1 })[m
[31m-      .limit(1)[m
[31m-      .lean();[m
[32m+[m[32m      // âœ… vehicle snapshot (kept exactly as your approach)[m
[32m+[m[32m      let vehicleSnapshot: any = undefined;[m
[32m+[m
[32m+[m[32m      const vehicles = await Vehicle.find({ accountId, customerId: customer._id })[m
[32m+[m[32m        .sort({ createdAt: 1 })[m
[32m+[m[32m        .limit(1)[m
[32m+[m[32m        .lean();[m
[32m+[m
[32m+[m[32m      const primaryVehicle = vehicles[0];[m
[32m+[m[32m      if (primaryVehicle) {[m
[32m+[m[32m        vehicleSnapshot = {[m
[32m+[m[32m          vehicleId: primaryVehicle._id.toString(),[m
[32m+[m[32m          year: primaryVehicle.year,[m
[32m+[m[32m          make: primaryVehicle.make,[m
[32m+[m[32m          model: primaryVehicle.model,[m
[32m+[m[32m          vin: primaryVehicle.vin,[m
[32m+[m[32m          licensePlate: primaryVehicle.licensePlate,[m
[32m+[m[32m          color: primaryVehicle.color,[m
[32m+[m[32m          notes: primaryVehicle.notes,[m
[32m+[m[32m        };[m
[32m+[m[32m      }[m
 [m
[31m-    const primaryVehicle = vehicles[0];[m
[31m-    if (primaryVehicle) {[m
[31m-      vehicleSnapshot = {[m
[31m-        vehicleId: primaryVehicle._id.toString(),[m
[31m-        year: primaryVehicle.year,[m
[31m-        make: primaryVehicle.make,[m
[31m-        model: primaryVehicle.model,[m
[31m-        vin: primaryVehicle.vin,[m
[31m-        licensePlate: primaryVehicle.licensePlate,[m
[31m-        color: primaryVehicle.color,[m
[31m-        notes: primaryVehicle.notes,[m
[31m-      };[m
[31m-    }[m
[32m+[m[32m      const invoiceNumber = await getNextInvoiceNumber(accountId);[m
[32m+[m[32m      const issueDate = new Date();[m
 [m
[31m-    const invoiceNumber = await getNextInvoiceNumber(accountId);[m
[31m-    const issueDate = new Date();[m
[32m+[m[32m      let dueDate: Date | undefined;[m
[32m+[m[32m      if (req.body.dueDate) {[m
[32m+[m[32m        const parsed = new Date(req.body.dueDate);[m
[32m+[m[32m        if (!Number.isNaN(parsed.getTime())) dueDate = parsed;[m
[32m+[m[32m      }[m
[32m+[m[32m      if (!dueDate) {[m
[32m+[m[32m        dueDate = new Date(issueDate.getTime());[m
[32m+[m[32m        dueDate.setDate(issueDate.getDate() + 30);[m
[32m+[m[32m      }[m
 [m
[31m-    let dueDate: Date | undefined;[m
[31m-    if (req.body.dueDate) {[m
[31m-      const parsed = new Date(req.body.dueDate);[m
[31m-      if (!Number.isNaN(parsed.getTime())) dueDate = parsed;[m
[31m-    }[m
[31m-    if (!dueDate) {[m
[31m-      dueDate = new Date(issueDate.getTime());[m
[31m-      dueDate.setDate(issueDate.getDate() + 30);[m
[31m-    }[m
[32m+[m[32m      const invoice = await Invoice.create({[m
[32m+[m[32m        accountId,[m
[32m+[m[32m        invoiceNumber,[m
[32m+[m[32m        status: "draft",[m
[32m+[m[32m        workOrderId: workOrder._id,[m
[32m+[m[32m        customerId: customer._id,[m
[32m+[m[32m        customerSnapshot,[m
[32m+[m[32m        vehicleSnapshot,[m
[32m+[m[32m        issueDate,[m
[32m+[m[32m        dueDate,[m
[32m+[m[32m        lineItems: normalizedLineItems,[m
[32m+[m[32m        subtotal,[m
[32m+[m[32m        taxRate,[m
[32m+[m[32m        taxAmount,[m
[32m+[m[32m        total,[m
[32m+[m
[32m+[m[32m        // âœ… payments v1[m
[32m+[m[32m        payments: [],[m
[32m+[m[32m        paidAmount: 0,[m
[32m+[m[32m        balanceDue: total,[m
[32m+[m
[32m+[m[32m        notes: req.body.notes ?? workOrder.notes,[m
[32m+[m[32m      });[m
 [m
[31m-    const invoice = await Invoice.create({[m
[31m-    accountId,[m
[31m-    invoiceNumber,[m
[31m-    status: "draft",[m
[31m-    workOrderId: workOrder._id,[m
[31m-    customerId: customer._id,[m
[31m-    customerSnapshot,[m
[31m-    vehicleSnapshot,[m
[31m-    issueDate,[m
[31m-    dueDate,[m
[31m-    lineItems: normalizedLineItems,[m
[31m-    subtotal,[m
[31m-    taxRate,[m
[31m-    taxAmount,[m
[31m-    total,[m
[31m-[m
[31m-    // âœ… payments v1 (supports partial payments)[m
[31m-    payments: [],[m
[31m-    paidAmount: 0,[m
[31m-    balanceDue: total,[m
[31m-[m
[31m-    notes: req.body.notes ?? workOrder.notes,[m
[31m-  });[m
[31m-[m
[31m-[m
[31m-    workOrder.status = "invoiced";[m
[31m-    workOrder.invoiceId = invoice._id;[m
[31m-    await workOrder.save();[m
[31m-[m
[31m-    return res.status(201).json(invoice);[m
[31m-  } catch (err: any) {[m
[31m-    console.error("[invoice] Create from work order failed:", err);[m
[31m-    if (err?.code === 11000) {[m
[31m-      return res.status(400).json({[m
[31m-        message: "Duplicate key error while creating invoice.",[m
[31m-        details: err.keyValue ?? null,[m
[32m+[m[32m      workOrder.status = "invoiced";[m
[32m+[m[32m      workOrder.invoiceId = invoice._id;[m
[32m+[m[32m      await workOrder.save();[m
[32m+[m
[32m+[m[32m      // âœ… return invoice with computed truth attached[m
[32m+[m[32m      const fin = computeInvoiceFinancials({ total, payments: [] } as any);[m
[32m+[m
[32m+[m[32m      return res.status(201).json({[m
[32m+[m[32m        ...invoice.toObject?.() ?? invoice,[m
[32m+[m[32m        financialStatus: fin.financialStatus,[m
[32m+[m[32m        paidAmount: fin.paidAmount,[m
[32m+[m[32m        balanceDue: fin.balanceDue,[m
[32m+[m[32m      });[m
[32m+[m[32m    } catch (err: any) {[m
[32m+[m[32m      console.error("[invoice] Create from work order failed:", err);[m
[32m+[m[32m      if (err?.code === 11000) {[m
[32m+[m[32m        return res.status(400).json({[m
[32m+[m[32m          message: "Duplicate key error while creating invoice.",[m
[32m+[m[32m          details: err.keyValue ?? null,[m
[32m+[m[32m        });[m
[32m+[m[32m      }[m
[32m+[m[32m      return res.status(500).json({[m
[32m+[m[32m        message: "Failed to create invoice.",[m
[32m+[m[32m        error: err?.message ?? null,[m
       });[m
     }[m
[31m-    return res.status(500).json({[m
[31m-      message: "Failed to create invoice.",[m
[31m-      error: err?.message ?? null,[m
[31m-    });[m
   }[m
[31m-});[m
[32m+[m[32m);[m
 [m
 /**[m
  * âœ… 4) Action routes (still specific, but include :id)[m
[36m@@ -470,7 +564,7 @@[m [mrouter.post("/from-work-order/:workOrderId", async (req: Request, res: Response)[m
  */[m
 [m
 // POST /api/invoices/:id/send[m
[31m-router.post("/:id/send", async (req, res, next) => {[m
[32m+[m[32mrouter.post("/:id/send", requireInvoiceNotPaid, async (req, res, next) => {[m
   try {[m
     const accountId = req.accountId;[m
     if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[36m@@ -481,19 +575,25 @@[m [mrouter.post("/:id/send", async (req, res, next) => {[m
     const invoice = await Invoice.findOne({ _id: id, accountId });[m
     if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
 [m
[31m-    const from = ((invoice as any).status || "draft").toString().toLowerCase();[m
[31m-    assertValidInvoiceTransition(from as any, "sent");[m
[32m+[m[32m    const from = String((invoice as any).status || "draft").toLowerCase() as any;[m
[32m+[m[32m    assertValidInvoiceTransition(from, "sent");[m
 [m
[32m+[m[32m    const now = new Date();[m
     (invoice as any).status = "sent";[m
[31m-    invoice.sentAt = invoice.sentAt ?? new Date();[m
[31m-    await invoice.save();[m
[32m+[m[32m    (invoice as any).sentAt = (invoice as any).sentAt ?? now;[m
 [m
[32m+[m[32m    await invoice.save();[m
     return res.json({ invoice });[m
   } catch (err) {[m
     next(err);[m
   }[m
 });[m
 [m
[32m+[m
[32m+[m
[32m+[m
[32m+[m
[32m+[m[32m// POST /api/invoices/:id/pay[m
 // POST /api/invoices/:id/pay[m
 router.post("/:id/pay", async (req, res, next) => {[m
   try {[m
[36m@@ -517,17 +617,25 @@[m [mrouter.post("/:id/pay", async (req, res, next) => {[m
     const invoice = await Invoice.findOne({ _id: id, accountId });[m
     if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
 [m
[31m-    const status = String((invoice as any).status || "draft").toLowerCase();[m
[32m+[m[32m    // lifecycle only: draft|sent|void[m
[32m+[m[32m    const lifecycle = String((invoice as any).status || "draft").toLowerCase();[m
[32m+[m[32m    const finStatus = String((invoice as any).financialStatus || "").toLowerCase();[m
 [m
[31m-    // âœ… payments allowed only once sent (recommended)[m
[31m-    if (status === "draft") {[m
[32m+[m[32m    // âœ… payments allowed only once sent[m
[32m+[m[32m    if (lifecycle === "draft") {[m
       return res.status(400).json({ message: "Invoice must be sent before recording payment." });[m
     }[m
[31m-    if (status === "paid" || status === "void") {[m
[31m-      return res.status(400).json({ message: `Cannot record payment when invoice is ${status}.` });[m
[32m+[m[32m    if (lifecycle === "void") {[m
[32m+[m[32m      return res.status(400).json({ message: "Cannot record payment when invoice is void." });[m
[32m+[m[32m    }[m
[32m+[m[32m    // block if already fully paid (financial truth)[m
[32m+[m[32m    if (finStatus === "paid" || Number((invoice as any).balanceDue ?? 0) === 0) {[m
[32m+[m[32m      return res[m
[32m+[m[32m        .status(400)[m
[32m+[m[32m        .json({ message: "Invoice is fully paid. No further payments can be recorded." });[m
     }[m
 [m
[31m-    // append payment[m
[32m+[m[32m    // âœ… append payment[m
     const payment = {[m
       method,[m
       reference: (reference || "").trim(),[m
[36m@@ -535,49 +643,37 @@[m [mrouter.post("/:id/pay", async (req, res, next) => {[m
       paidAt: new Date(),[m
     };[m
 [m
[31m-    (invoice as any).payments = Array.isArray((invoice as any).payments) ? (invoice as any).payments : [];[m
[32m+[m[32m    (invoice as any).payments = Array.isArray((invoice as any).payments)[m
[32m+[m[32m      ? (invoice as any).payments[m
[32m+[m[32m      : [];[m
     (invoice as any).payments.push(payment);[m
 [m
[31m-    // recompute paidAmount + balanceDue[m
[31m-    const total = Number((invoice as any).total ?? 0);[m
[31m-    const paidAmount = (invoice as any).payments.reduce([m
[31m-      (sum: number, p: any) => sum + Number(p.amount || 0),[m
[31m-      0[m
[31m-    );[m
[31m-[m
[31m-    const balanceDue = Math.max(0, total - paidAmount);[m
[31m-[m
[31m-    (invoice as any).paidAmount = paidAmount;[m
[31m-    (invoice as any).balanceDue = balanceDue;[m
[31m-[m
[31m-    // if fully paid â†’ flip lifecycle[m
[31m-    if (balanceDue === 0) {[m
[31m-      (invoice as any).status = "paid";[m
[31m-      (invoice as any).paidAt = (invoice as any).paidAt ?? new Date(); // first full payment time[m
[31m-    } else {[m
[31m-      // remain sent[m
[31m-      (invoice as any).status = "sent";[m
[31m-    }[m
[32m+[m[32m    // âœ… canonical money + authoritative financial truth[m
[32m+[m[32m    // IMPORTANT: this must NOT set invoice.status = "paid"[m
[32m+[m[32m    applyInvoiceFinancials(invoice as any);[m
 [m
     await invoice.save();[m
 [m
[31m-    // If fully closed, sync WorkOrder.closedAt (same as your status route does)[m
[31m-    if ((invoice as any).status === "paid") {[m
[32m+[m[32m    // âœ… if fully paid, also close the WorkOrder (financial truth)[m
[32m+[m[32m    const finNow = computeInvoiceFinancials(invoice as any);[m
[32m+[m[32m    if (finNow.financialStatus === "paid" || Number((invoice as any).balanceDue ?? 0) === 0) {[m
       await WorkOrder.updateOne([m
         { _id: (invoice as any).workOrderId, accountId },[m
         { $set: { closedAt: new Date() } }[m
       );[m
     }[m
 [m
[31m-    return res.json({ invoice });[m
[32m+[m[32m    // âœ… return canonical view for frontend[m
[32m+[m[32m    return res.json({ ...invoice.toObject(), ...finNow });[m
   } catch (err) {[m
     next(err);[m
   }[m
 });[m
 [m
 [m
[32m+[m
 // POST /api/invoices/:id/void[m
[31m-router.post("/:id/void", async (req, res, next) => {[m
[32m+[m[32mrouter.post("/:id/void", requireInvoiceNotPaid, async (req, res, next) => {[m
   try {[m
     const accountId = req.accountId;[m
     if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[36m@@ -593,20 +689,37 @@[m [mrouter.post("/:id/void", async (req, res, next) => {[m
     const invoice = await Invoice.findOne({ _id: id, accountId });[m
     if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
 [m
[31m-    const from = ((invoice as any).status || "draft").toString().toLowerCase();[m
[31m-    assertValidInvoiceTransition(from as any, "void");[m
[32m+[m[32m    // âœ… keep cached paidAmount/balanceDue aligned before checks[m
[32m+[m[32m    applyInvoiceFinancials(invoice as any);[m
 [m
[32m+[m[32m    const from = String((invoice as any).status || "draft").toLowerCase() as any;[m
[32m+[m[32m    assertValidInvoiceTransition(from, "void");[m
[32m+[m
[32m+[m[32m    const now = new Date();[m
     (invoice as any).status = "void";[m
[31m-    (invoice as any).voidedAt = (invoice as any).voidedAt ?? new Date();[m
[32m+[m[32m    (invoice as any).voidedAt = (invoice as any).voidedAt ?? now;[m
     (invoice as any).voidReason = reason.trim();[m
 [m
[32m+[m[32m    // âœ… keep cached money fields aligned (safe even when voiding)[m
[32m+[m[32m    applyInvoiceFinancials(invoice as any);[m
[32m+[m
     await invoice.save();[m
[31m-    return res.json({ invoice });[m
[32m+[m
[32m+[m[32m    // âœ… Keep "Archive = closed financial record" consistent[m
[32m+[m[32m    await WorkOrder.updateOne([m
[32m+[m[32m      { _id: (invoice as any).workOrderId, accountId },[m
[32m+[m[32m      { $set: { closedAt: now } }[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    const fin = computeInvoiceFinancials(invoice as any);[m
[32m+[m[32m    return res.json({ ...invoice.toObject(), ...fin });[m
   } catch (err) {[m
     next(err);[m
   }[m
 });[m
 [m
[32m+[m
[32m+[m
 // POST /api/invoices/:id/email[m
 router.post("/:id/email", async (req, res) => {[m
   try {[m
[36m@@ -619,6 +732,9 @@[m [mrouter.post("/:id/email", async (req, res) => {[m
     const invoice = await Invoice.findOne({ _id: id, accountId });[m
     if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
 [m
[32m+[m[32m    // âœ… keep cached paidAmount/balanceDue aligned (safe, no behavior change)[m
[32m+[m[32m    applyInvoiceFinancials(invoice as any);[m
[32m+[m
     let customer: any = null;[m
     const custId: any = (invoice as any).customerId;[m
     if (custId && Types.ObjectId.isValid(String(custId))) {[m
[36m@@ -666,18 +782,27 @@[m [mrouter.post("/:id/email", async (req, res) => {[m
         lastError: "",[m
       };[m
 [m
[31m-      if (((invoice as any).status || "draft") === "draft") {[m
[32m+[m[32m      // âœ… email implies "sent" (keep your existing behavior)[m
[32m+[m[32m      if (String((invoice as any).status || "draft").toLowerCase() === "draft") {[m
         (invoice as any).status = "sent";[m
         (invoice as any).sentAt = (invoice as any).sentAt ?? new Date();[m
       }[m
 [m
[32m+[m[32m      // âœ… re-apply financials in case total/payments changed elsewhere before save[m
[32m+[m[32m      applyInvoiceFinancials(invoice as any);[m
[32m+[m
       await invoice.save();[m
 [m
[32m+[m[32m      const fin = computeInvoiceFinancials(invoice as any);[m
[32m+[m
       return res.json({[m
         ok: true,[m
         message: "Invoice emailed.",[m
         email: (invoice as any).email,[m
         status: (invoice as any).status,[m
[32m+[m[32m        financialStatus: fin.financialStatus,[m
[32m+[m[32m        paidAmount: fin.paidAmount,[m
[32m+[m[32m        balanceDue: fin.balanceDue,[m
       });[m
     } catch (err: any) {[m
       (invoice as any).email = {[m
[36m@@ -701,15 +826,17 @@[m [mrouter.post("/:id/email", async (req, res) => {[m
   }[m
 });[m
 [m
[32m+[m
 /**[m
  * âœ… 5) Document routes[m
  */[m
 [m
 // invoices.route.ts (or wherever your invoice routes are)[m
 [m
[32m+[m[32m// GET /api/invoices/:id/pdf[m
 router.get("/:id/pdf", async (req, res, next) => {[m
   try {[m
[31m-    const accountId = req.accountId; // if youâ€™re using account scoping middleware[m
[32m+[m[32m    const accountId = req.accountId;[m
     const { id } = req.params;[m
 [m
     // 1) Fetch invoice (scoped)[m
[36m@@ -719,9 +846,15 @@[m [mrouter.get("/:id/pdf", async (req, res, next) => {[m
     const customer = await Customer.findById(invoice.customerId).lean();[m
     if (!customer) return res.status(404).json({ message: "Customer not found" });[m
 [m
[32m+[m[32m    // âœ… Attach canonical financial truth for PDF rendering[m
[32m+[m[32m    const fin = computeInvoiceFinancials(invoice as any);[m
[32m+[m[32m    const invoiceForPdf = { ...invoice, ...fin };[m
[32m+[m
     // 2) Generate PDF buffer (reuse your existing PDF builder)[m
[31m-    // IMPORTANT: replace this with YOUR actual function name:[m
[31m-    const pdfBuffer = await buildInvoicePdfBuffer({ invoice, customer });[m
[32m+[m[32m    const pdfBuffer = await buildInvoicePdfBuffer({[m
[32m+[m[32m      invoice: invoiceForPdf,[m
[32m+[m[32m      customer,[m
[32m+[m[32m    });[m
 [m
     // 3) Stream PDF to browser[m
     res.setHeader("Content-Type", "application/pdf");[m
[36m@@ -737,141 +870,192 @@[m [mrouter.get("/:id/pdf", async (req, res, next) => {[m
 });[m
 [m
 [m
[32m+[m
 /**[m
  * âœ… 6) Generic mutation routes (draft-only edit)[m
  */[m
 [m
 // PATCH /api/invoices/:id[m
[31m-router.patch("/:id", async (req: Request, res: Response, next: NextFunction) => {[m
[31m-  try {[m
[31m-    const accountId = req.accountId;[m
[31m-    if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m[32mrouter.patch([m
[32m+[m[32m  "/:id",[m
[32m+[m[32m  requireInvoiceEditable,[m
[32m+[m[32m  async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const accountId = req.accountId;[m
[32m+[m[32m      if (!accountId)[m
[32m+[m[32m        return res.status(400).json({ message: "Missing accountId" });[m
 [m
[31m-    const { id } = req.params;[m
[31m-    if (!Types.ObjectId.isValid(id)) return res.status(400).json({ message: "Invalid invoice id" });[m
[32m+[m[32m      const { id } = req.params;[m
[32m+[m[32m      if (!Types.ObjectId.isValid(id))[m
[32m+[m[32m        return res.status(400).json({ message: "Invalid invoice id" });[m
 [m
[31m-    const invoice = await Invoice.findOne({ _id: id, accountId });[m
[31m-    if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
[32m+[m[32m      const invoice = await Invoice.findOne({ _id: id, accountId });[m
[32m+[m[32m      if (!invoice)[m
[32m+[m[32m        return res.status(404).json({ message: "Invoice not found" });[m
 [m
[31m-    assertCanEditInvoice(((invoice as any).status || "draft").toString().toLowerCase() as any);[m
[32m+[m[32m      const { issueDate, dueDate, notes, taxRate, lineItems } = req.body ?? {};[m
 [m
[31m-    const { issueDate, dueDate, notes, taxRate, lineItems } = req.body ?? {};[m
[32m+[m[32m      if (typeof issueDate !== "undefined")[m
[32m+[m[32m        (invoice as any).issueDate = new Date(issueDate);[m
 [m
[31m-    if (typeof issueDate !== "undefined") (invoice as any).issueDate = new Date(issueDate);[m
[31m-    if (typeof dueDate !== "undefined") (invoice as any).dueDate = dueDate ? new Date(dueDate) : undefined;[m
[31m-    if (typeof notes !== "undefined") (invoice as any).notes = String(notes);[m
[32m+[m[32m      if (typeof dueDate !== "undefined")[m
[32m+[m[32m        (invoice as any).dueDate = dueDate ? new Date(dueDate) : undefined;[m
 [m
[31m-    if (typeof taxRate !== "undefined") {[m
[31m-      const n = Number(taxRate);[m
[31m-      if (Number.isNaN(n) || n < 0) return res.status(400).json({ message: "taxRate must be >= 0" });[m
[31m-      (invoice as any).taxRate = n;[m
[31m-    }[m
[32m+[m[32m      if (typeof notes !== "undefined")[m
[32m+[m[32m        (invoice as any).notes = String(notes);[m
 [m
[31m-    if (typeof lineItems !== "undefined") {[m
[31m-      if (!Array.isArray(lineItems)) return res.status(400).json({ message: "lineItems must be an array" });[m
[31m-      (invoice as any).lineItems = lineItems;[m
[31m-    }[m
[32m+[m[32m      if (typeof taxRate !== "undefined") {[m
[32m+[m[32m        const n = Number(taxRate);[m
[32m+[m[32m        if (Number.isNaN(n) || n < 0)[m
[32m+[m[32m          return res.status(400).json({ message: "taxRate must be >= 0" });[m
[32m+[m[32m        (invoice as any).taxRate = n;[m
[32m+[m[32m      }[m
 [m
[31m-    const items = ((invoice as any).lineItems ?? []) as Array<{ quantity?: number; unitPrice?: number }>;[m
[31m-    const subtotal = items.reduce((sum, it) => sum + Number(it.quantity ?? 0) * Number(it.unitPrice ?? 0), 0);[m
[31m-    const rate = Number((invoice as any).taxRate ?? 0);[m
[31m-    const taxAmount = subtotal * rate;[m
[31m-    const total = subtotal + taxAmount;[m
[32m+[m[32m      if (typeof lineItems !== "undefined") {[m
[32m+[m[32m        if (!Array.isArray(lineItems))[m
[32m+[m[32m          return res.status(400).json({ message: "lineItems must be an array" });[m
[32m+[m[32m        (invoice as any).lineItems = lineItems;[m
[32m+[m[32m      }[m
 [m
[31m-    (invoice as any).subtotal = Math.max(0, subtotal);[m
[31m-    (invoice as any).taxAmount = Math.max(0, taxAmount);[m
[31m-    (invoice as any).total = Math.max(0, total);[m
[32m+[m[32m      // recompute totals[m
[32m+[m[32m      const items = ((invoice as any).lineItems ?? []) as Array<{[m
[32m+[m[32m        quantity?: number;[m
[32m+[m[32m        unitPrice?: number;[m
[32m+[m[32m      }>;[m
 [m
[31m-    await invoice.save();[m
[31m-    return res.json(invoice);[m
[31m-  } catch (err) {[m
[31m-    next(err);[m
[32m+[m[32m      const subtotal = items.reduce([m
[32m+[m[32m        (sum, it) => sum + Number(it.quantity ?? 0) * Number(it.unitPrice ?? 0),[m
[32m+[m[32m        0[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m      const rate = Number((invoice as any).taxRate ?? 0);[m
[32m+[m[32m      const taxAmount = subtotal * rate;[m
[32m+[m[32m      const total = subtotal + taxAmount;[m
[32m+[m
[32m+[m[32m      (invoice as any).subtotal = Math.max(0, subtotal);[m
[32m+[m[32m      (invoice as any).taxAmount = Math.max(0, taxAmount);[m
[32m+[m[32m      (invoice as any).total = Math.max(0, total);[m
[32m+[m
[32m+[m[32m      // âœ… canonical financial truth after total changes[m
[32m+[m[32m      applyInvoiceFinancials(invoice as any);[m
[32m+[m
[32m+[m[32m      await invoice.save();[m
[32m+[m
[32m+[m[32m      const fin = computeInvoiceFinancials(invoice as any);[m
[32m+[m[32m      return res.json({ ...invoice.toObject(), ...fin });[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m      next(err);[m
[32m+[m[32m    }[m
   }[m
[31m-});[m
[32m+[m[32m);[m
[32m+[m
[32m+[m
 [m
 /**[m
  * âœ… 7) Lifecycle status route[m
  */[m
 [m
 // PATCH /api/invoices/:id/status[m
[31m-router.patch("/:id/status", async (req: Request, res: Response, next: NextFunction) => {[m
[31m-  try {[m
[31m-    const accountId = req.accountId;[m
[31m-    if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m[32mrouter.patch([m
[32m+[m[32m  "/:id/status",[m
[32m+[m[32m  async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const accountId = req.accountId;[m
[32m+[m[32m      if (!accountId)[m
[32m+[m[32m        return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m
[32m+[m[32m      const { id } = req.params;[m
[32m+[m[32m      if (!Types.ObjectId.isValid(id))[m
[32m+[m[32m        return res.status(400).json({ message: "Invalid invoice id" });[m
[32m+[m
[32m+[m[32m      const nextStatus = (req.body?.status || "").trim().toLowerCase();[m
[32m+[m[32m      if (!nextStatus)[m
[32m+[m[32m        return res.status(400).json({ message: "status is required" });[m
[32m+[m
[32m+[m[32m      if (nextStatus === "draft") {[m
[32m+[m[32m        return res[m
[32m+[m[32m          .status(400)[m
[32m+[m[32m          .json({ message: "Reverting invoices to draft is not supported in V1." });[m
[32m+[m[32m      }[m
 [m
[31m-    const { id } = req.params;[m
[31m-    if (!Types.ObjectId.isValid(id)) return res.status(400).json({ message: "Invalid invoice id" });[m
[32m+[m[32m      const allowed = ["sent", "paid", "void"] as const;[m
[32m+[m[32m      if (!allowed.includes(nextStatus as any)) {[m
[32m+[m[32m        return res[m
[32m+[m[32m          .status(400)[m
[32m+[m[32m          .json({ message: `Invalid status. Allowed: ${allowed.join(", ")}` });[m
[32m+[m[32m      }[m
 [m
[31m-    const nextStatus = (req.body?.status || "").trim().toLowerCase();[m
[31m-    if (!nextStatus) return res.status(400).json({ message: "status is required" });[m
[32m+[m[32m      const invoice = await Invoice.findOne({ _id: id, accountId });[m
[32m+[m[32m      if (!invoice)[m
[32m+[m[32m        return res.status(404).json({ message: "Invoice not found" });[m
 [m
[31m-    const allowed = ["draft", "sent", "paid", "void"] as const;[m
[31m-    if (!allowed.includes(nextStatus as any)) {[m
[31m-      return res.status(400).json({ message: `Invalid status. Allowed: ${allowed.join(", ")}` });[m
[31m-    }[m
[32m+[m[32m      const currentStatus = ((invoice as any).status || "draft")[m
[32m+[m[32m        .toString()[m
[32m+[m[32m        .toLowerCase();[m
 [m
[31m-    const invoice = await Invoice.findOne({ _id: id, accountId });[m
[31m-    if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
[32m+[m[32m      // âœ… Canonical financial truth BEFORE allowing a manual "paid" flip[m
[32m+[m[32m      const finNow = computeInvoiceFinancials(invoice as any);[m
 [m
[31m-    const currentStatus = ((invoice as any).status || "draft").toString().toLowerCase();[m
[31m-    assertValidInvoiceTransition(currentStatus as any, nextStatus as any);[m
[32m+[m[32m      // If there is still money due, block setting status=paid here.[m
[32m+[m[32m      // Paid status must come from payments (our backend truth).[m
[32m+[m[32m      if (nextStatus === "paid" && finNow.financialStatus !== "paid") {[m
[32m+[m[32m        return res.status(400).json({[m
[32m+[m[32m          message:[m
[32m+[m[32m            "Cannot mark as paid while balance is still due. Record a payment instead.",[m
[32m+[m[32m        });[m
[32m+[m[32m      }[m
 [m
[31m-    const now = new Date();[m
[31m-    (invoice as any).status = nextStatus;[m
[32m+[m[32m      assertValidInvoiceTransition(currentStatus as any, nextStatus as any);[m
 [m
[31m-    if (nextStatus === "sent" && !(invoice as any).sentAt) (invoice as any).sentAt = now;[m
[31m-    if (nextStatus === "paid" && !(invoice as any).paidAt) (invoice as any).paidAt = now;[m
[32m+[m[32m      const now = new Date();[m
[32m+[m[32m      (invoice as any).status = nextStatus;[m
 [m
[31m-    if (nextStatus === "void") {[m
[31m-      if (!(req.body?.reason || "").trim()) return res.status(400).json({ message: "Void reason is required" });[m
[31m-      if (!(invoice as any).voidedAt) (invoice as any).voidedAt = now;[m
[31m-      (invoice as any).voidReason = (req.body.reason || "").trim();[m
[31m-    }[m
[32m+[m[32m      if (nextStatus === "sent" && !(invoice as any).sentAt)[m
[32m+[m[32m        (invoice as any).sentAt = now;[m
 [m
[31m-    await invoice.save();[m
[32m+[m[32m      if (nextStatus === "paid" && !(invoice as any).paidAt)[m
[32m+[m[32m        (invoice as any).paidAt = now;[m
 [m
[31m-    if (nextStatus === "paid" || nextStatus === "void") {[m
[31m-      await WorkOrder.updateOne([m
[31m-        { _id: (invoice as any).workOrderId, accountId },[m
[31m-        { $set: { closedAt: now } }[m
[31m-      );[m
[31m-    } else {[m
[31m-      await WorkOrder.updateOne([m
[31m-        { _id: (invoice as any).workOrderId, accountId },[m
[31m-        { $unset: { closedAt: 1 } }[m
[31m-      );[m
[31m-    }[m
[32m+[m[32m      if (nextStatus === "void") {[m
[32m+[m[32m        if (!(req.body?.reason || "").trim())[m
[32m+[m[32m          return res[m
[32m+[m[32m            .status(400)[m
[32m+[m[32m            .json({ message: "Void reason is required" });[m
 [m
[31m-    res.json(invoice);[m
[31m-  } catch (err) {[m
[31m-    next(err);[m
[32m+[m[32m        if (!(invoice as any).voidedAt) (invoice as any).voidedAt = now;[m
[32m+[m[32m        (invoice as any).voidReason = (req.body.reason || "").trim();[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // âœ… Keep cached money fields aligned (paidAmount/balanceDue) no matter what[m
[32m+[m[32m      applyInvoiceFinancials(invoice as any);[m
[32m+[m
[32m+[m[32m      await invoice.save();[m
[32m+[m
[32m+[m[32m      if (nextStatus === "paid" || nextStatus === "void") {[m
[32m+[m[32m        await WorkOrder.updateOne([m
[32m+[m[32m          { _id: (invoice as any).workOrderId, accountId },[m
[32m+[m[32m          { $set: { closedAt: now } }[m
[32m+[m[32m        );[m
[32m+[m[32m      } else {[m
[32m+[m[32m        await WorkOrder.updateOne([m
[32m+[m[32m          { _id: (invoice as any).workOrderId, accountId },[m
[32m+[m[32m          { $unset: { closedAt: 1 } }[m
[32m+[m[32m        );[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      const fin = computeInvoiceFinancials(invoice as any);[m
[32m+[m[32m      return res.json({ ...invoice.toObject(), ...fin });[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m      next(err);[m
[32m+[m[32m    }[m
   }[m
[31m-});[m
[32m+[m[32m);[m
[32m+[m
 [m
 /**[m
  * âœ… 8) Most generic route LAST[m
  */[m
 [m
[31m-// GET /api/invoices/:id[m
[31m-router.get("/:id", async (req: Request, res: Response, next: NextFunction) => {[m
[31m-  try {[m
[31m-    const accountId = req.accountId;[m
[31m-    if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
 [m
[31m-    const { id } = req.params;[m
[31m-    if (!Types.ObjectId.isValid(id)) return res.status(400).json({ message: "Invalid invoice id" });[m
[31m-[m
[31m-    const invoice = await Invoice.findOne({ _id: id, accountId })[m
[31m-      .populate("customerId", "firstName lastName phone email address vehicles")[m
[31m-      .populate("workOrderId", "status")[m
[31m-      .lean();[m
[31m-[m
[31m-    if (!invoice) return res.status(404).json({ message: "Invoice not found" });[m
[31m-[m
[31m-    res.json(invoice);[m
[31m-  } catch (err) {[m
[31m-    next(err);[m
[31m-  }[m
[31m-});[m
 [m
 export default router;[m
[1mdiff --git a/backend/src/routes/workOrders.route.ts b/backend/src/routes/workOrders.route.ts[m
[1mindex 2685ff5..4236043 100644[m
[1m--- a/backend/src/routes/workOrders.route.ts[m
[1m+++ b/backend/src/routes/workOrders.route.ts[m
[36m@@ -5,6 +5,8 @@[m [mimport { WorkOrder } from '../models/workOrder.model';[m
 import { Customer } from '../models/customer.model';[m
 import { attachAccountId } from '../middleware/account.middleware';[m
 import { applyWorkOrderLifecycle } from "../utils/workOrderLifecycle";[m
[32m+[m[32mimport { computeInvoiceFinancials } from "../utils/invoiceFinancials";[m
[32m+[m
 [m
 const router = Router();[m
 [m
[36m@@ -87,7 +89,7 @@[m [mrouter.get("/", async (req: Request, res: Response, next: NextFunction) => {[m
     };[m
 [m
     const q: any = { accountId };[m
[31m-[m
[32m+[m[41m  [m
     // Optional customer filter[m
     if (customerId && Types.ObjectId.isValid(customerId)) {[m
       q.customerId = new Types.ObjectId(customerId);[m
[36m@@ -98,514 +100,535 @@[m [mrouter.get("/", async (req: Request, res: Response, next: NextFunction) => {[m
       q.status = { $in: ["open", "in_progress", "on_hold"] };[m
       // optional: hide cancelled from active automatically[m
     } else if (view === "financial") {[m
[31m-      // include legacy "invoiced" if you still have data using it[m
       q.status = { $in: ["completed", "invoiced"] };[m
[31m-      // optionally hide closed financial items:[m
[31m-      q.closedAt = { $exists: false };[m
[31m-    } else if (view === "archive") {[m
[32m+[m[32m      // TEMP: do not filter by closedAt until we confirm data shape[m
[32m+[m[32m    }[m
[32m+[m[32m    else if (view === "archive") {[m
       q.closedAt = { $exists: true, $ne: null };[m
     } else {[m
       // all -> no extra filter[m
     }[m
[31m-[m
[32m+[m[41m  [m
     // Sorting[m
     const dir = sortDir === "asc" ? 1 : -1;[m
     const sort: any =[m
       sortBy === "status" ? { status: dir, createdAt: -1 } : { createdAt: dir };[m
[32m+[m[41m    [m
[32m+[m[41m  [m
 [m
[31m-    const workOrders = await WorkOrder.find(q)[m
[31m-      .sort(sort)[m
[31m-      .populate("customerId", "name fullName firstName lastName") // optional[m
[31m-      .populate("invoiceId", "status invoiceNumber sentAt paidAt voidedAt total") // optional[m
[31m-      .lean();[m
[31m-[m
[31m-    // Optional: normalize shape so frontend can use wo.customer and wo.invoice[m
[31m-    const normalized = workOrders.map((wo: any) => ({[m
[31m-      ...wo,[m
[31m-      customer: wo.customerId && typeof wo.customerId === "object" ? wo.customerId : undefined,[m
[31m-      invoice: wo.invoiceId && typeof wo.invoiceId === "object" ? wo.invoiceId : undefined,[m
[31m-    }));[m
[31m-[m
[31m-    res.json(normalized);[m
[31m-  } catch (err) {[m
[31m-    next(err);[m
[31m-  }[m
[31m-});[m
[32m+[m[32mconst workOrders = await WorkOrder.find(q)[m
[32m+[m[32m  .sort(sort)[m
[32m+[m[32m  .populate("customerId", "name fullName firstName lastName address") // optional[m
[32m+[m[32m  .populate([m
[32m+[m[32m    "invoiceId",[m
[32m+[m[32m    "status invoiceNumber sentAt paidAt voidedAt total paidAmount balanceDue payments"[m
[32m+[m[32m  )[m
[32m+[m[32m  .lean();[m
 [m
[32m+[m[32m// Normalize shape + attach authoritative financialStatus (no frontend compute)[m
[32m+[m[32mconst normalized = workOrders.map((wo: any) => {[m
[32m+[m[32m  const customer =[m
[32m+[m[32m    wo.customerId && typeof wo.customerId === "object" ? wo.customerId : undefined;[m
 [m
[32m+[m[32m  const invoiceObj =[m
[32m+[m[32m    wo.invoiceId && typeof wo.invoiceId === "object" ? wo.invoiceId : undefined;[m
 [m
[32m+[m[32m  let invoice = invoiceObj;[m
 [m
[31m-// GET /api/work-orders/:id[m
[31m-router.get("/:id", async (req: Request, res: Response, next: NextFunction) => {[m
[31m-  try {[m
[31m-    const accountId = req.accountId;[m
[31m-    if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m[32m if (invoiceObj) {[m
[32m+[m[32m  const fin = computeInvoiceFinancials({[m
[32m+[m[32m    total: Number(invoiceObj.total ?? 0),[m
[32m+[m[32m    payments: Array.isArray(invoiceObj.payments) ? invoiceObj.payments : [],[m
[32m+[m[32m    paidAmount: Number(invoiceObj.paidAmount ?? 0),[m
[32m+[m[32m    balanceDue: Number(invoiceObj.balanceDue ?? 0),[m
[32m+[m[32m  } as any);[m
 [m
[31m-    const { id } = req.params;[m
[31m-    if (!Types.ObjectId.isValid(id)) return res.status(400).json({ message: "Invalid id" });[m
[32m+[m[32m  invoice = { ...invoiceObj, ...fin };[m
[32m+[m[32m}[m
 [m
[31m-    const wo = await WorkOrder.findOne({ _id: id, accountId })[m
[31m-      .populate("customerId", "name fullName firstName lastName phone email")[m
[31m-      .populate("invoiceId", "status invoiceNumber sentAt paidAt voidedAt lineItems subtotal taxAmount total")[m
[31m-      .lean();[m
 [m
[31m-    if (!wo) return res.status(404).json({ message: "Work order not found" });[m
[32m+[m[32m  return { ...wo, customer, invoice };[m
[32m+[m[32m});[m
 [m
[31m-    res.json({[m
[31m-      ...wo,[m
[31m-      customer: wo.customerId && typeof wo.customerId === "object" ? wo.customerId : undefined,[m
[31m-      invoice: wo.invoiceId && typeof wo.invoiceId === "object" ? wo.invoiceId : undefined,[m
[31m-    });[m
[32m+[m[32m// âœ… IMPORTANT: return normalized (not raw workOrders)[m
[32m+[m[32m return res.json(normalized);[m
   } catch (err) {[m
     next(err);[m
   }[m
 });[m
 [m
[32m+[m[41m  [m
 [m
 [m
 [m
[32m+[m[32m    // GET /api/work-orders/:id[m
[32m+[m[32m    router.get("/:id", async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const accountId = req.accountId;[m
[32m+[m[32m        if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
 [m
[31m-// POST /api/work-orders[m
[31m-router.post("/", async (req: Request, res: Response, next: NextFunction) => {[m
[31m-  try {[m
[31m-    const accountId = req.accountId;[m
[31m-    if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[31m-[m
[31m-    const { customerId, complaint, diagnosis, notes, vehicle } = req.body ?? {};[m
[31m-[m
[31m-    if (!customerId) return res.status(400).json({ message: "customerId is required" });[m
[31m-    if (!complaint || String(complaint).trim() === "") {[m
[31m-      return res.status(400).json({ message: "complaint is required" });[m
[31m-    }[m
[31m-[m
[31m-    // Ensure customer exists + scoped by account (important)[m
[31m-    const customer = await Customer.findOne({ _id: customerId, accountId }).lean();[m
[31m-    if (!customer) return res.status(400).json({ message: "Invalid customerId" });[m
[32m+[m[32m        const { id } = req.params;[m
[32m+[m[32m        if (!Types.ObjectId.isValid(id)) return res.status(400).json({ message: "Invalid id" });[m
 [m
[31m-    // --- ODO DEFAULTING (odometerIn) ---[m
[31m-    const bodyOdoIn = req.body?.odometerIn;[m
[31m-    const bodyOdoLegacy = req.body?.odometer;[m
[32m+[m[32m        const wo = await WorkOrder.findOne({ _id: id, accountId })[m
[32m+[m[32m          .populate("customerId", "name fullName firstName lastName phone email address ")[m
[32m+[m[32m          .populate("invoiceId", "status invoiceNumber sentAt paidAt voidedAt lineItems subtotal taxAmount total")[m
[32m+[m[32m          .lean();[m
 [m
[31m-    let odometerIn: number | undefined = undefined;[m
[31m-[m
[31m-    // 1) If frontend explicitly sent odometerIn, prefer it[m
[31m-    if (bodyOdoIn !== undefined && bodyOdoIn !== null && bodyOdoIn !== "") {[m
[31m-      const n = Number(String(bodyOdoIn).replace(/,/g, "").trim());[m
[31m-      if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[31m-    }[m
[32m+[m[32m        if (!wo) return res.status(404).json({ message: "Work order not found" });[m
 [m
[31m-    // 2) else if legacy odometer was sent, treat as odometerIn[m
[31m-    if (odometerIn === undefined && bodyOdoLegacy !== undefined && bodyOdoLegacy !== null && bodyOdoLegacy !== "") {[m
[31m-      const n = Number(String(bodyOdoLegacy).replace(/,/g, "").trim());[m
[31m-      if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[31m-    }[m
[31m-[m
[31m-    // 3) else try snapshot vehicle.odometer (if you ever add it)[m
[31m-    if (odometerIn === undefined && vehicle?.odometer !== undefined) {[m
[31m-      const n = Number(String(vehicle.odometer).replace(/,/g, "").trim());[m
[31m-      if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[31m-    }[m
[31m-[m
[31m-    // 4) else try customer embedded vehicle match by vehicle.vehicleId[m
[31m-    if (odometerIn === undefined && vehicle?.vehicleId && Array.isArray((customer as any).vehicles)) {[m
[31m-      const vId = String(vehicle.vehicleId);[m
[31m-      const match = (customer as any).vehicles.find((v: any) => String(v?._id) === vId);[m
[31m-      const candidate = match?.odometer ?? match?.lastOdometer ?? match?.mileage; // tolerate different field names[m
[31m-      if (candidate !== undefined && candidate !== null && candidate !== "") {[m
[31m-        const n = Number(String(candidate).replace(/,/g, "").trim());[m
[31m-        if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[32m+[m[32m        res.json({[m
[32m+[m[32m          ...wo,[m
[32m+[m[32m          customer: wo.customerId && typeof wo.customerId === "object" ? wo.customerId : undefined,[m
[32m+[m[32m          invoice: wo.invoiceId && typeof wo.invoiceId === "object" ? wo.invoiceId : undefined,[m
[32m+[m[32m        });[m
[32m+[m[32m      } catch (err) {[m
[32m+[m[32m        next(err);[m
       }[m
[31m-    }[m
[31m-[m
[31m-    const workOrder = new WorkOrder({[m
[31m-      accountId,[m
[31m-      customerId,[m
[31m-      complaint: String(complaint).trim(),[m
[31m-      diagnosis,[m
[31m-      notes,[m
[31m-      vehicle,[m
[31m-      status: "open",[m
[31m-      date: new Date(),[m
[31m-[m
[31m-      // new lifecycle fields (safe even if undefined)[m
[31m-      odometerIn,[m
[31m-      // keep legacy field aligned too[m
[31m-      odometer: odometerIn,[m
[31m-    });[m
[31m-[m
[31m-    // lifecycle normalization (status + odometers + timestamps)[m
[31m-    applyWorkOrderLifecycle(workOrder, {[m
[31m-      status: workOrder.status,[m
[31m-      odometer: workOrder.odometer,[m
[31m-      odometerIn: workOrder.odometerIn,[m
[31m-      odometerOut: req.body?.odometerOut,[m
     });[m
 [m
[31m-    await workOrder.save();[m
[31m-    res.status(201).json(workOrder);[m
[31m-  } catch (err) {[m
[31m-    next(err);[m
[31m-  }[m
[31m-});[m
 [m
 [m
 [m
[31m-// PUT /api/work-orders/:id[m
[31m-router.put([m
[31m-  "/:id",[m
[31m-  async (req: Request, res: Response, next: NextFunction) => {[m
[31m-    try {[m
[31m-      const accountId = req.accountId;[m
[31m-      if (!accountId) {[m
[31m-        return res.status(400).json({ message: "Missing accountId" });[m
[31m-      }[m
 [m
[31m-      const { id } = req.params;[m
[31m-      const updates = req.body;[m
[32m+[m[32m    // POST /api/work-orders[m
[32m+[m[32m    router.post("/", async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const accountId = req.accountId;[m
[32m+[m[32m        if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
 [m
[31m-      // 1) Load the existing work order scoped by account[m
[31m-      const workOrder = await WorkOrder.findOne({ _id: id, accountId });[m
[31m-      if (!workOrder) {[m
[31m-        return res.status(404).json({ message: "Work order not found" });[m
[31m-      }[m
[31m-[m
[31m-      // 2) Apply scalar field updates if provided[m
[31m-      if (typeof updates.complaint !== "undefined") {[m
[31m-        workOrder.complaint = updates.complaint;[m
[31m-      }[m
[31m-      if (typeof updates.diagnosis !== "undefined") {[m
[31m-        workOrder.diagnosis = updates.diagnosis;[m
[31m-      }[m
[31m-      if (typeof updates.notes !== "undefined") {[m
[31m-        workOrder.notes = updates.notes;[m
[31m-      }[m
[31m-      if (typeof updates.odometer !== "undefined") {[m
[31m-        workOrder.odometer = updates.odometer;[m
[31m-      }[m
[31m-      if (typeof updates.status !== "undefined") {[m
[31m-        workOrder.status = updates.status;[m
[31m-      }[m
[32m+[m[32m        const { customerId, complaint, diagnosis, notes, vehicle } = req.body ?? {};[m
 [m
[31m-      // 3) Vehicle snapshot (optional)[m
[31m-      if (typeof updates.vehicle !== "undefined" && updates.vehicle) {[m
[31m-        const v = updates.vehicle;[m
[31m-        workOrder.vehicle = {[m
[31m-          vehicleId: v.vehicleId,[m
[31m-          year: v.year,[m
[31m-          make: v.make,[m
[31m-          model: v.model,[m
[31m-          vin: v.vin,[m
[31m-          licensePlate: v.licensePlate,[m
[31m-          color: v.color,[m
[31m-          notes: v.notes,[m
[31m-        };[m
[31m-      }[m
[32m+[m[32m        if (!customerId) return res.status(400).json({ message: "customerId is required" });[m
[32m+[m[32m        if (!complaint || String(complaint).trim() === "") {[m
[32m+[m[32m          return res.status(400).json({ message: "complaint is required" });[m
[32m+[m[32m        }[m
 [m
[31m-      // 4) Line items + taxRate from the frontend[m
[31m-      if (Array.isArray(updates.lineItems)) {[m
[31m-        workOrder.lineItems = updates.lineItems;[m
[31m-      }[m
[31m-      if (typeof updates.taxRate !== "undefined") {[m
[31m-        workOrder.taxRate = updates.taxRate;[m
[31m-      }[m
[32m+[m[32m        // Ensure customer exists + scoped by account (important)[m
[32m+[m[32m        const customer = await Customer.findOne({ _id: customerId, accountId }).lean();[m
[32m+[m[32m        if (!customer) return res.status(400).json({ message: "Invalid customerId" });[m
 [m
[31m-      // 5) If lineItems or taxRate changed, recalc money fields[m
[31m-      if ([m
[31m-        Array.isArray(updates.lineItems) ||[m
[31m-        typeof updates.taxRate !== "undefined"[m
[31m-      ) {[m
[31m-        const items = workOrder.lineItems || [];[m
[31m-        const taxRate = workOrder.taxRate ?? 13;[m
[31m-[m
[31m-        const subtotal = items.reduce([m
[31m-          (sum: number, item: any) => sum + (item.lineTotal || 0),[m
[31m-          0[m
[31m-        );[m
[31m-        const taxAmount = subtotal * (taxRate / 100);[m
[31m-        const total = subtotal + taxAmount;[m
[31m-[m
[31m-        (workOrder as any).subtotal = subtotal;[m
[31m-        (workOrder as any).taxAmount = taxAmount;[m
[31m-        (workOrder as any).total = total;[m
[31m-      }[m
[32m+[m[32m        // --- ODO DEFAULTING (odometerIn) ---[m
[32m+[m[32m        const bodyOdoIn = req.body?.odometerIn;[m
[32m+[m[32m        const bodyOdoLegacy = req.body?.odometer;[m
 [m
[31m-      // 6) Save and return the full work order[m
[31m-      const saved = await workOrder.save();[m
[31m-      res.json(saved);[m
[31m-    } catch (err) {[m
[31m-      next(err);[m
[31m-    }[m
[31m-  }[m
[31m-);[m
[32m+[m[32m        let odometerIn: number | undefined = undefined;[m
 [m
[32m+[m[32m        // 1) If frontend explicitly sent odometerIn, prefer it[m
[32m+[m[32m        if (bodyOdoIn !== undefined && bodyOdoIn !== null && bodyOdoIn !== "") {[m
[32m+[m[32m          const n = Number(String(bodyOdoIn).replace(/,/g, "").trim());[m
[32m+[m[32m          if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[32m+[m[32m        }[m
 [m
[31m-/**[m
[31m- * PATCH /api/work-orders/:id[m
[31m- * Safe patch: whitelist + run hooks via save()[m
[31m- */[m
[31m-// PATCH /api/work-orders/:id[m
[31m-// Safe patch: whitelist + lifecycle + totals recalculation + runs schema hooks via save()[m
[31m-router.patch("/:id", async (req: Request, res: Response, next: NextFunction) => {[m
[31m-  try {[m
[31m-    const accountId = req.accountId;[m
[31m-    if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m[32m        // 2) else if legacy odometer was sent, treat as odometerIn[m
[32m+[m[32m        if (odometerIn === undefined && bodyOdoLegacy !== undefined && bodyOdoLegacy !== null && bodyOdoLegacy !== "") {[m
[32m+[m[32m          const n = Number(String(bodyOdoLegacy).replace(/,/g, "").trim());[m
[32m+[m[32m          if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[32m+[m[32m        }[m
 [m
[31m-    const { id } = req.params;[m
[31m-    if (!Types.ObjectId.isValid(id)) {[m
[31m-      return res.status(400).json({ message: "Invalid work order id" });[m
[31m-    }[m
[32m+[m[32m        // 3) else try snapshot vehicle.odometer (if you ever add it)[m
[32m+[m[32m        if (odometerIn === undefined && vehicle?.odometer !== undefined) {[m
[32m+[m[32m          const n = Number(String(vehicle.odometer).replace(/,/g, "").trim());[m
[32m+[m[32m          if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[32m+[m[32m        }[m
 [m
[31m-    const workOrder = await WorkOrder.findOne({ _id: id, accountId });[m
[31m-    if (!workOrder) return res.status(404).json({ message: "Work order not found" });[m
[32m+[m[32m        // 4) else try customer embedded vehicle match by vehicle.vehicleId[m
[32m+[m[32m        if (odometerIn === undefined && vehicle?.vehicleId && Array.isArray((customer as any).vehicles)) {[m
[32m+[m[32m          const vId = String(vehicle.vehicleId);[m
[32m+[m[32m          const match = (customer as any).vehicles.find((v: any) => String(v?._id) === vId);[m
[32m+[m[32m          const candidate = match?.odometer ?? match?.lastOdometer ?? match?.mileage; // tolerate different field names[m
[32m+[m[32m          if (candidate !== undefined && candidate !== null && candidate !== "") {[m
[32m+[m[32m            const n = Number(String(candidate).replace(/,/g, "").trim());[m
[32m+[m[32m            if (Number.isFinite(n) && n >= 0) odometerIn = Math.round(n);[m
[32m+[m[32m          }[m
[32m+[m[32m        }[m
 [m
[31m-    const patch: any = req.body ?? {}; // âœ… keep this as any so TS doesn't block fields[m
[32m+[m[32m        const workOrder = new WorkOrder({[m
[32m+[m[32m          accountId,[m
[32m+[m[32m          customerId,[m
[32m+[m[32m          complaint: String(complaint).trim(),[m
[32m+[m[32m          diagnosis,[m
[32m+[m[32m          notes,[m
[32m+[m[32m          vehicle,[m
[32m+[m[32m          status: "open",[m
[32m+[m[32m          date: new Date(),[m
[32m+[m
[32m+[m[32m          // new lifecycle fields (safe even if undefined)[m
[32m+[m[32m          odometerIn,[m
[32m+[m[32m          // keep legacy field aligned too[m
[32m+[m[32m          odometer: odometerIn,[m
[32m+[m[32m        });[m
 [m
[31m-    // capture status BEFORE changes (for transition detection)[m
[31m-    const prevStatus = workOrder.status;[m
[32m+[m[32m        // lifecycle normalization (status + odometers + timestamps)[m
[32m+[m[32m        applyWorkOrderLifecycle(workOrder, {[m
[32m+[m[32m          status: workOrder.status,[m
[32m+[m[32m          odometer: workOrder.odometer,[m
[32m+[m[32m          odometerIn: workOrder.odometerIn,[m
[32m+[m[32m          odometerOut: req.body?.odometerOut,[m
[32m+[m[32m        });[m
 [m
[31m-    // ----------------------------[m
[31m-    // 1) Simple text fields[m
[31m-    // ----------------------------[m
[31m-    if (patch.complaint !== undefined) workOrder.complaint = String(patch.complaint ?? "");[m
[31m-    if (patch.diagnosis !== undefined) workOrder.diagnosis = String(patch.diagnosis ?? "");[m
[31m-    if (patch.notes !== undefined) workOrder.notes = String(patch.notes ?? "");[m
[32m+[m[32m        await workOrder.save();[m
[32m+[m[32m        res.status(201).json(workOrder);[m
[32m+[m[32m      } catch (err) {[m
[32m+[m[32m        next(err);[m
[32m+[m[32m      }[m
[32m+[m[32m    });[m
 [m
[31m-    // ----------------------------[m
[31m-    // 2) Vehicle snapshot[m
[31m-    // ----------------------------[m
[31m-    if (patch.vehicle !== undefined) {[m
[31m-      workOrder.vehicle = patch.vehicle;[m
[31m-    }[m
 [m
[31m-    // ----------------------------[m
[31m-    // 3) Line items + tax rate + totals (optional but nice)[m
[31m-    // ----------------------------[m
[31m-    const lineItemsChanged = patch.lineItems !== undefined;[m
[31m-    const taxRateChanged = patch.taxRate !== undefined;[m
 [m
[31m-    if (lineItemsChanged) {[m
[31m-      if (!Array.isArray(patch.lineItems)) {[m
[31m-        return res.status(400).json({ message: "lineItems must be an array" });[m
[32m+[m[32m    // PUT /api/work-orders/:id[m
[32m+[m[32m    router.put([m
[32m+[m[32m      "/:id",[m
[32m+[m[32m      async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m        try {[m
[32m+[m[32m          const accountId = req.accountId;[m
[32m+[m[32m          if (!accountId) {[m
[32m+[m[32m            return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          const { id } = req.params;[m
[32m+[m[32m          const updates = req.body;[m
[32m+[m
[32m+[m[32m          // 1) Load the existing work order scoped by account[m
[32m+[m[32m          const workOrder = await WorkOrder.findOne({ _id: id, accountId });[m
[32m+[m[32m          if (!workOrder) {[m
[32m+[m[32m            return res.status(404).json({ message: "Work order not found" });[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          // 2) Apply scalar field updates if provided[m
[32m+[m[32m          if (typeof updates.complaint !== "undefined") {[m
[32m+[m[32m            workOrder.complaint = updates.complaint;[m
[32m+[m[32m          }[m
[32m+[m[32m          if (typeof updates.diagnosis !== "undefined") {[m
[32m+[m[32m            workOrder.diagnosis = updates.diagnosis;[m
[32m+[m[32m          }[m
[32m+[m[32m          if (typeof updates.notes !== "undefined") {[m
[32m+[m[32m            workOrder.notes = updates.notes;[m
[32m+[m[32m          }[m
[32m+[m[32m          if (typeof updates.odometer !== "undefined") {[m
[32m+[m[32m            workOrder.odometer = updates.odometer;[m
[32m+[m[32m          }[m
[32m+[m[32m          if (typeof updates.status !== "undefined") {[m
[32m+[m[32m            workOrder.status = updates.status;[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          // 3) Vehicle snapshot (optional)[m
[32m+[m[32m          if (typeof updates.vehicle !== "undefined" && updates.vehicle) {[m
[32m+[m[32m            const v = updates.vehicle;[m
[32m+[m[32m            workOrder.vehicle = {[m
[32m+[m[32m              vehicleId: v.vehicleId,[m
[32m+[m[32m              year: v.year,[m
[32m+[m[32m              make: v.make,[m
[32m+[m[32m              model: v.model,[m
[32m+[m[32m              vin: v.vin,[m
[32m+[m[32m              licensePlate: v.licensePlate,[m
[32m+[m[32m              color: v.color,[m
[32m+[m[32m              notes: v.notes,[m
[32m+[m[32m            };[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          // 4) Line items + taxRate from the frontend[m
[32m+[m[32m          if (Array.isArray(updates.lineItems)) {[m
[32m+[m[32m            workOrder.lineItems = updates.lineItems;[m
[32m+[m[32m          }[m
[32m+[m[32m          if (typeof updates.taxRate !== "undefined") {[m
[32m+[m[32m            workOrder.taxRate = updates.taxRate;[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          // 5) If lineItems or taxRate changed, recalc money fields[m
[32m+[m[32m          if ([m
[32m+[m[32m            Array.isArray(updates.lineItems) ||[m
[32m+[m[32m            typeof updates.taxRate !== "undefined"[m
[32m+[m[32m          ) {[m
[32m+[m[32m            const items = workOrder.lineItems || [];[m
[32m+[m[32m            const taxRate = workOrder.taxRate ?? 13;[m
[32m+[m
[32m+[m[32m            const subtotal = items.reduce([m
[32m+[m[32m              (sum: number, item: any) => sum + (item.lineTotal || 0),[m
[32m+[m[32m              0[m
[32m+[m[32m            );[m
[32m+[m[32m            const taxAmount = subtotal * (taxRate / 100);[m
[32m+[m[32m            const total = subtotal + taxAmount;[m
[32m+[m
[32m+[m[32m            (workOrder as any).subtotal = subtotal;[m
[32m+[m[32m            (workOrder as any).taxAmount = taxAmount;[m
[32m+[m[32m            (workOrder as any).total = total;[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          // 6) Save and return the full work order[m
[32m+[m[32m          const saved = await workOrder.save();[m
[32m+[m[32m          res.json(saved);[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m          next(err);[m
[32m+[m[32m        }[m
       }[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m
[32m+[m[32m    /**[m
[32m+[m[32m     * PATCH /api/work-orders/:id[m
[32m+[m[32m     * Safe patch: whitelist + run hooks via save()[m
[32m+[m[32m     */[m
[32m+[m[32m    // PATCH /api/work-orders/:id[m
[32m+[m[32m    // Safe patch: whitelist + lifecycle + totals recalculation + runs schema hooks via save()[m
[32m+[m[32m    router.patch("/:id", async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const accountId = req.accountId;[m
[32m+[m[32m        if (!accountId) return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m
[32m+[m[32m        const { id } = req.params;[m
[32m+[m[32m        if (!Types.ObjectId.isValid(id)) {[m
[32m+[m[32m          return res.status(400).json({ message: "Invalid work order id" });[m
[32m+[m[32m        }[m
 [m
[31m-      workOrder.lineItems = patch.lineItems.map((item: any) => {[m
[31m-        const quantity = Number(item?.quantity) || 0;[m
[31m-        const unitPrice = Number(item?.unitPrice) || 0;[m
[31m-        const lineTotal =[m
[31m-          typeof item?.lineTotal === "number" ? item.lineTotal : quantity * unitPrice;[m
[31m-[m
[31m-        return {[m
[31m-          type: item?.type,[m
[31m-          description: item?.description ?? "",[m
[31m-          quantity,[m
[31m-          unitPrice,[m
[31m-          lineTotal,[m
[31m-        };[m
[31m-      });[m
[31m-    }[m
[32m+[m[32m        const workOrder = await WorkOrder.findOne({ _id: id, accountId });[m
[32m+[m[32m        if (!workOrder) return res.status(404).json({ message: "Work order not found" });[m
 [m
[31m-    if (taxRateChanged) {[m
[31m-      const tr = Number(patch.taxRate);[m
[31m-      if (!Number.isFinite(tr) || tr < 0) {[m
[31m-        return res.status(400).json({ message: "taxRate must be a valid number >= 0" });[m
[31m-      }[m
[31m-      workOrder.taxRate = tr;[m
[31m-    }[m
[32m+[m[32m        const patch: any = req.body ?? {}; // âœ… keep this as any so TS doesn't block fields[m
 [m
[31m-    if (lineItemsChanged || taxRateChanged) {[m
[31m-      const items = Array.isArray(workOrder.lineItems) ? workOrder.lineItems : [];[m
[31m-      const subtotal = items.reduce([m
[31m-        (sum: number, item: any) => sum + (Number(item?.lineTotal) || 0),[m
[31m-        0[m
[31m-      );[m
[32m+[m[32m        // capture status BEFORE changes (for transition detection)[m
[32m+[m[32m        const prevStatus = workOrder.status;[m
 [m
[31m-      const taxRate = Number(workOrder.taxRate ?? 13);[m
[31m-      const taxAmount = subtotal * (taxRate / 100);[m
[31m-      const total = subtotal + taxAmount;[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        // 1) Simple text fields[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        if (patch.complaint !== undefined) workOrder.complaint = String(patch.complaint ?? "");[m
[32m+[m[32m        if (patch.diagnosis !== undefined) workOrder.diagnosis = String(patch.diagnosis ?? "");[m
[32m+[m[32m        if (patch.notes !== undefined) workOrder.notes = String(patch.notes ?? "");[m
 [m
[31m-      (workOrder as any).subtotal = subtotal;[m
[31m-      (workOrder as any).taxAmount = taxAmount;[m
[31m-      (workOrder as any).total = total;[m
[31m-    }[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        // 2) Vehicle snapshot[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        if (patch.vehicle !== undefined) {[m
[32m+[m[32m          workOrder.vehicle = patch.vehicle;[m
[32m+[m[32m        }[m
 [m
[31m-    // ----------------------------[m
[31m-    // 4) Lifecycle + odo logic (this is the key call)[m
[31m-    // ----------------------------[m
[31m-    applyWorkOrderLifecycle(workOrder, {[m
[31m-      status: patch.status,[m
[31m-      odometer: patch.odometer, // legacy support[m
[31m-      odometerIn: patch.odometerIn,[m
[31m-      odometerOut: patch.odometerOut,[m
[31m-      serviceOdometer: patch.serviceOdometer,[m
[31m-    });[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        // 3) Line items + tax rate + totals (optional but nice)[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        const lineItemsChanged = patch.lineItems !== undefined;[m
[32m+[m[32m        const taxRateChanged = patch.taxRate !== undefined;[m
[32m+[m
[32m+[m[32m        if (lineItemsChanged) {[m
[32m+[m[32m          if (!Array.isArray(patch.lineItems)) {[m
[32m+[m[32m            return res.status(400).json({ message: "lineItems must be an array" });[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          workOrder.lineItems = patch.lineItems.map((item: any) => {[m
[32m+[m[32m            const quantity = Number(item?.quantity) || 0;[m
[32m+[m[32m            const unitPrice = Number(item?.unitPrice) || 0;[m
[32m+[m[32m            const lineTotal =[m
[32m+[m[32m              typeof item?.lineTotal === "number" ? item.lineTotal : quantity * unitPrice;[m
[32m+[m
[32m+[m[32m            return {[m
[32m+[m[32m              type: item?.type,[m
[32m+[m[32m              description: item?.description ?? "",[m
[32m+[m[32m              quantity,[m
[32m+[m[32m              unitPrice,[m
[32m+[m[32m              lineTotal,[m
[32m+[m[32m            };[m
[32m+[m[32m          });[m
[32m+[m[32m        }[m
 [m
[31m-    await workOrder.save();[m
[32m+[m[32m        if (taxRateChanged) {[m
[32m+[m[32m          const tr = Number(patch.taxRate);[m
[32m+[m[32m          if (!Number.isFinite(tr) || tr < 0) {[m
[32m+[m[32m            return res.status(400).json({ message: "taxRate must be a valid number >= 0" });[m
[32m+[m[32m          }[m
[32m+[m[32m          workOrder.taxRate = tr;[m
[32m+[m[32m        }[m
 [m
[31m-    const nextStatus = workOrder.status;[m
[32m+[m[32m        if (lineItemsChanged || taxRateChanged) {[m
[32m+[m[32m          const items = Array.isArray(workOrder.lineItems) ? workOrder.lineItems : [];[m
[32m+[m[32m          const subtotal = items.reduce([m
[32m+[m[32m            (sum: number, item: any) => sum + (Number(item?.lineTotal) || 0),[m
[32m+[m[32m            0[m
[32m+[m[32m          );[m
 [m
[31m-    // ----------------------------[m
[31m-    // 5) Write-back mileage when completing/invoicing[m
[31m-    // ----------------------------[m
[31m-    if ([m
[31m-      (nextStatus === "completed" || nextStatus === "invoiced") &&[m
[31m-      prevStatus !== nextStatus[m
[31m-    ) {[m
[31m-      const vehicleId = (workOrder as any)?.vehicle?.vehicleId;[m
[32m+[m[32m          const taxRate = Number(workOrder.taxRate ?? 13);[m
[32m+[m[32m          const taxAmount = subtotal * (taxRate / 100);[m
[32m+[m[32m          const total = subtotal + taxAmount;[m
 [m
[31m-      const mileage =[m
[31m-        (workOrder as any)?.odometerOut ??[m
[31m-        (workOrder as any)?.serviceOdometer ??[m
[31m-        (workOrder as any)?.odometerIn ??[m
[31m-        (workOrder as any)?.odometer;[m
[32m+[m[32m          (workOrder as any).subtotal = subtotal;[m
[32m+[m[32m          (workOrder as any).taxAmount = taxAmount;[m
[32m+[m[32m          (workOrder as any).total = total;[m
[32m+[m[32m        }[m
 [m
[31m-      if (vehicleId && typeof mileage === "number") {[m
[31m-        await writeBackVehicleOdometer({[m
[31m-          accountId,[m
[31m-          customerId: workOrder.customerId,[m
[31m-          vehicleId,[m
[31m-          odometer: mileage,[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        // 4) Lifecycle + odo logic (this is the key call)[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        applyWorkOrderLifecycle(workOrder, {[m
[32m+[m[32m          status: patch.status,[m
[32m+[m[32m          odometer: patch.odometer, // legacy support[m
[32m+[m[32m          odometerIn: patch.odometerIn,[m
[32m+[m[32m          odometerOut: patch.odometerOut,[m
[32m+[m[32m          serviceOdometer: patch.serviceOdometer,[m
         });[m
[31m-      }[m
[31m-    }[m
[31m-[m
[31m-    res.json(workOrder);[m
[31m-  } catch (err: any) {[m
[31m-    // If odo rule throws, return 400 instead of 500[m
[31m-    if (err instanceof Error && err.message.includes("odometerOut")) {[m
[31m-      return res.status(400).json({ message: err.message });[m
[31m-    }[m
[31m-    next(err);[m
[31m-  }[m
[31m-});[m
 [m
[32m+[m[32m        await workOrder.save();[m
[32m+[m
[32m+[m[32m        const nextStatus = workOrder.status;[m
[32m+[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        // 5) Write-back mileage when completing/invoicing[m
[32m+[m[32m        // ----------------------------[m
[32m+[m[32m        if ([m
[32m+[m[32m          (nextStatus === "completed" || nextStatus === "invoiced") &&[m
[32m+[m[32m          prevStatus !== nextStatus[m
[32m+[m[32m        ) {[m
[32m+[m[32m          const vehicleId = (workOrder as any)?.vehicle?.vehicleId;[m
[32m+[m
[32m+[m[32m          const mileage =[m
[32m+[m[32m            (workOrder as any)?.odometerOut ??[m
[32m+[m[32m            (workOrder as any)?.serviceOdometer ??[m
[32m+[m[32m            (workOrder as any)?.odometerIn ??[m
[32m+[m[32m            (workOrder as any)?.odometer;[m
[32m+[m
[32m+[m[32m          if (vehicleId && typeof mileage === "number") {[m
[32m+[m[32m            await writeBackVehicleOdometer({[m
[32m+[m[32m              accountId,[m
[32m+[m[32m              customerId: workOrder.customerId,[m
[32m+[m[32m              vehicleId,[m
[32m+[m[32m              odometer: mileage,[m
[32m+[m[32m            });[m
[32m+[m[32m          }[m
[32m+[m[32m        }[m
 [m
[31m-/**[m
[31m- * PATCH /api/work-orders/:id/status[m
[31m- * Quick status update with lifecycle timestamps + existing lifecycle helper.[m
[31m- */[m
[31m-router.patch([m
[31m-  "/:id/status",[m
[31m-  async (req: Request, res: Response, next: NextFunction) => {[m
[31m-    try {[m
[31m-      const accountId = req.accountId;[m
[31m-      if (!accountId)[m
[31m-        return res.status(400).json({ message: "Missing accountId" });[m
[31m-[m
[31m-      const { id } = req.params;[m
[31m-      if (!Types.ObjectId.isValid(id)) {[m
[31m-        return res.status(400).json({ message: "Invalid work order id" });[m
[32m+[m[32m        res.json(workOrder);[m
[32m+[m[32m      } catch (err: any) {[m
[32m+[m[32m        // If odo rule throws, return 400 instead of 500[m
[32m+[m[32m        if (err instanceof Error && err.message.includes("odometerOut")) {[m
[32m+[m[32m          return res.status(400).json({ message: err.message });[m
[32m+[m[32m        }[m
[32m+[m[32m        next(err);[m
       }[m
[32m+[m[32m    });[m
 [m
[31m-      const rawStatus = (req.body?.status || "").trim().toLowerCase();[m
[31m-      if (!rawStatus) {[m
[31m-        return res.status(400).json({ message: "status is required" });[m
[31m-      }[m
 [m
[31m-      // Normalize status aliases[m
[31m-      const nextStatus =[m
[31m-        rawStatus === "complete" ? "completed" : rawStatus;[m
[31m-[m
[31m-      // âœ… Allowed statuses (keep legacy "invoiced" for now if your DB has it)[m
[31m-      const allowed = [[m
[31m-        "open",[m
[31m-        "in_progress",[m
[31m-        "on_hold",[m
[31m-        "completed",[m
[31m-        "invoiced",  // legacy/optional[m
[31m-        "cancelled",[m
[31m-      ];[m
[31m-[m
[31m-      if (!allowed.includes(nextStatus)) {[m
[31m-        return res.status(400).json({[m
[31m-          message: `Invalid status. Allowed: ${allowed.join(", ")}`,[m
[31m-        });[m
[31m-      }[m
[32m+[m[32m    /**[m
[32m+[m[32m     * PATCH /api/work-orders/:id/status[m
[32m+[m[32m     * Quick status update with lifecycle timestamps + existing lifecycle helper.[m
[32m+[m[32m     */[m
[32m+[m[32m    router.patch([m
[32m+[m[32m      "/:id/status",[m
[32m+[m[32m      async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m        try {[m
[32m+[m[32m          const accountId = req.accountId;[m
[32m+[m[32m          if (!accountId)[m
[32m+[m[32m            return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m
[32m+[m[32m          const { id } = req.params;[m
[32m+[m[32m          if (!Types.ObjectId.isValid(id)) {[m
[32m+[m[32m            return res.status(400).json({ message: "Invalid work order id" });[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          const rawStatus = (req.body?.status || "").trim().toLowerCase();[m
[32m+[m[32m          if (!rawStatus) {[m
[32m+[m[32m            return res.status(400).json({ message: "status is required" });[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          // Normalize status aliases[m
[32m+[m[32m          const nextStatus =[m
[32m+[m[32m            rawStatus === "complete" ? "completed" : rawStatus;[m
[32m+[m
[32m+[m[32m          // âœ… Allowed statuses (keep legacy "invoiced" for now if your DB has it)[m
[32m+[m[32m          const allowed = [[m
[32m+[m[32m            "open",[m
[32m+[m[32m            "in_progress",[m
[32m+[m[32m            "on_hold",[m
[32m+[m[32m            "completed",[m
[32m+[m[32m            "invoiced",  // legacy/optional[m
[32m+[m[32m            "cancelled",[m
[32m+[m[32m          ];[m
[32m+[m
[32m+[m[32m          if (!allowed.includes(nextStatus)) {[m
[32m+[m[32m            return res.status(400).json({[m
[32m+[m[32m              message: `Invalid status. Allowed: ${allowed.join(", ")}`,[m
[32m+[m[32m            });[m
[32m+[m[32m          }[m
 [m
[31m-      // Fetch scoped by accountId[m
[31m-      const workOrder = await WorkOrder.findOne({ _id: id, accountId });[m
[31m-      if (!workOrder)[m
[31m-        return res.status(404).json({ message: "Work order not found" });[m
[32m+[m[32m          // Fetch scoped by accountId[m
[32m+[m[32m          const workOrder = await WorkOrder.findOne({ _id: id, accountId });[m
[32m+[m[32m          if (!workOrder)[m
[32m+[m[32m            return res.status(404).json({ message: "Work order not found" });[m
 [m
[31m-      const now = new Date();[m
[32m+[m[32m          const now = new Date();[m
 [m
[31m-      // âœ… Assign status[m
[31m-      workOrder.status = nextStatus as any;[m
[32m+[m[32m          // âœ… Assign status[m
[32m+[m[32m          workOrder.status = nextStatus as any;[m
 [m
[31m-      // âœ… Stamp lifecycle times (server is source of truth)[m
[31m-      // Note: only stamp the first time each milestone occurs.[m
[31m-      if (nextStatus === "in_progress") {[m
[31m-        // If you don't actually have startedAt in schema, remove these 2 lines.[m
[31m-        if (!(workOrder as any).startedAt) (workOrder as any).startedAt = now;[m
[31m-      }[m
[32m+[m[32m          // âœ… Stamp lifecycle times (server is source of truth)[m
[32m+[m[32m          // Note: only stamp the first time each milestone occurs.[m
[32m+[m[32m          if (nextStatus === "in_progress") {[m
[32m+[m[32m            // If you don't actually have startedAt in schema, remove these 2 lines.[m
[32m+[m[32m            if (!(workOrder as any).startedAt) (workOrder as any).startedAt = now;[m
[32m+[m[32m          }[m
 [m
[31m-      if (nextStatus === "on_hold") {[m
[31m-        // If you don't actually have onHoldAt in schema, remove these 2 lines.[m
[31m-        if (!(workOrder as any).onHoldAt) (workOrder as any).onHoldAt = now;[m
[31m-      }[m
[32m+[m[32m          if (nextStatus === "on_hold") {[m
[32m+[m[32m            // If you don't actually have onHoldAt in schema, remove these 2 lines.[m
[32m+[m[32m            if (!(workOrder as any).onHoldAt) (workOrder as any).onHoldAt = now;[m
[32m+[m[32m          }[m
 [m
[31m-      if (nextStatus === "completed") {[m
[31m-        if (!workOrder.completedAt) workOrder.completedAt = now;[m
[32m+[m[32m          if (nextStatus === "completed") {[m
[32m+[m[32m            if (!workOrder.completedAt) workOrder.completedAt = now;[m
 [m
[31m-        // ðŸ”¥ Optional: when completing a job, ensure it's not "closed"[m
[31m-        // (closing happens when invoice is paid/void, not when work completes)[m
[31m-        // If you are using closedAt for archive, keep it unset here:[m
[31m-        // workOrder.closedAt = undefined; // only if you want to actively unset[m
[31m-      }[m
[32m+[m[32m            // ðŸ”¥ Optional: when completing a job, ensure it's not "closed"[m
[32m+[m[32m            // (closing happens when invoice is paid/void, not when work completes)[m
[32m+[m[32m            // If you are using closedAt for archive, keep it unset here:[m
[32m+[m[32m            // workOrder.closedAt = undefined; // only if you want to actively unset[m
[32m+[m[32m          }[m
 [m
[31m-      if (nextStatus === "invoiced") {[m
[31m-        // legacy; if youâ€™re phasing this out, you can keep stamping for old flow[m
[31m-        if (!workOrder.invoicedAt) workOrder.invoicedAt = now;[m
[31m-      }[m
[32m+[m[32m          if (nextStatus === "invoiced") {[m
[32m+[m[32m            // legacy; if youâ€™re phasing this out, you can keep stamping for old flow[m
[32m+[m[32m            if (!workOrder.invoicedAt) workOrder.invoicedAt = now;[m
[32m+[m[32m          }[m
 [m
[31m-      if (nextStatus === "cancelled") {[m
[31m-        if (!workOrder.cancelledAt) workOrder.cancelledAt = now;[m
[32m+[m[32m          if (nextStatus === "cancelled") {[m
[32m+[m[32m            if (!workOrder.cancelledAt) workOrder.cancelledAt = now;[m
 [m
[31m-        // Optional: treat cancelled as archived[m
[31m-        // If you want cancelled items to show in Archive view:[m
[31m-        // if (!workOrder.closedAt) workOrder.closedAt = now;[m
[31m-      }[m
[32m+[m[32m            // Optional: treat cancelled as archived[m
[32m+[m[32m            // If you want cancelled items to show in Archive view:[m
[32m+[m[32m            // if (!workOrder.closedAt) workOrder.closedAt = now;[m
[32m+[m[32m          }[m
 [m
[31m-      // âœ… Keep your existing lifecycle helper (does totals, normalization, etc.)[m
[31m-      // Pass the normalized status so it stays consistent[m
[31m-      applyWorkOrderLifecycle(workOrder, { status: nextStatus });[m
[32m+[m[32m          // âœ… Keep your existing lifecycle helper (does totals, normalization, etc.)[m
[32m+[m[32m          // Pass the normalized status so it stays consistent[m
[32m+[m[32m          applyWorkOrderLifecycle(workOrder, { status: nextStatus });[m
 [m
[31m-      await workOrder.save();[m
[32m+[m[32m          await workOrder.save();[m
 [m
[31m-      res.json(workOrder);[m
[31m-    } catch (err) {[m
[31m-      next(err);[m
[31m-    }[m
[31m-  }[m
[31m-);[m
[32m+[m[32m          res.json(workOrder);[m
[32m+[m[32m        } catch (err) {[m
[32m+[m[32m          next(err);[m
[32m+[m[32m        }[m
[32m+[m[32m      }[m
[32m+[m[32m    );[m
 [m
 [m
 [m
[31m-router.delete([m
[31m-    "/:id",[m
[31m-    async (req: Request, res: Response, next: NextFunction) => {[m
[32m+[m[32m    router.delete([m
[32m+[m[32m      "/:id",[m
[32m+[m[32m      async (req: Request, res: Response, next: NextFunction) => {[m
         try {[m
[31m-            const accountId = req.accountId;[m
[31m-            if (!accountId) {[m
[31m-                return res.status(400).json({ message: "Missing accountId" });[m
[31m-            }[m
[31m-[m
[31m-            const { id } = req.params;[m
[31m-            const deleted = await WorkOrder.findOneAndDelete({[m
[31m-                _id: id,[m
[31m-                accountId,[m
[31m-            });[m
[31m-[m
[31m-            if (!deleted) {[m
[31m-                return res.status(404).json({ message: "Work order not found" });[m
[31m-            }[m
[31m-[m
[31m-            return res.status(204).send();[m
[32m+[m[32m          const accountId = req.accountId;[m
[32m+[m[32m          if (!accountId) {[m
[32m+[m[32m            return res.status(400).json({ message: "Missing accountId" });[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          const { id } = req.params;[m
[32m+[m[32m          const deleted = await WorkOrder.findOneAndDelete({[m
[32m+[m[32m            _id: id,[m
[32m+[m[32m            accountId,[m
[32m+[m[32m          });[m
[32m+[m
[32m+[m[32m          if (!deleted) {[m
[32m+[m[32m            return res.status(404).json({ message: "Work order not found" });[m
[32m+[m[32m          }[m
[32m+[m
[32m+[m[32m          return res.status(204).send();[m
         } catch (err) {[m
[31m-            next(err);[m
[32m+[m[32m          next(err);[m
         }[m
[31m-    }[m
[32m+[m[32m      }[m
 );[m
[31m-[m
[31m-[m
[31m-[m
 export default router;[m
[1mdiff --git a/frontend/src/api/invoices.ts b/frontend/src/api/invoices.ts[m
[1mindex b5c1cc6..339de94 100644[m
[1m--- a/frontend/src/api/invoices.ts[m
[1m+++ b/frontend/src/api/invoices.ts[m
[36m@@ -1,9 +1,6 @@[m
[31m-// frontend/src/api/invoices.ts[m
[32m+[m[32m//frontend/src/api/invoices.ts[m
 import api from "./client";[m
[31m-import type { Invoice } from "../types/invoice";[m
[31m-[m
[31m-[m
[31m-export type InvoiceStatus = "draft" | "sent" | "paid" | "void";[m
[32m+[m[32mimport type { Invoice, InvoiceStatus } from "../types/invoice";[m
 [m
 export type FinancialSummaryResponse = {[m
   range: { from: string; to: string };[m
[36m@@ -14,7 +11,7 @@[m [mexport type FinancialSummaryResponse = {[m
   aging: Array<{ _id: "0-7" | "8-14" | "15-30" | "31+"; count: number; amount: number }>;[m
 };[m
 [m
[31m-const API_BASE = import.meta.env.VITE_API_BASE_URL; // http://localhost:4000/api[m
[32m+[m[32mconst API_BASE = import.meta.env.VITE_API_BASE_URL;[m
 [m
 // GET /api/invoices[m
 export async function fetchInvoices(): Promise<Invoice[]> {[m
[36m@@ -28,7 +25,7 @@[m [mexport async function fetchInvoiceById(id: string): Promise<Invoice> {[m
   return res.data;[m
 }[m
 [m
[31m-// For <a href> or window.open[m
[32m+[m[32m// PDF helper[m
 export function getInvoicePdfUrl(invoiceId: string) {[m
   return `${API_BASE}/invoices/${invoiceId}/pdf`;[m
 }[m
[36m@@ -41,15 +38,22 @@[m [mexport async function emailInvoice(invoiceId: string) {[m
     message: string;[m
     email?: any;[m
     status?: string;[m
[32m+[m[32m    financialStatus?: string;[m
[32m+[m[32m    paidAmount?: number;[m
[32m+[m[32m    balanceDue?: number;[m
   };[m
 }[m
 [m
 // PATCH /api/invoices/:id/status[m
 export async function updateInvoiceStatus([m
[31m-  invoiceId: string,[m
[31m-  status: InvoiceStatus[m
[32m+[m[32m  id: string,[m
[32m+[m[32m  status: InvoiceStatus,[m
[32m+[m[32m  reason?: string[m
 ): Promise<Invoice> {[m
[31m-  const res = await api.patch<Invoice>(`/invoices/${invoiceId}/status`, { status });[m
[32m+[m[32m  const res = await api.patch<Invoice>([m
[32m+[m[32m    `/invoices/${id}/status`,[m
[32m+[m[32m    status === "void" ? { status, reason } : { status }[m
[32m+[m[32m  );[m
   return res.data;[m
 }[m
 [m
[36m@@ -64,6 +68,7 @@[m [mexport async function fetchFinancialSummary([m
   return res.data;[m
 }[m
 [m
[32m+[m[32m// POST /api/invoices/:id/pay[m
 export async function recordInvoicePayment([m
   invoiceId: string,[m
   payload: {[m
[36m@@ -72,6 +77,6 @@[m [mexport async function recordInvoicePayment([m
     reference?: string;[m
   }[m
 ): Promise<Invoice> {[m
[31m-  const res = await api.post<{ invoice: Invoice }>(`/invoices/${invoiceId}/pay`, payload);[m
[31m-  return res.data.invoice;[m
[32m+[m[32m  const res = await api.post<Invoice>(`/invoices/${invoiceId}/pay`, payload);[m
[32m+[m[32m  return res.data;[m
 }[m
[1mdiff --git a/frontend/src/api/workOrders.ts b/frontend/src/api/workOrders.ts[m
[1mindex c45d88b..e4dd393 100644[m
[1m--- a/frontend/src/api/workOrders.ts[m
[1m+++ b/frontend/src/api/workOrders.ts[m
[36m@@ -42,31 +42,63 @@[m [mexport interface WorkOrderFilters {[m
 [m
 [m
 [m
[32m+[m[32m// frontend/src/api/workOrder.ts[m
 export async function fetchWorkOrders([m
   filters: WorkOrderFilters = {}[m
 ): Promise<WorkOrder[]> {[m
   const params: Record<string, string> = {};[m
 [m
[31m-  // âœ… NEW: view-based filtering (preferred)[m
   if (filters.view) params.view = filters.view;[m
[31m-[m
[31m-  // existing filters â€” KEEP THESE (status can still be used by other pages)[m
   if (filters.status) params.status = filters.status;[m
   if (filters.customerId) params.customerId = filters.customerId;[m
   if (filters.vehicleId) params.vehicleId = filters.vehicleId;[m
   if (filters.fromDate) params.fromDate = filters.fromDate;[m
   if (filters.toDate) params.toDate = filters.toDate;[m
[31m-[m
[31m-  // sorting params[m
   if (filters.sortBy) params.sortBy = filters.sortBy;[m
   if (filters.sortDir) params.sortDir = filters.sortDir;[m
 [m
[31m-  const res = await api.get<WorkOrder[]>("/work-orders", { params });[m
[31m-  return res.data;[m
[32m+[m[32m  const res = await api.get<any>("/work-orders", { params });[m
[32m+[m
[32m+[m[32m  const raw = res.data;[m
[32m+[m
[32m+[m[32m  // âœ… MUST be WorkOrder[][m
[32m+[m[32m  if (Array.isArray(raw)) return raw;[m
[32m+[m
[32m+[m[32m  // ðŸ”¥ emergency compatibility (prevents blank UI)[m
[32m+[m[32m  const fallback =[m
[32m+[m[32m    raw?.workOrders ??[m
[32m+[m[32m    raw?.items ??[m
[32m+[m[32m    raw?.results ??[m
[32m+[m[32m    raw?.data ??[m
[32m+[m[32m    [];[m
[32m+[m[41m  [m
[32m+[m[41m  [m
[32m+[m[32m  // frontend/src/api/workOrder.ts[m
[32m+[m[32m    const workOrders = Array.isArray(raw) ? raw : Array.isArray(fallback) ? fallback : [];[m
[32m+[m
[32m+[m[32m    return workOrders.map((wo: any) => {[m
[32m+[m[32m      const invoice =[m
[32m+[m[32m        wo.invoice ??[m
[32m+[m[32m        (wo.invoiceId && typeof wo.invoiceId === "object" ? wo.invoiceId : undefined);[m
[32m+[m
[32m+[m[32m      const customer =[m
[32m+[m[32m        wo.customer ??[m
[32m+[m[32m        (wo.customerId && typeof wo.customerId === "object" ? wo.customerId : undefined);[m
[32m+[m
[32m+[m[32m      return {[m
[32m+[m[32m        ...wo,[m
[32m+[m[32m        invoice,   // âœ… now wo.invoice exists for UI[m
[32m+[m[32m        customer,  // âœ… now wo.customer exists for formatCustomerName[m
[32m+[m[32m      };[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m
[32m+[m[32m  return Array.isArray(fallback) ? fallback : [];[m
 }[m
 [m
 [m
 [m
[32m+[m
 export async function fetchWorkOrder(id: string): Promise<WorkOrder> {[m
     const res = await api.get<WorkOrder>(`/work-orders/${id}`);[m
     return res.data;[m
[1mdiff --git a/frontend/src/components/DashboardSummary.tsx b/frontend/src/components/DashboardSummary.tsx[m
[1mindex 1857fe1..ec96e9f 100644[m
[1m--- a/frontend/src/components/DashboardSummary.tsx[m
[1m+++ b/frontend/src/components/DashboardSummary.tsx[m
[36m@@ -178,7 +178,11 @@[m [mif (error || !data || !financial) {[m
                 <p className="stat-card__hint">Lifetime total from completed work (ops metric).</p>[m
                 </article>[m
 [m
[31m-                <article className="stat-card stat-card--open stat-card--clickable" onClick={() => navigate("/invoices")}>[m
[32m+[m[32m                <article[m
[32m+[m[32m  className="stat-card stat-card--open stat-card--clickable"[m
[32m+[m[32m  onClick={() => navigate("/work-orders?view=financial")}[m
[32m+[m[32m>[m
[32m+[m
                 <div className="stat-card__top">[m
                     <span className="stat-card__icon">ðŸ§¾</span>[m
                     <span className="stat-card__label">Outstanding</span>[m
[1mdiff --git a/frontend/src/pages/InvoiceDetailPage.tsx b/frontend/src/pages/InvoiceDetailPage.tsx[m
[1mindex 4b3d081..2a18597 100644[m
[1m--- a/frontend/src/pages/InvoiceDetailPage.tsx[m
[1m+++ b/frontend/src/pages/InvoiceDetailPage.tsx[m
[36m@@ -197,7 +197,15 @@[m [mexport default function InvoiceDetailPage() {[m
 [m
       const resp = await emailInvoice(invoice._id);[m
 [m
[31m-      setInvoice((prev) => (prev ? { ...prev, email: resp.email ?? (prev as any).email } : prev));[m
[32m+[m[32m      setInvoice((prev) =>[m
[32m+[m[32m        prev[m
[32m+[m[32m          ? {[m
[32m+[m[32m              ...prev,[m
[32m+[m[32m              ...(resp?.status ? { status: resp.status as any } : null),[m
[32m+[m[32m              ...(resp?.email ? { email: resp.email as any } : null),[m
[32m+[m[32m            }[m
[32m+[m[32m          : prev[m
[32m+[m[32m      );[m
 [m
       alert("âœ… Invoice emailed.");[m
       // Optional: mark as sent automatically after successful email:[m
[36m@@ -230,6 +238,31 @@[m [mexport default function InvoiceDetailPage() {[m
     }[m
   }[m
 [m
[32m+[m[32m  async function handleVoidInvoice() {[m
[32m+[m[32m  if (!invoice?._id) return;[m
[32m+[m[32m  if (String(invoice.financialStatus || "draft").toLowerCase() === "paid") {[m
[32m+[m[32m    alert("This invoice is PAID and cannot be voided.");[m
[32m+[m[32m    return;[m
[32m+[m[32m  }[m
[32m+[m[32m  if (String(invoice.financialStatus || "draft").toLowerCase() === "void") return;[m
[32m+[m
[32m+[m[32m  const reason = window.prompt("Void reason (required):");[m
[32m+[m[32m  if (!reason || !reason.trim()) return;[m
[32m+[m
[32m+[m[32m  try {[m
[32m+[m[32m    setIsSaving(true);[m
[32m+[m[32m    setError(null);[m
[32m+[m
[32m+[m[32m    const updated = await updateInvoiceStatus(invoice._id, "void", reason.trim());[m
[32m+[m[32m    setInvoice(updated);[m
[32m+[m[32m  } catch (err: any) {[m
[32m+[m[32m    setError(err?.message || "Failed to void invoice");[m
[32m+[m[32m  } finally {[m
[32m+[m[32m    setIsSaving(false);[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m
   const customerName = [invoice.customerSnapshot?.firstName, invoice.customerSnapshot?.lastName][m
     .filter(Boolean)[m
     .join(" ");[m
[36m@@ -242,297 +275,328 @@[m [mexport default function InvoiceDetailPage() {[m
 [m
 [m
 [m
[31m-    // --- Money + status clarity (header polish) ---[m
[31m-    const statusRaw = String(invoice.status ?? "draft").toLowerCase();[m
[32m+[m[32m// --- Money + status clarity (backend truth) ---[m
[32m+[m[32m  const lifecycleRaw = String(invoice.financialStatus ?? "draft").toLowerCase();[m
[32m+[m
[32m+[m[32m  // lifecycle flags (allowed: these are not financial inference)[m
[32m+[m[32m  const isDraft = lifecycleRaw === "draft";[m
[32m+[m[32m  const isVoid = lifecycleRaw === "void";[m
[32m+[m[32m  const isReadOnly = !isDraft;[m
[32m+[m
[32m+[m[32m  // financial truth flags (backend decides paid/partial/due)[m
[32m+[m[32m  const financialRaw = String((invoice as any).financialStatus ?? "").toLowerCase();[m
[32m+[m[32m  const isPaid = financialRaw === "paid";[m
[32m+[m[32m  const isPartial = financialRaw === "partial";[m
[32m+[m[32m  const isDue = financialRaw === "due" || !financialRaw; // tolerate older invoices missing financialStatus[m
 [m
[31m-    const paidAmountNum = Number((invoice as any).paidAmount ?? 0);[m
[31m-    const balanceDueNum = Number((invoice as any).balanceDue ?? Number(invoice.total ?? 0));[m
[32m+[m[32m  // money values: display-only (never used to infer status)[m
[32m+[m[32m  const paidAmountNum = Number((invoice as any).paidAmount ?? 0);[m
[32m+[m[32m  const balanceDueNum = Number((invoice as any).balanceDue ?? Number(invoice.total ?? 0));[m
 [m
[31m-    const latestPaymentDate = getLatestPaymentDate(invoice);[m
[32m+[m[32m  const latestPaymentDate = getLatestPaymentDate(invoice);[m
 [m
[31m-    const paidOrLastPaymentLine =[m
[31m-      statusRaw === "paid" && latestPaymentDate[m
[31m-        ? `Paid on ${fmtDateTime(latestPaymentDate)}`[m
[31m-        : paidAmountNum > 0 && balanceDueNum > 0 && statusRaw !== "void"[m
[31m-        ? latestPaymentDate[m
[31m-          ? `Last payment ${fmtDateTime(latestPaymentDate)}`[m
[31m-          : "Last payment â€”"[m
[31m-        : "";[m
[32m+[m[32m  // display-only helper line (driven by backend financialStatus + payments)[m
[32m+[m[32m  const paidOrLastPaymentLine =[m
[32m+[m[32m    isVoid[m
[32m+[m[32m      ? ""[m
[32m+[m[32m      : isPaid && latestPaymentDate[m
[32m+[m[32m      ? `Paid on ${fmtDateTime(latestPaymentDate)}`[m
[32m+[m[32m      : isPartial && latestPaymentDate[m
[32m+[m[32m      ? `Last payment ${fmtDateTime(latestPaymentDate)}`[m
[32m+[m[32m      : "";[m
 [m
  [m
  [m
  [m
[31m-  return ([m
[31m-    <div style={{ padding: "1.5rem", maxWidth: "900px", margin: "0 auto" }}>[m
[31m-      {/* Header */}[m
[31m-      <div[m
[31m-        style={{[m
[31m-          display: "flex",[m
[31m-          justifyContent: "space-between",[m
[31m-          alignItems: "flex-start",[m
[31m-          gap: "1rem",[m
[31m-          marginBottom: "1rem",[m
[31m-        }}[m
[31m-      >[m
[31m-    <div style={{ flex: 1 }}>[m
[31m-          <h2 style={{ margin: 0 }}>Invoice #{invoice.invoiceNumber}</h2>[m
[31m-[m
[31m-          {/* NEW: Confidence money line */}[m
[31m-          <div[m
[31m-              style={{[m
[31m-                marginTop: "0.35rem",[m
[31m-                color: "#9ca3af",[m
[31m-                fontWeight: 600,[m
[31m-                fontSize: "0.95rem",[m
[31m-              }}[m
[31m-            >[m
[31m-[m
[31m-            Total {Number(invoice.total ?? 0).toFixed(2)}{" "}[m
[31m-            <span style={{ color: "#6b7280", fontWeight: 500 }}>â€¢</span>{" "}[m
[31m-            Paid {paidAmountNum.toFixed(2)}{" "}[m
[31m-            <span style={{ color: "#6b7280", fontWeight: 500 }}>â€¢</span>{" "}[m
[31m-            Balance {balanceDueNum.toFixed(2)}[m
[31m-          </div>[m
[32m+[m[32mreturn ([m
[32m+[m[32m  <div style={{ padding: "1.5rem", maxWidth: "900px", margin: "0 auto" }}>[m
[32m+[m[32m    {/* Header */}[m
[32m+[m[32m    <div[m
[32m+[m[32m      style={{[m
[32m+[m[32m        display: "flex",[m
[32m+[m[32m        justifyContent: "space-between",[m
[32m+[m[32m        alignItems: "flex-start",[m
[32m+[m[32m        gap: "1rem",[m
[32m+[m[32m        marginBottom: "1rem",[m
[32m+[m[32m      }}[m
[32m+[m[32m    >[m
[32m+[m[32m      <div style={{ flex: 1 }}>[m
[32m+[m[32m        <h2 style={{ margin: 0 }}>Invoice #{invoice.invoiceNumber}</h2>[m
[32m+[m
[32m+[m[32m        {/* NEW: Confidence money line */}[m
[32m+[m[32m        <div[m
[32m+[m[32m          style={{[m
[32m+[m[32m            marginTop: "0.35rem",[m
[32m+[m[32m            color: "#9ca3af",[m
[32m+[m[32m            fontWeight: 600,[m
[32m+[m[32m            fontSize: "0.95rem",[m
[32m+[m[32m          }}[m
[32m+[m[32m        >[m
[32m+[m[32m          Total {Number(invoice.total ?? 0).toFixed(2)}{" "}[m
[32m+[m[32m          <span style={{ color: "#6b7280", fontWeight: 500 }}>â€¢</span>{" "}[m
[32m+[m[32m          Paid {paidAmountNum.toFixed(2)}{" "}[m
[32m+[m[32m          <span style={{ color: "#6b7280", fontWeight: 500 }}>â€¢</span>{" "}[m
[32m+[m[32m          Balance {balanceDueNum.toFixed(2)}[m
[32m+[m[32m        </div>[m
 [m
[31m-          {/* Status + paid/last payment + email meta */}[m
[31m-          <div style={{ marginTop: "0.5rem", display: "flex", gap: "0.75rem", alignItems: "center", flexWrap: "wrap" }}>[m
[31m-            {/* Status badge (your existing IIFE stays exactly the same) */}[m
[31m-            {(() => {[m
[31m-              const status = String(invoice.status ?? "draft").toLowerCase();[m
[31m-[m
[31m-              const paidAmount = Number((invoice as any).paidAmount ?? 0);[m
[31m-              const balanceDue = Number((invoice as any).balanceDue ?? 0);[m
[31m-[m
[31m-              // Display-state (even if backend status is still "sent")[m
[31m-              const isPartial =[m
[31m-                paidAmount > 0 && balanceDue > 0 && status !== "paid" && status !== "void";[m
[31m-[m
[31m-              const label =[m
[31m-                status === "paid"[m
[31m-                  ? "PAID"[m
[31m-                  : status === "void"[m
[31m-                  ? "VOID"[m
[31m-                  : isPartial[m
[31m-                  ? "PARTIAL"[m
[31m-                  : status.toUpperCase();[m
[31m-[m
[31m-              const stylesByLabel: Record<string, React.CSSProperties> = {[m
[31m-                PAID: {[m
[31m-                  border: "2px solid #16a34a",[m
[31m-                  color: "#16a34a",[m
[31m-                  background: "#f0fdf4",[m
[31m-                },[m
[31m-                VOID: {[m
[31m-                  border: "2px solid #dc2626",[m
[31m-                  color: "#dc2626",[m
[31m-                  background: "#fef2f2",[m
[31m-                },[m
[31m-                PARTIAL: {[m
[31m-                  border: "2px solid #d97706",[m
[31m-                  color: "#b45309",[m
[31m-                  background: "#fffbeb",[m
[31m-                },[m
[31m-                SENT: {[m
[31m-                  border: "2px solid #2563eb",[m
[31m-                  color: "#2563eb",[m
[31m-                  background: "#eff6ff",[m
[31m-                },[m
[31m-                DRAFT: {[m
[31m-                  border: "2px solid #6b7280",[m
[31m-                  color: "#374151",[m
[31m-                  background: "#f3f4f6",[m
[31m-                },[m
[31m-              };[m
[31m-[m
[31m-              const base: React.CSSProperties = {[m
[31m-                padding: "0.4rem 0.9rem",[m
[31m-                borderRadius: "999px",[m
[31m-                fontSize: "0.95rem",[m
[31m-                fontWeight: 900,[m
[31m-                letterSpacing: "0.08em",[m
[31m-                textTransform: "uppercase",[m
[31m-                display: "inline-flex",[m
[31m-                alignItems: "center",[m
[31m-                gap: "0.5rem",[m
[31m-                boxShadow: "0 1px 0 rgba(0,0,0,0.04)",[m
[31m-              };[m
[31m-[m
[31m-              return ([m
[31m-                <span style={{ ...base, ...(stylesByLabel[label] ?? stylesByLabel.DRAFT) }}>[m
[31m-                  {label}[m
[31m-                </span>[m
[31m-              );[m
[31m-            })()}[m
[31m-[m
[31m-            {/* NEW: Paid/Last payment line (truth = payments[]) */}[m
[31m-            {paidOrLastPaymentLine ? ([m
[31m-              <span style={{ fontSize: "0.9rem", color: "#374151", fontWeight: 600 }}>[m
[31m-                {paidOrLastPaymentLine}[m
[32m+[m[32m        {/* Status + paid/last payment + email meta */}[m
[32m+[m[32m        <div[m
[32m+[m[32m          style={{[m
[32m+[m[32m            marginTop: "0.5rem",[m
[32m+[m[32m            display: "flex",[m
[32m+[m[32m            gap: "0.75rem",[m
[32m+[m[32m            alignItems: "center",[m
[32m+[m[32m            flexWrap: "wrap",[m
[32m+[m[32m          }}[m
[32m+[m[32m        >[m
[32m+[m[32m          {/* Status badge (NOW: backend truth only, no amount math) */}[m
[32m+[m[32m          {(() => {[m
[32m+[m[32m            const lifecycle = String(invoice.financialStatus ?? "draft").toLowerCase();[m
[32m+[m[32m            const fin = String((invoice as any).financialStatus ?? "").toLowerCase();[m
[32m+[m
[32m+[m[32m            // Label policy:[m
[32m+[m[32m            // - void/draft come from lifecycle[m
[32m+[m[32m            // - paid/partial come from backend financialStatus[m
[32m+[m[32m            // - due (or unknown) uses existing token "SENT"[m
[32m+[m[32m            const label =[m
[32m+[m[32m              lifecycle === "void"[m
[32m+[m[32m                ? "VOID"[m
[32m+[m[32m                : lifecycle === "draft"[m
[32m+[m[32m                ? "DRAFT"[m
[32m+[m[32m                : fin === "paid"[m
[32m+[m[32m                ? "PAID"[m
[32m+[m[32m                : fin === "partial"[m
[32m+[m[32m                ? "PARTIAL"[m
[32m+[m[32m                : "SENT";[m
[32m+[m
[32m+[m[32m            const stylesByLabel: Record<string, React.CSSProperties> = {[m
[32m+[m[32m              PAID: {[m
[32m+[m[32m                border: "2px solid #16a34a",[m
[32m+[m[32m                color: "#16a34a",[m
[32m+[m[32m                background: "#f0fdf4",[m
[32m+[m[32m              },[m
[32m+[m[32m              VOID: {[m
[32m+[m[32m                border: "2px solid #dc2626",[m
[32m+[m[32m                color: "#dc2626",[m
[32m+[m[32m                background: "#fef2f2",[m
[32m+[m[32m              },[m
[32m+[m[32m              PARTIAL: {[m
[32m+[m[32m                border: "2px solid #d97706",[m
[32m+[m[32m                color: "#b45309",[m
[32m+[m[32m                background: "#fffbeb",[m
[32m+[m[32m              },[m
[32m+[m[32m              SENT: {[m
[32m+[m[32m                border: "2px solid #2563eb",[m
[32m+[m[32m                color: "#2563eb",[m
[32m+[m[32m                background: "#eff6ff",[m
[32m+[m[32m              },[m
[32m+[m[32m              DRAFT: {[m
[32m+[m[32m                border: "2px solid #6b7280",[m
[32m+[m[32m                color: "#374151",[m
[32m+[m[32m                background: "#f3f4f6",[m
[32m+[m[32m              },[m
[32m+[m[32m            };[m
[32m+[m
[32m+[m[32m            const base: React.CSSProperties = {[m
[32m+[m[32m              padding: "0.4rem 0.9rem",[m
[32m+[m[32m              borderRadius: "999px",[m
[32m+[m[32m              fontSize: "0.95rem",[m
[32m+[m[32m              fontWeight: 900,[m
[32m+[m[32m              letterSpacing: "0.08em",[m
[32m+[m[32m              textTransform: "uppercase",[m
[32m+[m[32m              display: "inline-flex",[m
[32m+[m[32m              alignItems: "center",[m
[32m+[m[32m              gap: "0.5rem",[m
[32m+[m[32m              boxShadow: "0 1px 0 rgba(0,0,0,0.04)",[m
[32m+[m[32m            };[m
[32m+[m
[32m+[m[32m            return ([m
[32m+[m[32m              <span style={{ ...base, ...(stylesByLabel[label] ?? stylesByLabel.DRAFT) }}>[m
[32m+[m[32m                {label}[m
               </span>[m
[31m-            ) : null}[m
[32m+[m[32m            );[m
[32m+[m[32m          })()}[m
 [m
[31m-            {/* Email meta (unchanged) */}[m
[31m-            <span style={{ fontSize: "0.85rem", color: "#6b7280" }}>[m
[31m-              Email: {((invoice as any).email?.status ?? "never_sent").replace("_", " ")}[m
[31m-              {(invoice as any).email?.lastSentAt[m
[31m-                ? ` â€¢ Last: ${new Date((invoice as any).email.lastSentAt).toLocaleString()}`[m
[31m-                : ""}[m
[31m-              {liveCustomerLoading ? " â€¢ syncingâ€¦" : ""}[m
[32m+[m[32m          {/* NEW: Paid/Last payment line (truth = payments[]) */}[m
[32m+[m[32m          {paidOrLastPaymentLine ? ([m
[32m+[m[32m            <span style={{ fontSize: "0.9rem", color: "#374151", fontWeight: 600 }}>[m
[32m+[m[32m              {paidOrLastPaymentLine}[m
             </span>[m
[31m-          </div>[m
[31m-[m
[31m-          {emailError ? <div style={{ marginTop: "0.5rem", color: "#b91c1c" }}>{emailError}</div> : null}[m
[31m-    </div>[m
[31m-[m
[32m+[m[32m          ) : null}[m
 [m
[31m-        {/* Actions */}[m
[31m-        <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap", justifyContent: "flex-end" }}>[m
[31m-          <button[m
[31m-            type="button"[m
[31m-            disabled={!resolvedWorkOrderId}[m
[31m-            onClick={() => resolvedWorkOrderId && navigate(`/work-orders/${resolvedWorkOrderId}`)}[m
[31m-          >[m
[31m-            Back to Work Order[m
[31m-          </button>[m
[31m-[m
[31m-          <button type="button" disabled={isEmailing} onClick={handleSendOrResend}>[m
[31m-            {isEmailing[m
[31m-              ? "Sending..."[m
[31m-              : (invoice as any).email?.status && (invoice as any).email.status !== "never_sent"[m
[31m-              ? "Resend Email"[m
[31m-              : "Email Invoice"}[m
[31m-          </button>[m
[31m-[m
[31m-          <button[m
[31m-            type="button"[m
[31m-            onClick={() => {[m
[31m-              const url = getInvoicePdfUrl(invoice._id);[m
[31m-              window.open(url, "_blank");[m
[31m-            }}[m
[31m-          >[m
[31m-            View PDF[m
[31m-          </button>[m
[32m+[m[32m          {/* Email meta (unchanged) */}[m
[32m+[m[32m          <span style={{ fontSize: "0.85rem", color: "#6b7280" }}>[m
[32m+[m[32m            Email: {((invoice as any).email?.status ?? "never_sent").replace("_", " ")}[m
[32m+[m[32m            {(invoice as any).email?.lastSentAt[m
[32m+[m[32m              ? ` â€¢ Last: ${new Date((invoice as any).email.lastSentAt).toLocaleString()}`[m
[32m+[m[32m              : ""}[m
[32m+[m[32m            {liveCustomerLoading ? " â€¢ syncingâ€¦" : ""}[m
[32m+[m[32m          </span>[m
         </div>[m
[32m+[m
[32m+[m[32m        {emailError ? <div style={{ marginTop: "0.5rem", color: "#b91c1c" }}>{emailError}</div> : null}[m
       </div>[m
 [m
[31m-      {/* Status controls */}[m
[31m-      <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap", marginBottom: "1rem" }}>[m
[31m-        <button disabled={isSaving} onClick={() => handleSetStatus("draft")}>[m
[31m-          Mark Draft[m
[32m+[m[32m      {/* Actions */}[m
[32m+[m[32m      <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap", justifyContent: "flex-end" }}>[m
[32m+[m[32m        <button[m
[32m+[m[32m          type="button"[m
[32m+[m[32m          disabled={!resolvedWorkOrderId}[m
[32m+[m[32m          onClick={() => resolvedWorkOrderId && navigate(`/work-orders/${resolvedWorkOrderId}`)}[m
[32m+[m[32m        >[m
[32m+[m[32m          Back to Work Order[m
         </button>[m
[31m-        <button disabled={isSaving} onClick={() => handleSetStatus("sent")}>[m
[31m-          Mark Sent[m
[31m-        </button>[m
[31m-       [m
[31m-        <button disabled={isSaving} onClick={() => handleSetStatus("void")}>[m
[31m-          Void[m
[32m+[m
[32m+[m[32m        <button type="button" disabled={isEmailing} onClick={handleSendOrResend}>[m
[32m+[m[32m          {isEmailing[m
[32m+[m[32m            ? "Sending..."[m
[32m+[m[32m            : (invoice as any).email?.status && (invoice as any).email.status !== "never_sent"[m
[32m+[m[32m            ? "Resend Email"[m
[32m+[m[32m            : "Email Invoice"}[m
         </button>[m
[31m-      </div>[m
 [m
[31m-      {/* Dates row */}[m
[31m-      <div style={{ marginBottom: "1rem", fontSize: "0.95rem" }}>[m
[31m-        <strong>Issue Date:</strong>{" "}[m
[31m-        {invoice.issueDate ? new Date(invoice.issueDate).toLocaleDateString() : "â€”"}[m
[31m-        {invoice.dueDate ? ([m
[31m-          <>[m
[31m-            {" "}[m
[31m-            â€¢ <strong>Due Date:</strong> {new Date(invoice.dueDate).toLocaleDateString()}[m
[31m-          </>[m
[31m-        ) : null}[m
[32m+[m[32m        <button[m
[32m+[m[32m          type="button"[m
[32m+[m[32m          onClick={() => {[m
[32m+[m[32m            const url = getInvoicePdfUrl(invoice._id);[m
[32m+[m[32m            window.open(url, "_blank");[m
[32m+[m[32m          }}[m
[32m+[m[32m        >[m
[32m+[m[32m          View PDF[m
[32m+[m[32m        </button>[m
       </div>[m
[32m+[m[32m    </div>[m
 [m
[31m-      {/* Bill To + Vehicle */}[m
[31m-      <div[m
[32m+[m[32m    {/* V1 Actions (no Mark Draft / no Mark Sent) */}[m
[32m+[m[32m    <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap", marginBottom: "1rem" }}>[m
[32m+[m[32m      <button[m
[32m+[m[32m        type="button"[m
[32m+[m[32m        disabled={isSaving || isPaid || isVoid}[m
[32m+[m[32m        onClick={handleVoidInvoice}[m
         style={{[m
[31m-          display: "grid",[m
[31m-          gridTemplateColumns: "repeat(auto-fit, minmax(320px, 1fr))",[m
[31m-          gap: "1rem",[m
[31m-          marginBottom: "1rem",[m
[32m+[m[32m          border: "1px solid #dc2626",[m
[32m+[m[32m          color: "#dc2626",[m
[32m+[m[32m          background: "white",[m
         }}[m
[32m+[m[32m        title={isPaid ? "Paid invoices cannot be voided" : isVoid ? "Invoice is already void" : "Void this invoice"}[m
       >[m
[31m-        <div style={{ border: "1px solid #eee", borderRadius: "12px", padding: "1rem" }}>[m
[31m-          <h3 style={{ marginTop: 0 }}>Bill To</h3>[m
[31m-          <div>{customerName || "Unknown Customer"}</div>[m
[31m-          {invoice.customerSnapshot?.address ? <div>{invoice.customerSnapshot.address}</div> : null}[m
[31m-          {invoice.customerSnapshot?.phone ? <div>Phone: {invoice.customerSnapshot.phone}</div> : null}[m
[31m-          {truthEmail && <div>Email: {truthEmail}</div>} [m
[31m-          {emailMismatch && ([m
[31m-            <div style={{ fontSize: "0.85rem", color: "#6b7280" }}>[m
[31m-              On invoice: {snapshotEmail}[m
[31m-            </div>[m
[31m-          )}     [m
[31m-        </div>[m
[32m+[m[32m        Void Invoice[m
[32m+[m[32m      </button>[m
 [m
[31m-        <div style={{ border: "1px solid #eee", borderRadius: "12px", padding: "1rem" }}>[m
[31m-          <h3 style={{ marginTop: 0 }}>Vehicle</h3>[m
[31m-          {invoice.vehicleSnapshot ? ([m
[31m-            <>[m
[31m-              <div>[m
[31m-                {invoice.vehicleSnapshot.year} {invoice.vehicleSnapshot.make} {invoice.vehicleSnapshot.model}[m
[31m-              </div>[m
[31m-              {invoice.vehicleSnapshot.licensePlate ? <div>Plate: {invoice.vehicleSnapshot.licensePlate}</div> : null}[m
[31m-              {invoice.vehicleSnapshot.vin ? <div>VIN: {invoice.vehicleSnapshot.vin}</div> : null}[m
[31m-            </>[m
[31m-          ) : ([m
[31m-            <div style={{ color: "#6b7280" }}>No vehicle snapshot</div>[m
[31m-          )}[m
[31m-        </div>[m
[32m+[m[32m      {isReadOnly ? ([m
[32m+[m[32m        <span style={{ alignSelf: "center", fontSize: "0.9rem", color: "#6b7280" }}>[m
[32m+[m[32m          This invoice is read-only ({lifecycleRaw.toUpperCase()}).[m
[32m+[m[32m        </span>[m
[32m+[m[32m      ) : ([m
[32m+[m[32m        <span style={{ alignSelf: "center", fontSize: "0.9rem", color: "#6b7280" }}>[m
[32m+[m[32m          Draft invoice â€” editable until emailed/sent.[m
[32m+[m[32m        </span>[m
[32m+[m[32m      )}[m
[32m+[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    {/* Dates row */}[m
[32m+[m[32m    <div style={{ marginBottom: "1rem", fontSize: "0.95rem" }}>[m
[32m+[m[32m      <strong>Issue Date:</strong>{" "}[m
[32m+[m[32m      {invoice.issueDate ? new Date(invoice.issueDate).toLocaleDateString() : "â€”"}[m
[32m+[m[32m      {invoice.dueDate ? ([m
[32m+[m[32m        <>[m
[32m+[m[32m          {" "}[m
[32m+[m[32m          â€¢ <strong>Due Date:</strong> {new Date(invoice.dueDate).toLocaleDateString()}[m
[32m+[m[32m        </>[m
[32m+[m[32m      ) : null}[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    {/* Bill To + Vehicle */}[m
[32m+[m[32m    <div[m
[32m+[m[32m      style={{[m
[32m+[m[32m        display: "grid",[m
[32m+[m[32m        gridTemplateColumns: "repeat(auto-fit, minmax(320px, 1fr))",[m
[32m+[m[32m        gap: "1rem",[m
[32m+[m[32m        marginBottom: "1rem",[m
[32m+[m[32m      }}[m
[32m+[m[32m    >[m
[32m+[m[32m      <div style={{ border: "1px solid #eee", borderRadius: "12px", padding: "1rem" }}>[m
[32m+[m[32m        <h3 style={{ marginTop: 0 }}>Bill To</h3>[m
[32m+[m[32m        <div>{customerName || "Unknown Customer"}</div>[m
[32m+[m[32m        {invoice.customerSnapshot?.address ? <div>{invoice.customerSnapshot.address}</div> : null}[m
[32m+[m[32m        {invoice.customerSnapshot?.phone ? <div>Phone: {invoice.customerSnapshot.phone}</div> : null}[m
[32m+[m[32m        {truthEmail && <div>Email: {truthEmail}</div>}[m
[32m+[m[32m        {emailMismatch && ([m
[32m+[m[32m          <div style={{ fontSize: "0.85rem", color: "#6b7280" }}>[m
[32m+[m[32m            On invoice: {snapshotEmail}[m
[32m+[m[32m          </div>[m
[32m+[m[32m        )}[m
       </div>[m
 [m
[31m-      {/* Line items */}[m
[31m-      <div style={{ marginBottom: "1rem" }}>[m
[31m-        <h3>Line Items</h3>[m
[31m-        <table style={{ width: "100%", borderCollapse: "collapse", marginTop: "0.5rem" }}>[m
[31m-          <thead>[m
[31m-            <tr>[m
[31m-              <th style={{ textAlign: "left", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>[m
[31m-                Description[m
[31m-              </th>[m
[31m-              <th style={{ textAlign: "right", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>Qty</th>[m
[31m-              <th style={{ textAlign: "right", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>Unit</th>[m
[31m-              <th style={{ textAlign: "right", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>Total</th>[m
[31m-            </tr>[m
[31m-          </thead>[m
[31m-          <tbody>[m
[31m-            {invoice.lineItems?.map((item: any, idx: number) => ([m
[31m-              <tr key={idx}>[m
[31m-                <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee" }}>{item.description}</td>[m
[31m-                <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee", textAlign: "right" }}>[m
[31m-                  {item.quantity}[m
[31m-                </td>[m
[31m-                <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee", textAlign: "right" }}>[m
[31m-                  {Number(item.unitPrice ?? 0).toFixed(2)}[m
[31m-                </td>[m
[31m-                <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee", textAlign: "right" }}>[m
[31m-                  {Number(item.lineTotal ?? 0).toFixed(2)}[m
[31m-                </td>[m
[31m-              </tr>[m
[31m-            ))}[m
[31m-          </tbody>[m
[31m-        </table>[m
[32m+[m[32m      <div style={{ border: "1px solid #eee", borderRadius: "12px", padding: "1rem" }}>[m
[32m+[m[32m        <h3 style={{ marginTop: 0 }}>Vehicle</h3>[m
[32m+[m[32m        {invoice.vehicleSnapshot ? ([m
[32m+[m[32m          <>[m
[32m+[m[32m            <div>[m
[32m+[m[32m              {invoice.vehicleSnapshot.year} {invoice.vehicleSnapshot.make} {invoice.vehicleSnapshot.model}[m
[32m+[m[32m            </div>[m
[32m+[m[32m            {invoice.vehicleSnapshot.licensePlate ? <div>Plate: {invoice.vehicleSnapshot.licensePlate}</div> : null}[m
[32m+[m[32m            {invoice.vehicleSnapshot.vin ? <div>VIN: {invoice.vehicleSnapshot.vin}</div> : null}[m
[32m+[m[32m          </>[m
[32m+[m[32m        ) : ([m
[32m+[m[32m          <div style={{ color: "#6b7280" }}>No vehicle snapshot</div>[m
[32m+[m[32m        )}[m
       </div>[m
[32m+[m[32m    </div>[m
 [m
[31m-      {/* Totals */}[m
[31m-      <div style={{ marginTop: "1rem", textAlign: "right" }}>[m
[31m-        <div>Subtotal: {Number(invoice.subtotal ?? 0).toFixed(2)}</div>[m
[31m-        <div>[m
[31m-          Tax ({Number(invoice.taxRate ?? 0)}%): {Number(invoice.taxAmount ?? 0).toFixed(2)}[m
[31m-        </div>[m
[31m-        <div style={{ fontWeight: "bold", marginTop: "0.5rem" }}>[m
[31m-          Total: {Number(invoice.total ?? 0).toFixed(2)}[m
[31m-        </div>[m
[32m+[m[32m    {/* Line items */}[m
[32m+[m[32m    <div style={{ marginBottom: "1rem" }}>[m
[32m+[m[32m      <h3>Line Items</h3>[m
[32m+[m[32m      <table style={{ width: "100%", borderCollapse: "collapse", marginTop: "0.5rem" }}>[m
[32m+[m[32m        <thead>[m
[32m+[m[32m          <tr>[m
[32m+[m[32m            <th style={{ textAlign: "left", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>[m
[32m+[m[32m              Description[m
[32m+[m[32m            </th>[m
[32m+[m[32m            <th style={{ textAlign: "right", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>Qty</th>[m
[32m+[m[32m            <th style={{ textAlign: "right", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>Unit</th>[m
[32m+[m[32m            <th style={{ textAlign: "right", borderBottom: "1px solid #ccc", padding: "0.5rem" }}>Total</th>[m
[32m+[m[32m          </tr>[m
[32m+[m[32m        </thead>[m
[32m+[m[32m        <tbody>[m
[32m+[m[32m          {invoice.lineItems?.map((item: any, idx: number) => ([m
[32m+[m[32m            <tr key={idx}>[m
[32m+[m[32m              <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee" }}>{item.description}</td>[m
[32m+[m[32m              <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee", textAlign: "right" }}>[m
[32m+[m[32m                {item.quantity}[m
[32m+[m[32m              </td>[m
[32m+[m[32m              <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee", textAlign: "right" }}>[m
[32m+[m[32m                {Number(item.unitPrice ?? 0).toFixed(2)}[m
[32m+[m[32m              </td>[m
[32m+[m[32m              <td style={{ padding: "0.5rem", borderBottom: "1px solid #eee", textAlign: "right" }}>[m
[32m+[m[32m                {Number(item.lineTotal ?? 0).toFixed(2)}[m
[32m+[m[32m              </td>[m
[32m+[m[32m            </tr>[m
[32m+[m[32m          ))}[m
[32m+[m[32m        </tbody>[m
[32m+[m[32m      </table>[m
[32m+[m[32m    </div>[m
[32m+[m
[32m+[m[32m    {/* Totals */}[m
[32m+[m[32m    <div style={{ marginTop: "1rem", textAlign: "right" }}>[m
[32m+[m[32m      <div>Subtotal: {Number(invoice.subtotal ?? 0).toFixed(2)}</div>[m
[32m+[m[32m      <div>[m
[32m+[m[32m        Tax ({Number(invoice.taxRate ?? 0)}%): {Number(invoice.taxAmount ?? 0).toFixed(2)}[m
[32m+[m[32m      </div>[m
[32m+[m[32m      <div style={{ fontWeight: "bold", marginTop: "0.5rem" }}>[m
[32m+[m[32m        Total: {Number(invoice.total ?? 0).toFixed(2)}[m
       </div>[m
[32m+[m[32m    </div>[m
 [m
[31m-            {/* Payments */}[m
[32m+[m[32m    {/* Payments */}[m
     <div style={{ marginTop: "1.25rem", borderTop: "1px solid #eee", paddingTop: "1rem" }}>[m
       <h3 style={{ marginTop: 0 }}>Payments</h3>[m
 [m
       <div style={{ display: "flex", gap: "1.5rem", flexWrap: "wrap", marginBottom: "0.75rem" }}>[m
         <div>[m
           <div style={{ fontSize: "0.85rem", color: "#6b7280" }}>Paid to date</div>[m
[31m-          <div style={{ fontWeight: 600 }}>[m
[31m-            {Number((invoice as any).paidAmount ?? 0).toFixed(2)}[m
[31m-          </div>[m
[32m+[m[32m          <div style={{ fontWeight: 600 }}>{Number((invoice as any).paidAmount ?? 0).toFixed(2)}</div>[m
         </div>[m
 [m
         <div>[m
[36m@@ -542,19 +606,18 @@[m [mexport default function InvoiceDetailPage() {[m
           </div>[m
         </div>[m
 [m
[31m-       {statusRaw === "paid" && latestPaymentDate ? ([m
[31m-            <div>[m
[31m-              <div style={{ fontSize: "0.85rem", color: "#6b7280" }}>Date paid</div>[m
[31m-              <div style={{ fontWeight: 600 }}>{fmtDateTime(latestPaymentDate)}</div>[m
[31m-            </div>[m
[31m-          ) : null}[m
[31m-[m
[31m-            {statusRaw !== "paid" && paidAmountNum > 0 && balanceDueNum > 0 && latestPaymentDate ? ([m
[32m+[m[32m       {/* Date paid / Last payment (backend truth) */}[m
[32m+[m[32m            {isPaid && latestPaymentDate ? ([m
[32m+[m[32m              <div>[m
[32m+[m[32m                <div style={{ fontSize: "0.85rem", color: "#6b7280" }}>Date paid</div>[m
[32m+[m[32m                <div style={{ fontWeight: 600 }}>{fmtDateTime(latestPaymentDate)}</div>[m
[32m+[m[32m              </div>[m
[32m+[m[32m            ) : isPartial && latestPaymentDate ? ([m
               <div>[m
                 <div style={{ fontSize: "0.85rem", color: "#6b7280" }}>Last payment</div>[m
                 <div style={{ fontWeight: 600 }}>{fmtDateTime(latestPaymentDate)}</div>[m
               </div>[m
[31m-        ) : null}[m
[32m+[m[32m            ) : null}[m
 [m
       </div>[m
 [m
[36m@@ -579,7 +642,7 @@[m [mexport default function InvoiceDetailPage() {[m
 [m
       {/* Record payment form */}[m
       {(() => {[m
[31m-        const status = (invoice.status || "draft").toLowerCase();[m
[32m+[m[32m        const status = (invoice.financialStatus || "draft").toLowerCase();[m
         const locked = status === "draft" || status === "paid" || status === "void";[m
 [m
         return ([m
[36m@@ -649,15 +712,14 @@[m [mexport default function InvoiceDetailPage() {[m
       })()}[m
     </div>[m
 [m
[32m+[m[32m    {/* Notes */}[m
[32m+[m[32m    {invoice.notes ? ([m
[32m+[m[32m      <div style={{ marginTop: "1rem" }}>[m
[32m+[m[32m        <h3>Notes</h3>[m
[32m+[m[32m        <p>{invoice.notes}</p>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    ) : null}[m
[32m+[m[32m  </div>[m
[32m+[m[32m);[m
 [m
[31m-[m
[31m-      {/* Notes */}[m
[31m-      {invoice.notes ? ([m
[31m-        <div style={{ marginTop: "1rem" }}>[m
[31m-          <h3>Notes</h3>[m
[31m-          <p>{invoice.notes}</p>[m
[31m-        </div>[m
[31m-      ) : null}[m
[31m-    </div>[m
[31m-  );[m
 }[m
[1mdiff --git a/frontend/src/pages/WorkOrderDetailPage.tsx b/frontend/src/pages/WorkOrderDetailPage.tsx[m
[1mindex 73ecf8f..d43a537 100644[m
[1m--- a/frontend/src/pages/WorkOrderDetailPage.tsx[m
[1m+++ b/frontend/src/pages/WorkOrderDetailPage.tsx[m
[36m@@ -10,17 +10,11 @@[m [mimport {[m
 } from "../api/workOrders";[m
 import type { WorkOrder, WorkOrderLineItem } from "../types/workOrder";[m
 [m
[32m+[m[32mconst markWorkOrderComplete = (id: string) => updateWorkOrderStatus(id, "completed");[m
 [m
[32m+[m[32mexport const INVOICE_ENABLED = import.meta.env.VITE_INVOICE_ENABLED === "true";[m
 [m
[31m-[m
[31m-[m
[31m-const markWorkOrderComplete = (id: string) =>[m
[31m-  updateWorkOrderStatus(id, "completed");[m
[31m-[m
[31m-export const INVOICE_ENABLED =[m
[31m-  import.meta.env.VITE_INVOICE_ENABLED === "true";[m
[31m-[m
[31m-  type TimelineItem = {[m
[32m+[m[32mtype TimelineItem = {[m
   label: string;[m
   date?: string | Date | null;[m
   done: boolean;[m
[36m@@ -90,6 +84,22 @@[m [mfunction TimelineBlock({ items }: { items: TimelineItem[] }) {[m
   );[m
 }[m
 [m
[32m+[m[32m// âœ… Canonical invoice id resolver (truth: if invoice exists, we can view it)[m
[32m+[m[32mfunction resolveInvoiceIdFromWorkOrder(wo: any): string | null {[m
[32m+[m[32m  if (!wo) return null;[m
[32m+[m
[32m+[m[32m  const inv: any = wo?.invoice ?? wo?.invoiceId ?? null;[m
[32m+[m[32m  if (!inv) return null;[m
[32m+[m
[32m+[m[32m  if (typeof inv === "string") return inv;[m
[32m+[m
[32m+[m[32m  if (typeof inv === "object") {[m
[32m+[m[32m    if (typeof inv._id === "string") return inv._id;[m
[32m+[m[32m    if (inv._id && typeof inv._id.toString === "function") return inv._id.toString();[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  return null;[m
[32m+[m[32m}[m
 [m
 export default function WorkOrderDetailPage() {[m
   const { id } = useParams<{ id: string }>();[m
[36m@@ -120,7 +130,6 @@[m [mexport default function WorkOrderDetailPage() {[m
       setLoading(true);[m
       setError(null);[m
       const data = await fetchWorkOrder(id);[m
[31m-      console.log("[WO Detail] Loaded work order:", data);[m
       setWorkOrder(data);[m
     } catch (err) {[m
       console.error("[WO Detail] Failed to load work order", err);[m
[36m@@ -130,93 +139,69 @@[m [mexport default function WorkOrderDetailPage() {[m
     }[m
   }[m
 [m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    loadWorkOrder();[m
[32m+[m[32m    // eslint-disable-next-line react-hooks/exhaustive-deps[m
[32m+[m[32m  }, [id]);[m
 [m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    if (!workOrder) return;[m
 [m
[31m-        useEffect(() => {[m
[31m-          loadWorkOrder();[m
[31m-          // eslint-disable-next-line react-hooks/exhaustive-deps[m
[31m-        }, [id]);[m
[31m-[m
[31m-        useEffect(() => {[m
[31m-              if (!workOrder) return;[m
[31m-[m
[31m-              // Don't overwrite local edits with server data while dirty[m
[31m-              if (!hasUnsavedChanges) {[m
[31m-                setLineItems(workOrder.lineItems ?? []);[m
[31m-                setTaxRate(workOrder.taxRate ?? 13);[m
[31m-              } else {[m
[31m-                // keep taxRate in sync if you want, optional:[m
[31m-                // setTaxRate((prev) => prev ?? (workOrder.taxRate ?? 13));[m
[31m-              }[m
[31m-            }, [workOrder, hasUnsavedChanges]);[m
[31m-[m
[31m-[m
[31m-  async function applyStatus([m
[31m-        nextStatus: "in_progress" | "on_hold" | "completed" | "invoiced"[m
[31m-      ) {[m
[31m-        if (!workOrder?._id) return;[m
[31m-[m
[31m-        try {[m
[31m-          setActionError(null);[m
[31m-          await updateWorkOrderStatus(workOrder._id, nextStatus);[m
[31m-[m
[31m-          // refresh so timestamps/status are up-to-date[m
[31m-          const refreshed = await fetchWorkOrder(workOrder._id);[m
[31m-          setWorkOrder(refreshed);[m
[31m-        } catch (err: any) {[m
[31m-          console.error(err);[m
[31m-          setActionError(err.message || "Failed to update status");[m
[31m-        }[m
[31m-      }[m
[31m-[m
[32m+[m[32m    // Don't overwrite local edits with server data while dirty[m
[32m+[m[32m    if (!hasUnsavedChanges) {[m
[32m+[m[32m      setLineItems(workOrder.lineItems ?? []);[m
[32m+[m[32m      setTaxRate(workOrder.taxRate ?? 13);[m
[32m+[m[32m    }[m
[32m+[m[32m  }, [workOrder, hasUnsavedChanges]);[m
 [m
[31m-  [m
[31m-const handleStartWork = async () => {[m
[31m-  if (hasUnsavedChanges) {[m
[31m-    const saveThenStart = window.confirm([m
[31m-      "You have unsaved line items.\n\n" +[m
[31m-        "Click OK to SAVE and START.\n" +[m
[31m-        "Click Cancel to stay here."[m
[31m-    );[m
[32m+[m[32m  async function applyStatus(nextStatus: "in_progress" | "on_hold" | "completed" | "invoiced") {[m
[32m+[m[32m    if (!workOrder?._id) return;[m
 [m
[31m-    if (!saveThenStart) return;[m
[32m+[m[32m    try {[m
[32m+[m[32m      setActionError(null);[m
[32m+[m[32m      await updateWorkOrderStatus(workOrder._id, nextStatus);[m
 [m
[31m-    await handleSaveLineItems();[m
[32m+[m[32m      // refresh so timestamps/status are up-to-date[m
[32m+[m[32m      const refreshed = await fetchWorkOrder(workOrder._id);[m
[32m+[m[32m      setWorkOrder(refreshed);[m
[32m+[m[32m    } catch (err: any) {[m
[32m+[m[32m      console.error(err);[m
[32m+[m[32m      setActionError(err.message || "Failed to update status");[m
[32m+[m[32m    }[m
   }[m
 [m
[31m-  await applyStatus("in_progress");[m
[31m-};[m
[31m-[m
[31m-[m
[31m-const handlePauseWork = async () => {[m
[31m-  if (hasUnsavedChanges) {[m
[31m-    const saveThenPause = window.confirm([m
[31m-      "You have unsaved line items.\n\n" +[m
[31m-        "Click OK to SAVE and PAUSE.\n" +[m
[31m-        "Click Cancel to stay here."[m
[31m-    );[m
[32m+[m[32m  const handleStartWork = async () => {[m
[32m+[m[32m    if (hasUnsavedChanges) {[m
[32m+[m[32m      const saveThenStart = window.confirm([m
[32m+[m[32m        "You have unsaved line items.\n\n" + "Click OK to SAVE and START.\n" + "Click Cancel to stay here."[m
[32m+[m[32m      );[m
[32m+[m[32m      if (!saveThenStart) return;[m
[32m+[m[32m      await handleSaveLineItems();[m
[32m+[m[32m    }[m
 [m
[31m-    if (!saveThenPause) return;[m
[32m+[m[32m    await applyStatus("in_progress");[m
[32m+[m[32m  };[m
 [m
[31m-    // Save line items first (so nothing gets lost)[m
[31m-    await handleSaveLineItems();[m
[31m-  }[m
[32m+[m[32m  const handlePauseWork = async () => {[m
[32m+[m[32m    if (hasUnsavedChanges) {[m
[32m+[m[32m      const saveThenPause = window.confirm([m
[32m+[m[32m        "You have unsaved line items.\n\n" + "Click OK to SAVE and PAUSE.\n" + "Click Cancel to stay here."[m
[32m+[m[32m      );[m
[32m+[m[32m      if (!saveThenPause) return;[m
[32m+[m[32m      await handleSaveLineItems();[m
[32m+[m[32m    }[m
 [m
[31m-  if (hasUnsavedChanges) {[m
[32m+[m[32m    if (hasUnsavedChanges) {[m
       // discard draft by reloading from backend truth[m
       await loadWorkOrder();[m
       setHasUnsavedChanges(false);[m
     }[m
 [m
[31m-  await applyStatus("on_hold");[m
[31m-};[m
[31m-[m
[32m+[m[32m    await applyStatus("on_hold");[m
[32m+[m[32m  };[m
 [m
   // Derive customer + display name from the loaded work order[m
[31m-  const customer =[m
[31m-    (workOrder as any)?.customerId ??[m
[31m-    (workOrder as any)?.customer ??[m
[31m-    null;[m
[32m+[m[32m  const customer = (workOrder as any)?.customerId ?? (workOrder as any)?.customer ?? null;[m
 [m
   const displayName =[m
     customer?.name ||[m
[36m@@ -238,20 +223,17 @@[m [mconst handlePauseWork = async () => {[m
       setIsMarkingComplete(true);[m
       setActionError(null);[m
 [m
[31m-      console.log("[WO Detail] Marking complete:", workOrder._id);[m
[31m-[m
       // COMPLETE[m
[31m-        if (hasUnsavedChanges) {[m
[31m-          await handleSaveLineItems();[m
[31m-        }[m
[31m-[m
[31m-        await markWorkOrderComplete(workOrder._id);[m
[32m+[m[32m      if (hasUnsavedChanges) {[m
[32m+[m[32m        await handleSaveLineItems();[m
[32m+[m[32m      }[m
 [m
[31m-        // âœ… reload from your GET /work-orders/:id (which is the â€œfull truthâ€)[m
[31m-        await loadWorkOrder();[m
[32m+[m[32m      await markWorkOrderComplete(workOrder._id);[m
 [m
[31m-        alert("âœ… Work order marked complete!");[m
[32m+[m[32m      // âœ… reload from backend truth[m
[32m+[m[32m      await loadWorkOrder();[m
 [m
[32m+[m[32m      alert("âœ… Work order marked complete!");[m
     } catch (err: any) {[m
       console.error("[WO Detail] Failed to mark complete", err);[m
       setActionError(err.message || "Could not mark work order complete.");[m
[36m@@ -262,35 +244,32 @@[m [mconst handlePauseWork = async () => {[m
 [m
   // ðŸ’¸ Create Invoice (feature-flagged)[m
   async function handleCreateInvoice() {[m
[31m-                if (!workOrder || !workOrder._id) return;[m
[31m-[m
[31m-                try {[m
[31m-                      setIsCreatingInvoice(true);[m
[31m-                      setError(null);[m
[31m-[m
[31m-                      console.log("[WO Detail] Creating invoice for:", workOrder._id);[m
[32m+[m[32m    if (!workOrder || !workOrder._id) return;[m
 [m
[31m-                        const result = await createInvoiceFromWorkOrder(workOrder._id, {[m
[31m-                          notes: workOrder.notes ?? undefined,[m
[31m-                        });[m
[32m+[m[32m    try {[m
[32m+[m[32m      setIsCreatingInvoice(true);[m
[32m+[m[32m      setError(null);[m
 [m
[31m-                        const invoice = (result as any).invoice ?? result;[m
[31m-                        const invoiceLabel = invoice.invoiceNumber ?? invoice._id;[m
[32m+[m[32m      const result = await createInvoiceFromWorkOrder(workOrder._id, {[m
[32m+[m[32m        notes: workOrder.notes ?? undefined,[m
[32m+[m[32m      });[m
 [m
[31m-                        alert([m
[31m-                          (result as any).alreadyExists[m
[31m-                            ? `â„¹ï¸ Invoice #${invoiceLabel} already exists â€” opening it.`[m
[31m-                            : `âœ… Invoice #${invoiceLabel} created.`[m
[31m-                        );[m
[32m+[m[32m      const invoice = (result as any).invoice ?? result;[m
[32m+[m[32m      const invoiceLabel = invoice.invoiceNumber ?? invoice._id;[m
 [m
[31m-                        navigate(`/invoices/${invoice._id}`);[m
[32m+[m[32m      alert([m
[32m+[m[32m        (result as any).alreadyExists[m
[32m+[m[32m          ? `â„¹ï¸ Invoice #${invoiceLabel} already exists â€” opening it.`[m
[32m+[m[32m          : `âœ… Invoice #${invoiceLabel} created.`[m
[32m+[m[32m      );[m
 [m
[31m-                } catch (err) {[m
[31m-                  console.error("[WO Detail] Error creating invoice", err);[m
[31m-                  setError("Failed to create invoice.");[m
[31m-                } finally {[m
[31m-                  setIsCreatingInvoice(false);[m
[31m-                }[m
[32m+[m[32m      navigate(`/invoices/${invoice._id}`);[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m      console.error("[WO Detail] Error creating invoice", err);[m
[32m+[m[32m      setError("Failed to create invoice.");[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setIsCreatingInvoice(false);[m
[32m+[m[32m    }[m
   }[m
 [m
   // ðŸ”¢ Helpers for line items[m
[36m@@ -344,22 +323,21 @@[m [mconst handlePauseWork = async () => {[m
     setHasUnsavedChanges(true);[m
   };[m
 [m
[31m-const handleAddLineItem = () => {[m
[31m-  setLineItems((prev) => [[m
[31m-    ...prev,[m
[31m-    {[m
[31m-      type: "labour",[m
[31m-      description: "",[m
[31m-      quantity: 1,[m
[31m-      unitPrice: 0,[m
[31m-      lineTotal: 1 * 0,[m
[31m-      rawQuantity: "1",[m
[31m-      rawUnitPrice: "0",[m
[31m-    } as any,[m
[31m-  ]);[m
[31m-  setHasUnsavedChanges(true);[m
[31m-};[m
[31m-[m
[32m+[m[32m  const handleAddLineItem = () => {[m
[32m+[m[32m    setLineItems((prev) => [[m
[32m+[m[32m      ...prev,[m
[32m+[m[32m      {[m
[32m+[m[32m        type: "labour",[m
[32m+[m[32m        description: "",[m
[32m+[m[32m        quantity: 1,[m
[32m+[m[32m        unitPrice: 0,[m
[32m+[m[32m        lineTotal: 1 * 0,[m
[32m+[m[32m        rawQuantity: "1",[m
[32m+[m[32m        rawUnitPrice: "0",[m
[32m+[m[32m      } as any,[m
[32m+[m[32m    ]);[m
[32m+[m[32m    setHasUnsavedChanges(true);[m
[32m+[m[32m  };[m
 [m
   const handleRemoveLineItem = (index: number) => {[m
     setLineItems((prev) => prev.filter((_, i) => i !== index));[m
[36m@@ -370,63 +348,49 @@[m [mconst handleAddLineItem = () => {[m
     ? lineItems.map((item) => {[m
         const quantity = Number(item?.quantity) || 0;[m
         const unitPrice = Number(item?.unitPrice) || 0;[m
[31m-        const lineTotal =[m
[31m-          typeof item?.lineTotal === "number"[m
[31m-            ? item.lineTotal[m
[31m-            : quantity * unitPrice;[m
[32m+[m[32m        const lineTotal = typeof item?.lineTotal === "number" ? item.lineTotal : quantity * unitPrice;[m
         return {[m
           ...item,[m
           type: item?.type ?? "labour",[m
           description: item?.description ?? "",[m
           rawQuantity:[m
             item?.rawQuantity ??[m
[31m-            (item?.quantity !== undefined && item?.quantity !== null[m
[31m-              ? String(item.quantity)[m
[31m-              : ""),[m
[32m+[m[32m            (item?.quantity !== undefined && item?.quantity !== null ? String(item.quantity) : ""),[m
           rawUnitPrice:[m
             item?.rawUnitPrice ??[m
[31m-            (item?.unitPrice !== undefined && item?.unitPrice !== null[m
[31m-              ? String(item.unitPrice)[m
[31m-              : ""),[m
[32m+[m[32m            (item?.unitPrice !== undefined && item?.unitPrice !== null ? String(item.unitPrice) : ""),[m
           quantity,[m
           unitPrice,[m
           lineTotal,[m
         };[m
[31m-    })[m
[32m+[m[32m      })[m
     : [];[m
 [m
[31m-// Live totals[m
[31m-const computedSubtotal = normalizedLineItems.reduce([m
[31m-  (sum, item) => sum + (item.lineTotal || 0),[m
[31m-  0[m
[31m-);[m
[31m-[m
[31m-const taxRateToUse =[m
[31m-  typeof taxRate === "number" && !Number.isNaN(taxRate) ? taxRate : 13;[m
[32m+[m[32m  // Live totals[m
[32m+[m[32m  const computedSubtotal = normalizedLineItems.reduce((sum, item) => sum + (item.lineTotal || 0), 0);[m
 [m
[31m-const computedTaxAmount = computedSubtotal * (taxRateToUse / 100);[m
[31m-const computedTotal = computedSubtotal + computedTaxAmount;[m
[32m+[m[32m  const taxRateToUse = typeof taxRate === "number" && !Number.isNaN(taxRate) ? taxRate : 13;[m
 [m
[31m-// Saved totals (from backend)[m
[31m-const savedSubtotal = typeof workOrder?.subtotal === "number" ? workOrder.subtotal : computedSubtotal;[m
[31m-const savedTaxAmount = typeof workOrder?.taxAmount === "number" ? workOrder.taxAmount : computedTaxAmount;[m
[31m-const savedTotal = typeof workOrder?.total === "number" ? workOrder.total : computedTotal;[m
[32m+[m[32m  const computedTaxAmount = computedSubtotal * (taxRateToUse / 100);[m
[32m+[m[32m  const computedTotal = computedSubtotal + computedTaxAmount;[m
 [m
[31m-// âœ… Display totals:[m
[31m-// - If user has unsaved changes â†’ show computed (live)[m
[31m-// - Otherwise â†’ show saved (authoritative)[m
[31m-const displaySubtotal = hasUnsavedChanges ? computedSubtotal : savedSubtotal;[m
[31m-const displayTaxAmount = hasUnsavedChanges ? computedTaxAmount : savedTaxAmount;[m
[31m-const displayTotal = hasUnsavedChanges ? computedTotal : savedTotal;[m
[32m+[m[32m  // Saved totals (from backend)[m
[32m+[m[32m  const savedSubtotal = typeof workOrder?.subtotal === "number" ? workOrder.subtotal : computedSubtotal;[m
[32m+[m[32m  const savedTaxAmount = typeof workOrder?.taxAmount === "number" ? workOrder.taxAmount : computedTaxAmount;[m
[32m+[m[32m  const savedTotal = typeof workOrder?.total === "number" ? workOrder.total : computedTotal;[m
 [m
[32m+[m[32m  // âœ… Display totals:[m
[32m+[m[32m  // - If user has unsaved changes â†’ show computed (live)[m
[32m+[m[32m  // - Otherwise â†’ show saved (authoritative)[m
[32m+[m[32m  const displaySubtotal = hasUnsavedChanges ? computedSubtotal : savedSubtotal;[m
[32m+[m[32m  const displayTaxAmount = hasUnsavedChanges ? computedTaxAmount : savedTaxAmount;[m
[32m+[m[32m  const displayTotal = hasUnsavedChanges ? computedTotal : savedTotal;[m
 [m
   const handleSaveLineItems = async () => {[m
     if (!workOrder?._id) return;[m
     setSaving(true);[m
     try {[m
[31m-      const payloadLineItems = normalizedLineItems.map([m
[31m-        ({ rawQuantity, rawUnitPrice, ...rest }) => rest[m
[31m-      );[m
[32m+[m[32m      const payloadLineItems = normalizedLineItems.map(({ rawQuantity, rawUnitPrice, ...rest }) => rest);[m
 [m
       await updateWorkOrder(workOrder._id, {[m
         lineItems: payloadLineItems,[m
[36m@@ -434,10 +398,8 @@[m [mconst displayTotal = hasUnsavedChanges ? computedTotal : savedTotal;[m
       } as any);[m
 [m
       await loadWorkOrder();[m
[31m-[m
       setHasUnsavedChanges(false);[m
 [m
[31m-[m
       alert("âœ… Line items saved.");[m
     } catch (err) {[m
       console.error(err);[m
[36m@@ -473,141 +435,258 @@[m [mconst displayTotal = hasUnsavedChanges ? computedTotal : savedTotal;[m
   if (error) return <p className="text-red-600">{error}</p>;[m
   if (!workOrder) return <p>Work order not found.</p>;[m
 [m
[31m-// ----------------------[m
[31m-// Status + flags (single source of truth)[m
[31m-// ----------------------[m
[31m-const rawStatus = (workOrder.status || "").toLowerCase().trim();[m
[31m-[m
[31m-const isOpen = rawStatus === "open";[m
[31m-const isInProgress = rawStatus === "in_progress";[m
[31m-const isOnHold = rawStatus === "on_hold";[m
[31m-const isCancelled = rawStatus === "cancelled";[m
[31m-const isCompleted = rawStatus === "completed" || rawStatus === "complete";[m
[31m-const isInvoiced = rawStatus === "invoiced";[m
[31m-[m
[31m-const hasInvoice = !!workOrder.invoiceId;[m
[31m-[m
[31m-// ----------------------[m
[31m-// Timeline timestamps (safe fallbacks)[m
[31m-// NOTE: adjust field names if your backend uses different ones[m
[31m-// ----------------------[m
[31m-const startedAt = (workOrder as any)?.startedAt ?? null;[m
[31m-const onHoldAt =[m
[31m-  (workOrder as any)?.pausedAt ??[m
[31m-  (workOrder as any)?.onHoldAt ??[m
[31m-  null;[m
[31m-const completedAt = (workOrder as any)?.completedAt ?? null;[m
[31m-const invoicedAt = (workOrder as any)?.invoicedAt ?? null;[m
[31m-[m
[31m-const timelineItems: TimelineItem[] = [[m
[31m-  {[m
[31m-    label: "Started",[m
[31m-    date: startedAt,[m
[31m-    done: !!startedAt || isInProgress || isOnHold || isCompleted || isInvoiced,[m
[31m-  },[m
[31m-  {[m
[31m-    label: "On Hold",[m
[31m-    date: onHoldAt,[m
[31m-    done: !!onHoldAt || isOnHold,[m
[31m-  },[m
[31m-  {[m
[31m-    label: "Completed",[m
[31m-    date: completedAt,[m
[31m-    done: !!completedAt || isCompleted || isInvoiced,[m
[31m-  },[m
[31m-  {[m
[31m-    label: "Invoiced",[m
[31m-    date: invoicedAt,[m
[31m-    done: !!invoicedAt || isInvoiced,[m
[31m-  },[m
[31m-];[m
[31m-[m
[31m-[m
[31m-[m
[31m-let statusLabel = "OPEN";[m
[31m-let statusBg = "#fee2e2";[m
[31m-let statusBorder = "#b91c1c";[m
[31m-let statusColor = "#b91c1c";[m
[31m-[m
[31m-if (isInvoiced) {[m
[31m-  statusLabel = "INVOICED";[m
[31m-  statusBg = "#dbeafe";[m
[31m-  statusBorder = "#1d4ed8";[m
[31m-  statusColor = "#1d4ed8";[m
[31m-} else if (isCompleted) {[m
[31m-  statusLabel = "COMPLETED";[m
[31m-  statusBg = "#dcfce7";[m
[31m-  statusBorder = "#16a34a";[m
[31m-  statusColor = "#166534";[m
[31m-} else if (isOnHold) {[m
[31m-  statusLabel = "ON HOLD";[m
[31m-  statusBg = "#ffedd5";[m
[31m-  statusBorder = "#c2410c";[m
[31m-  statusColor = "#9a3412";[m
[31m-} else if (isInProgress) {[m
[31m-  statusLabel = "IN PROGRESS";[m
[31m-  statusBg = "#fef9c3";[m
[31m-  statusBorder = "#a16207";[m
[31m-  statusColor = "#854d0e";[m
[31m-} else if (isCancelled) {[m
[31m-  statusLabel = "CANCELLED";[m
[31m-  statusBg = "#e5e7eb";[m
[31m-  statusBorder = "#6b7280";[m
[31m-  statusColor = "#374151";[m
[31m-} [m
[31m- [m
[31m-  const canCreateInvoice =[m
[31m-    INVOICE_ENABLED && isCompleted && !hasInvoice && !isCreatingInvoice;[m
[31m-[m
[31m-  console.log("[WO Detail] workOrder object:", workOrder);[m
[31m-[m
[31m-  const formattedDate = workOrder.date[m
[31m-    ? new Date(workOrder.date).toLocaleDateString()[m
[31m-    : "";[m
[31m-[m
[31m-  [m
[31m-const resolvedInvoiceId = (() => {[m
[31m-  const inv: any = (workOrder as any)?.invoice ?? (workOrder as any)?.invoiceId;[m
[31m-  if (!inv) return null;[m
[31m-[m
[31m-  if (typeof inv === "string") return inv;[m
[31m-  if (typeof inv === "object") {[m
[31m-    if (typeof inv._id === "string") return inv._id;[m
[31m-    if (inv._id && typeof inv._id.toString === "function") return inv._id.toString();[m
[32m+[m[32m  // ----------------------[m
[32m+[m[32m  // Canonical invoice truth[m
[32m+[m[32m  // ----------------------[m
[32m+[m[32m  const resolvedInvoiceId = resolveInvoiceIdFromWorkOrder(workOrder);[m
[32m+[m[32m  const hasInvoice = !!resolvedInvoiceId;[m
[32m+[m
[32m+[m[32m  // ----------------------[m
[32m+[m[32m  // Work order status truth (with invoice-safe normalization)[m
[32m+[m[32m  // ----------------------[m
[32m+[m[32m  const rawStatus = (workOrder.status || "").toLowerCase().trim();[m
[32m+[m
[32m+[m[32m  const isOpen = rawStatus === "open";[m
[32m+[m[32m  const isInProgress = rawStatus === "in_progress";[m
[32m+[m[32m  const isOnHold = rawStatus === "on_hold";[m
[32m+[m[32m  const isCancelled = rawStatus === "cancelled";[m
[32m+[m[32m  const isCompleted = rawStatus === "completed" || rawStatus === "complete";[m
[32m+[m
[32m+[m[32m  // âœ… Truth: if invoice exists, treat as invoiced in UI even if status string lags[m
[32m+[m[32m  const isInvoiced = rawStatus === "invoiced" || hasInvoice;[m
[32m+[m
[32m+[m[32m  // ----------------------[m
[32m+[m[32m  // Timeline timestamps (safe fallbacks)[m
[32m+[m[32m  // ----------------------[m
[32m+[m[32m  const startedAt = (workOrder as any)?.startedAt ?? null;[m
[32m+[m[32m  const onHoldAt = (workOrder as any)?.pausedAt ?? (workOrder as any)?.onHoldAt ?? null;[m
[32m+[m[32m  const completedAt = (workOrder as any)?.completedAt ?? null;[m
[32m+[m[32m  const invoicedAt = (workOrder as any)?.invoicedAt ?? (hasInvoice ? (workOrder as any)?.updatedAt ?? null : null);[m
[32m+[m
[32m+[m[32m  const timelineItems: TimelineItem[] = [[m
[32m+[m[32m    {[m
[32m+[m[32m      label: "Started",[m
[32m+[m[32m      date: startedAt,[m
[32m+[m[32m      done: !!startedAt || isInProgress || isOnHold || isCompleted || isInvoiced,[m
[32m+[m[32m    },[m
[32m+[m[32m    {[m
[32m+[m[32m      label: "On Hold",[m
[32m+[m[32m      date: onHoldAt,[m
[32m+[m[32m      done: !!onHoldAt || isOnHold,[m
[32m+[m[32m    },[m
[32m+[m[32m    {[m
[32m+[m[32m      label: "Completed",[m
[32m+[m[32m      date: completedAt,[m
[32m+[m[32m      done: !!completedAt || isCompleted || isInvoiced,[m
[32m+[m[32m    },[m
[32m+[m[32m    {[m
[32m+[m[32m      label: "Invoiced",[m
[32m+[m[32m      date: invoicedAt,[m
[32m+[m[32m      done: isInvoiced,[m
[32m+[m[32m    },[m
[32m+[m[32m  ];[m
[32m+[m
[32m+[m[32m  let statusLabel = "OPEN";[m
[32m+[m[32m  let statusBg = "#fee2e2";[m
[32m+[m[32m  let statusBorder = "#b91c1c";[m
[32m+[m[32m  let statusColor = "#b91c1c";[m
[32m+[m
[32m+[m[32m  if (isInvoiced) {[m
[32m+[m[32m    statusLabel = "INVOICED";[m
[32m+[m[32m    statusBg = "#dbeafe";[m
[32m+[m[32m    statusBorder = "#1d4ed8";[m
[32m+[m[32m    statusColor = "#1d4ed8";[m
[32m+[m[32m  } else if (isCompleted) {[m
[32m+[m[32m    statusLabel = "COMPLETED";[m
[32m+[m[32m    statusBg = "#dcfce7";[m
[32m+[m[32m    statusBorder = "#16a34a";[m
[32m+[m[32m    statusColor = "#166534";[m
[32m+[m[32m  } else if (isOnHold) {[m
[32m+[m[32m    statusLabel = "ON HOLD";[m
[32m+[m[32m    statusBg = "#ffedd5";[m
[32m+[m[32m    statusBorder = "#c2410c";[m
[32m+[m[32m    statusColor = "#9a3412";[m
[32m+[m[32m  } else if (isInProgress) {[m
[32m+[m[32m    statusLabel = "IN PROGRESS";[m
[32m+[m[32m    statusBg = "#fef9c3";[m
[32m+[m[32m    statusBorder = "#a16207";[m
[32m+[m[32m    statusColor = "#854d0e";[m
[32m+[m[32m  } else if (isCancelled) {[m
[32m+[m[32m    statusLabel = "CANCELLED";[m
[32m+[m[32m    statusBg = "#e5e7eb";[m
[32m+[m[32m    statusBorder = "#6b7280";[m
[32m+[m[32m    statusColor = "#374151";[m
   }[m
[31m-  return null;[m
[31m-})();[m
[31m-[m
[31m-  [m
 [m
[32m+[m[32m  // âœ… Create invoice only when completed and no invoice exists[m
[32m+[m[32m  const canCreateInvoice = INVOICE_ENABLED && isCompleted && !hasInvoice && !isCreatingInvoice;[m
 [m
[32m+[m[32m  const formattedDate = workOrder.date ? new Date(workOrder.date).toLocaleDateString() : "";[m
 [m
   return ([m
[31m-    <div className="page" style={{ padding: "16px" }}>[m
[31m-      {/* HEADER */}[m
[31m-      <header[m
[32m+[m[32m    <div style={{ padding: "1.5rem", maxWidth: "900px", margin: "0 auto" }}>[m
[32m+[m[32m      {/* HEADER (InvoiceDetail pattern) */}[m
[32m+[m[32m      <div[m
         style={{[m
           display: "flex",[m
[31m-          flexDirection: "column",[m
[31m-          gap: "4px",[m
[31m-          marginBottom: "16px",[m
[32m+[m[32m          justifyContent: "space-between",[m
[32m+[m[32m          alignItems: "flex-start",[m
[32m+[m[32m          gap: "1rem",[m
[32m+[m[32m          marginBottom: "1rem",[m
         }}[m
       >[m
[31m-        <h1 style={{ margin: 0 }}>Work Order Detail</h1>[m
[32m+[m[32m        {/* Left: Title + meta + status */}[m
[32m+[m[32m        <div style={{ flex: 1 }}>[m
[32m+[m[32m          <h1 style={{ margin: 0, fontSize: "2rem", lineHeight: 1.15 }}>[m
[32m+[m[32m            Work Order #{workOrder._id.slice(-6)}[m
[32m+[m[32m          </h1>[m
[32m+[m
[32m+[m[32m          <div style={{ marginTop: "0.35rem", color: "#9ca3af", fontWeight: 600, fontSize: "0.95rem" }}>[m
[32m+[m[32m            Created {formattedDate || "â€”"}[m
[32m+[m[32m          </div>[m
 [m
[31m-        <p[m
[31m-          style={{[m
[31m-            margin: 0,[m
[31m-            fontSize: "0.9rem",[m
[31m-            color: "#555",[m
[31m-          }}[m
[31m-        >[m
[31m-          Work Order #{workOrder._id.slice(-6)}[m
[31m-          {formattedDate && <> â€¢ {formattedDate}</>}[m
[31m-        </p>[m
[31m-      </header>[m
[32m+[m[32m          <div style={{ marginTop: "0.6rem", display: "flex", gap: "0.75rem", alignItems: "center", flexWrap: "wrap" }}>[m
[32m+[m[32m            {/* Status pill */}[m
[32m+[m[32m            <span[m
[32m+[m[32m              style={{[m
[32m+[m[32m                padding: "0.35rem 0.85rem",[m
[32m+[m[32m                borderRadius: "999px",[m
[32m+[m[32m                border: `2px solid ${statusBorder}`,[m
[32m+[m[32m                background: statusBg,[m
[32m+[m[32m                color: statusColor,[m
[32m+[m[32m                fontSize: "0.85rem",[m
[32m+[m[32m                fontWeight: 800,[m
[32m+[m[32m                textTransform: "uppercase",[m
[32m+[m[32m                letterSpacing: "0.08em",[m
[32m+[m[32m                whiteSpace: "nowrap",[m
[32m+[m[32m                boxShadow: "0 1px 0 rgba(0,0,0,0.10)",[m
[32m+[m[32m              }}[m
[32m+[m[32m            >[m
[32m+[m[32m              {statusLabel}[m
[32m+[m[32m            </span>[m
 [m
[31m-      {/* Optional UI-level error for actions like Mark Complete */}[m
[32m+[m[32m            {/* START / PAUSE / RESUME buttons */}[m
[32m+[m[32m            {!isCompleted && !isInvoiced && !isCancelled && ([m
[32m+[m[32m              <>[m
[32m+[m[32m                {(isOpen || isOnHold) && ([m
[32m+[m[32m                  <button[m
[32m+[m[32m                    type="button"[m
[32m+[m[32m                    onClick={handleStartWork}[m
[32m+[m[32m                    style={{[m
[32m+[m[32m                      padding: "0.4rem 0.9rem",[m
[32m+[m[32m                      borderRadius: "999px",[m
[32m+[m[32m                      border: "1px solid #16a34a",[m
[32m+[m[32m                      background: "#16a34a",[m
[32m+[m[32m                      color: "#ffffff",[m
[32m+[m[32m                      fontSize: "0.85rem",[m
[32m+[m[32m                      fontWeight: 700,[m
[32m+[m[32m                      letterSpacing: "0.05em",[m
[32m+[m[32m                      textTransform: "uppercase",[m
[32m+[m[32m                      cursor: "pointer",[m
[32m+[m[32m                    }}[m
[32m+[m[32m                  >[m
[32m+[m[32m                    {isOnHold ? "RESUME" : "START"}[m
[32m+[m[32m                  </button>[m
[32m+[m[32m                )}[m
[32m+[m
[32m+[m[32m                {isInProgress && ([m
[32m+[m[32m                  <button[m
[32m+[m[32m                    type="button"[m
[32m+[m[32m                    onClick={handlePauseWork}[m
[32m+[m[32m                    style={{[m
[32m+[m[32m                      padding: "0.4rem 0.9rem",[m
[32m+[m[32m                      borderRadius: "999px",[m
[32m+[m[32m                      border: "1px solid #f59e0b",[m
[32m+[m[32m                      background: "#ffffff",[m
[32m+[m[32m                      color: "#b45309",[m
[32m+[m[32m                      fontSize: "0.85rem",[m
[32m+[m[32m                      fontWeight: 700,[m
[32m+[m[32m                      letterSpacing: "0.05em",[m
[32m+[m[32m                      textTransform: "uppercase",[m
[32m+[m[32m                      cursor: "pointer",[m
[32m+[m[32m                    }}[m
[32m+[m[32m                  >[m
[32m+[m[32m                    PAUSE[m
[32m+[m[32m                  </button>[m
[32m+[m[32m                )}[m
[32m+[m[32m              </>[m
[32m+[m[32m            )}[m
[32m+[m
[32m+[m[32m            {/* COMPLETE button */}[m
[32m+[m[32m            {(isInProgress || isOnHold) && !isCompleted && !isInvoiced && ([m
[32m+[m[32m              <button[m
[32m+[m[32m                type="button"[m
[32m+[m[32m                onClick={handleMarkComplete}[m
[32m+[m[32m                disabled={isMarkingComplete}[m
[32m+[m[32m                style={{[m
[32m+[m[32m                  padding: "0.4rem 0.9rem",[m
[32m+[m[32m                  borderRadius: "999px",[m
[32m+[m[32m                  border: "1px solid #16a34a",[m
[32m+[m[32m                  background: "#ffffff",[m
[32m+[m[32m                  color: "#16a34a",[m
[32m+[m[32m                  fontSize: "0.85rem",[m
[32m+[m[32m                  fontWeight: 700,[m
[32m+[m[32m                  letterSpacing: "0.05em",[m
[32m+[m[32m                  textTransform: "uppercase",[m
[32m+[m[32m                  cursor: isMarkingComplete ? "default" : "pointer",[m
[32m+[m[32m                  opacity: isMarkingComplete ? 0.7 : 1,[m
[32m+[m[32m                }}[m
[32m+[m[32m              >[m
[32m+[m[32m                {isMarkingComplete ? "..." : "COMPLETE"}[m
[32m+[m[32m              </button>[m
[32m+[m[32m            )}[m
[32m+[m[32m          </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        {/* Right: Nav/actions */}[m
[32m+[m[32m        <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap", justifyContent: "flex-end" }}>[m
[32m+[m[32m          <button type="button" onClick={() => navigate("/work-orders")}>[m
[32m+[m[32m            Back to Work Orders[m
[32m+[m[32m          </button>[m
[32m+[m
[32m+[m[32m          {/* âœ… Invoice block: truth based on resolvedInvoiceId */}[m
[32m+[m[32m          {INVOICE_ENABLED && ([m
[32m+[m[32m            <>[m
[32m+[m[32m              {resolvedInvoiceId ? ([m
[32m+[m[32m                <button type="button" onClick={() => navigate(`/invoices/${resolvedInvoiceId}`)}>[m
[32m+[m[32m                  View Invoice[m
[32m+[m[32m                </button>[m
[32m+[m[32m              ) : isCompleted ? ([m
[32m+[m[32m                <button[m
[32m+[m[32m                  type="button"[m
[32m+[m[32m                  onClick={handleCreateInvoice}[m
[32m+[m[32m                  disabled={!canCreateInvoice}[m
[32m+[m[32m                  title="Create an invoice for this work order."[m
[32m+[m[32m                >[m
[32m+[m[32m                  {isCreatingInvoice ? "Creating Invoiceâ€¦" : "Create Invoice"}[m
[32m+[m[32m                </button>[m
[32m+[m[32m              ) : ([m
[32m+[m[32m                <button type="button" disabled title="Complete the work order before creating an invoice.">[m
[32m+[m[32m                  Create Invoice[m
[32m+[m[32m                </button>[m
[32m+[m[32m              )}[m
[32m+[m[32m            </>[m
[32m+[m[32m          )}[m
[32m+[m
[32m+[m[32m          <button type="button" onClick={handleEdit}>[m
[32m+[m[32m            Edit[m
[32m+[m[32m          </button>[m
[32m+[m
[32m+[m[32m          <button[m
[32m+[m[32m            type="button"[m
[32m+[m[32m            onClick={handleDelete}[m
[32m+[m[32m            style={{[m
[32m+[m[32m              border: "1px solid #b91c1c",[m
[32m+[m[32m              color: "#b91c1c",[m
[32m+[m[32m              background: "transparent",[m
[32m+[m[32m            }}[m
[32m+[m[32m          >[m
[32m+[m[32m            Delete[m
[32m+[m[32m          </button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
[32m+[m
[32m+[m[32m      {/* Optional UI-level error */}[m
       {actionError && ([m
         <div[m
           style={{[m
[36m@@ -624,19 +703,18 @@[m [mconst resolvedInvoiceId = (() => {[m
         </div>[m
       )}[m
 [m
[31m-      {/* TWO-COLUMN MAIN SECTION */}[m
[31m-      <section[m
[32m+[m[32m      {/* CARDS */}[m
[32m+[m[32m      <div[m
         style={{[m
           display: "grid",[m
[31m-          gridTemplateColumns: "1fr 1fr",[m
[31m-          gap: "24px",[m
[31m-          marginTop: "20px",[m
[32m+[m[32m          gridTemplateColumns: "repeat(auto-fit, minmax(320px, 1fr))",[m
[32m+[m[32m          gap: "1rem",[m
[32m+[m[32m          marginBottom: "1rem",[m
         }}[m
       >[m
[31m-        {/* LEFT COLUMN â€” CUSTOMER INFORMATION */}[m
[31m-        <div>[m
[31m-          <h2 style={{ marginBottom: "8px" }}>Customer Information</h2>[m
[31m-[m
[32m+[m[32m        {/* Customer card */}[m
[32m+[m[32m        <div style={{ border: "1px solid #eee", borderRadius: "12px", padding: "1rem" }}>[m
[32m+[m[32m          <h3 style={{ marginTop: 0 }}>Customer</h3>[m
           <p>[m
             <strong>Name:</strong> {displayName}[m
           </p>[m
[36m@@ -651,135 +729,15 @@[m [mconst resolvedInvoiceId = (() => {[m
           </p>[m
         </div>[m
 [m
[31m-        {/* RIGHT COLUMN â€” WORK ORDER DETAILS */}[m
[31m-        <div>[m
[31m-          {/* Work Order Details Header + COMPLETE Button */}[m
[31m-          <div[m
[31m-            style={{[m
[31m-              display: "flex",[m
[31m-              justifyContent: "space-between",[m
[31m-              alignItems: "center",[m
[31m-              marginBottom: "1.5rem",[m
[31m-              gap: "1rem",[m
[31m-            }}[m
[31m-          >[m
[31m-            <h2[m
[31m-              style={{[m
[31m-                fontSize: "1.4rem",[m
[31m-                fontWeight: 600,[m
[31m-                margin: 0,[m
[31m-              }}[m
[31m-            >[m
[31m-              Work Order Details[m
[31m-            </h2>[m
[31m-[m
[31m-            <div[m
[31m-              style={{ display: "flex", alignItems: "center", gap: "0.75rem" }}[m
[31m-            >[m
[31m-              {/* Status pill */}[m
[31m-              <span[m
[31m-          style={{[m
[31m-            padding: "0.35rem 0.85rem",[m
[31m-            borderRadius: "999px",[m
[31m-            border: `2px solid ${statusBorder}`,[m
[31m-            background: statusBg,[m
[31m-            color: statusColor,[m
[31m-            fontSize: "0.85rem",[m
[31m-            fontWeight: 700,[m
[31m-            textTransform: "uppercase",[m
[31m-            letterSpacing: "0.07em",[m
[31m-            whiteSpace: "nowrap",[m
[31m-            boxShadow: "0 0 6px rgba(0,0,0,0.25)",[m
[31m-          }}[m
[31m-        >[m
[31m-          {statusLabel}[m
[31m-              </span>[m
[31m-[m
[31m-                        {/* START / PAUSE / RESUME buttons */}[m
[31m-          {!isCompleted && !isInvoiced && !isCancelled && ([m
[31m-            <>[m
[31m-              {(isOpen || isOnHold) && ([m
[31m-                <button[m
[31m-                  type="button"[m
[31m-                  onClick={handleStartWork}[m
[31m-                  style={{[m
[31m-                    padding: "0.4rem 0.9rem",[m
[31m-                    borderRadius: "999px",[m
[31m-                    border: "1px solid #16a34a",[m
[31m-                    background: "#16a34a",[m
[31m-                    color: "#ffffff",[m
[31m-                    fontSize: "0.85rem",[m
[31m-                    fontWeight: 600,[m
[31m-                    letterSpacing: "0.05em",[m
[31m-                    textTransform: "uppercase",[m
[31m-                    cursor: "pointer",[m
[31m-                  }}[m
[31m-                >[m
[31m-                  {isOnHold ? "RESUME" : "START"}[m
[31m-                </button>[m
[31m-              )}[m
[31m-[m
[31m-              {isInProgress && ([m
[31m-                <button[m
[31m-                  type="button"[m
[31m-                  onClick={handlePauseWork}[m
[31m-                  style={{[m
[31m-                    padding: "0.4rem 0.9rem",[m
[31m-                    borderRadius: "999px",[m
[31m-                    border: "1px solid #f59e0b",[m
[31m-                    background: "#ffffff",[m
[31m-                    color: "#b45309",[m
[31m-                    fontSize: "0.85rem",[m
[31m-                    fontWeight: 600,[m
[31m-                    letterSpacing: "0.05em",[m
[31m-                    textTransform: "uppercase",[m
[31m-                    cursor: "pointer",[m
[31m-                  }}[m
[31m-                >[m
[31m-                  PAUSE[m
[31m-                </button>[m
[31m-              )}[m
[31m-            </>[m
[31m-          )}[m
[31m-[m
[31m-[m
[31m-[m
[31m-              {/* COMPLETE button â€“ only if not already done */}[m
[31m-              {(isInProgress || isOnHold) && !isCompleted && !isInvoiced && ([m
[31m-                  <button[m
[31m-                    type="button"[m
[31m-                    onClick={handleMarkComplete}[m
[31m-                    disabled={isMarkingComplete}[m
[31m-                    style={{[m
[31m-                      padding: "0.4rem 0.9rem",[m
[31m-                      borderRadius: "999px",[m
[31m-                      border: "1px solid #16a34a",[m
[31m-                      background: "#ffffff",[m
[31m-                      color: "#16a34a",[m
[31m-                      fontSize: "0.85rem",[m
[31m-                      fontWeight: 600,[m
[31m-                      letterSpacing: "0.05em",[m
[31m-                      textTransform: "uppercase",[m
[31m-                      cursor: isMarkingComplete ? "default" : "pointer",[m
[31m-                      opacity: isMarkingComplete ? 0.7 : 1,[m
[31m-                    }}[m
[31m-                  >[m
[31m-                    {isMarkingComplete ? "..." : "COMPLETE"}[m
[31m-                  </button>[m
[31m-                )}[m
[31m-            </div>[m
[31m-            <div style={{ marginBottom: "16px" }}>[m
[31m-  <TimelineBlock items={timelineItems} />[m
[31m-</div>[m
[31m-[m
[31m-          </div>[m
[32m+[m[32m        {/* Work Order card */}[m
[32m+[m[32m        <div style={{ border: "1px solid #eee", borderRadius: "12px", padding: "1rem" }}>[m
[32m+[m[32m          <h3 style={{ marginTop: 0 }}>Work Order</h3>[m
 [m
           <p>[m
[31m-            <strong>Date:</strong> {formattedDate}[m
[32m+[m[32m            <strong>Date:</strong> {formattedDate || "â€”"}[m
           </p>[m
           <p>[m
[31m-            <strong>Odometer:</strong>{" "}[m
[31m-            {workOrder.odometer?.toLocaleString() ?? "â€”"}[m
[32m+[m[32m            <strong>Odometer:</strong> {workOrder.odometer?.toLocaleString() ?? "â€”"}[m
           </p>[m
           <p>[m
             <strong>Complaint:</strong> {workOrder.complaint}[m
[36m@@ -792,57 +750,48 @@[m [mconst resolvedInvoiceId = (() => {[m
           </p>[m
 [m
           {workOrder.vehicle && ([m
[31m-            <section style={{ marginTop: "1.5rem" }}>[m
[31m-              <h3 style={{ marginBottom: "0.5rem" }}>Vehicle</h3>[m
[32m+[m[32m            <div style={{ marginTop: "1rem", paddingTop: "0.75rem", borderTop: "1px solid #eee" }}>[m
[32m+[m[32m              <div style={{ fontWeight: 700, marginBottom: "0.25rem" }}>Vehicle</div>[m
 [m
[31m-              <p>[m
[32m+[m[32m              <div>[m
                 {workOrder.vehicle.year && `${workOrder.vehicle.year} `}[m
                 {workOrder.vehicle.make} {workOrder.vehicle.model}[m
[31m-              </p>[m
[32m+[m[32m              </div>[m
 [m
[31m-              {workOrder.vehicle.licensePlate && ([m
[31m-                <p>Plate: {workOrder.vehicle.licensePlate}</p>[m
[31m-              )}[m
[31m-              {workOrder.vehicle.vin && ([m
[31m-                <p>VIN: {workOrder.vehicle.vin}</p>[m
[31m-              )}[m
[31m-              {workOrder.vehicle.color && ([m
[31m-                <p>Color: {workOrder.vehicle.color}</p>[m
[31m-              )}[m
[31m-              {workOrder.vehicle.notes && ([m
[31m-                <p>Notes: {workOrder.vehicle.notes}</p>[m
[31m-              )}[m
[31m-            </section>[m
[32m+[m[32m              {workOrder.vehicle.licensePlate ? <div>Plate: {workOrder.vehicle.licensePlate}</div> : null}[m
[32m+[m[32m              {workOrder.vehicle.vin ? <div>VIN: {workOrder.vehicle.vin}</div> : null}[m
[32m+[m[32m              {workOrder.vehicle.color ? <div>Color: {workOrder.vehicle.color}</div> : null}[m
[32m+[m[32m              {workOrder.vehicle.notes ? <div>Notes: {workOrder.vehicle.notes}</div> : null}[m
[32m+[m[32m            </div>[m
           )}[m
 [m
[31m-          <p>[m
[32m+[m[32m          <p style={{ marginTop: "0.75rem" }}>[m
             <strong>Total:</strong> ${displayTotal.toFixed(2)}[m
           </p>[m
         </div>[m
[31m-      </section>[m
 [m
[31m-      {/* LINE ITEMS SECTION */}[m
[31m-      <section style={{ marginTop: "32px", padding: "50px" }}>[m
[31m-        <div[m
[31m-          style={{[m
[31m-            display: "flex",[m
[31m-            alignItems: "center",[m
[31m-            justifyContent: "space-between",[m
[31m-            marginBottom: "12px",[m
[31m-          }}[m
[31m-        >[m
[32m+[m[32m        {/* Timeline card */}[m
[32m+[m[32m        <div style={{ border: "1px solid #eee", borderRadius: "12px", padding: "1rem" }}>[m
[32m+[m[32m          <h3 style={{ marginTop: 0 }}>Timeline</h3>[m
[32m+[m[32m          <TimelineBlock items={timelineItems} />[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </div>[m
[32m+[m
[32m+[m[32m      {/* LINE ITEMS */}[m
[32m+[m[32m      <div style={{ marginTop: "1.25rem" }}>[m
[32m+[m[32m        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: "1rem" }}>[m
           <h3 style={{ margin: 0 }}>Line Items</h3>[m
 [m
           <button[m
             type="button"[m
             onClick={handleAddLineItem}[m
             style={{[m
[31m-              padding: "6px 12px",[m
[31m-              borderRadius: "4px",[m
[32m+[m[32m              padding: "8px 14px",[m
[32m+[m[32m              borderRadius: "10px",[m
               border: "1px solid #111827",[m
               backgroundColor: "#111827",[m
               color: "#ffffff",[m
[31m-              fontSize: "0.85rem",[m
[32m+[m[32m              fontSize: "0.9rem",[m
               cursor: "pointer",[m
             }}[m
           >[m
[36m@@ -850,102 +799,38 @@[m [mconst resolvedInvoiceId = (() => {[m
           </button>[m
         </div>[m
 [m
[31m-        <div style={{ overflowX: "auto" }}>[m
[31m-          <table[m
[31m-            style={{[m
[31m-              width: "100%",[m
[31m-              borderCollapse: "collapse",[m
[31m-              fontSize: "0.9rem",[m
[31m-            }}[m
[31m-          >[m
[32m+[m[32m        <div style={{ overflowX: "auto", marginTop: "0.75rem" }}>[m
[32m+[m[32m          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: "0.9rem" }}>[m
             <thead>[m
               <tr style={{ borderBottom: "1px solid #e5e7eb" }}>[m
[31m-                <th[m
[31m-                  style={{[m
[31m-                    textAlign: "left",[m
[31m-                    padding: "8px 25px",[m
[31m-                    fontWeight: 600,[m
[31m-                  }}[m
[31m-                >[m
[31m-                  Type[m
[31m-                </th>[m
[31m-                <th[m
[31m-                  style={{[m
[31m-                    textAlign: "left",[m
[31m-                    padding: "8px 8px 8px 0px",[m
[31m-                    fontWeight: 600,[m
[31m-                  }}[m
[31m-                >[m
[31m-                  Description[m
[31m-                </th>[m
[31m-                <th[m
[31m-                  style={{[m
[31m-                    textAlign: "right",[m
[31m-                    padding: "8px",[m
[31m-                    fontWeight: 600,[m
[31m-                  }}[m
[31m-                >[m
[31m-                  Qty / Hours[m
[31m-                </th>[m
[31m-                <th[m
[31m-                  style={{[m
[31m-                    textAlign: "right",[m
[31m-                    padding: "8px",[m
[31m-                    fontWeight: 600,[m
[31m-                  }}[m
[31m-                >[m
[31m-                  Unit Price[m
[31m-                </th>[m
[31m-                <th[m
[31m-                  style={{[m
[31m-                    textAlign: "right",[m
[31m-                    padding: "8px",[m
[31m-                    fontWeight: 600,[m
[31m-                  }}[m
[31m-                >[m
[31m-                  Line Total[m
[31m-                </th>[m
[31m-                <th style={{ padding: "8px", width: "1%" }} />[m
[32m+[m[32m                <th style={{ textAlign: "left", padding: "8px 12px", fontWeight: 600 }}>Type</th>[m
[32m+[m[32m                <th style={{ textAlign: "left", padding: "8px 12px", fontWeight: 600 }}>Description</th>[m
[32m+[m[32m                <th style={{ textAlign: "right", padding: "8px 12px", fontWeight: 600 }}>Qty / Hours</th>[m
[32m+[m[32m                <th style={{ textAlign: "right", padding: "8px 12px", fontWeight: 600 }}>Unit Price</th>[m
[32m+[m[32m                <th style={{ textAlign: "right", padding: "8px 12px", fontWeight: 600 }}>Line Total</th>[m
[32m+[m[32m                <th style={{ padding: "8px 12px", width: "1%" }} />[m
               </tr>[m
             </thead>[m
[32m+[m
             <tbody>[m
               {normalizedLineItems.length === 0 && ([m
                 <tr>[m
[31m-                  <td[m
[31m-                    colSpan={6}[m
[31m-                    style={{[m
[31m-                      padding: "12px 12px",[m
[31m-                      textAlign: "center",[m
[31m-                      color: "#6b7280",[m
[31m-                    }}[m
[31m-                  >[m
[31m-                    No line items yet. Click &ldquo;Add Line&rdquo; to get[m
[31m-                    started.[m
[32m+[m[32m                  <td colSpan={6} style={{ padding: "12px", textAlign: "center", color: "#6b7280" }}>[m
[32m+[m[32m                    No line items yet. Click â€œAdd Lineâ€ to get started.[m
                   </td>[m
                 </tr>[m
               )}[m
 [m
               {normalizedLineItems.map((item, index) => ([m
[31m-                <tr[m
[31m-                  key={index}[m
[31m-                  style={{ borderTop: "1px solid #f3f4f6" }}[m
[31m-                >[m
[31m-                  {/* Type */}[m
[31m-                  <td style={{ padding: "8px 8px 8px 0" }}>[m
[32m+[m[32m                <tr key={index} style={{ borderTop: "1px solid #f3f4f6" }}>[m
[32m+[m[32m                  <td style={{ padding: "8px 12px" }}>[m
                     <select[m
                       value={item.type}[m
[31m-                      onChange={(e) =>[m
[31m-                        handleLineItemChange([m
[31m-                          index,[m
[31m-                          "type",[m
[31m-                          e.target.value[m
[31m-                        )[m
[31m-                      }[m
[32m+[m[32m                      onChange={(e) => handleLineItemChange(index, "type", e.target.value)}[m
                       style={{[m
                         border: "1px solid #d1d5db",[m
[31m-                        borderRadius: "4px",[m
[31m-                        marginLeft: "25px",[m
[31m-                        padding: "4px 6px",[m
[32m+[m[32m                        borderRadius: "8px",[m
[32m+[m[32m                        padding: "6px 8px",[m
                         fontSize: "0.85rem",[m
                       }}[m
                     >[m
[36m@@ -955,76 +840,49 @@[m [mconst resolvedInvoiceId = (() => {[m
                     </select>[m
                   </td>[m
 [m
[31m-                  {/* Description */}[m
[31m-                  <td style={{ padding: "8px 8px 8px 0" }}>[m
[32m+[m[32m                  <td style={{ padding: "8px 12px" }}>[m
                     <input[m
                       type="text"[m
                       value={item.description}[m
[31m-                      onChange={(e) =>[m
[31m-                        handleLineItemChange([m
[31m-                          index,[m
[31m-                          "description",[m
[31m-                          e.target.value[m
[31m-                        )[m
[31m-                      }[m
[31m-                      placeholder={[m
[31m-                        item.type === "labour"[m
[31m-                          ? "e.g. Brake inspection"[m
[31m-                          : "e.g. Brake pads"[m
[31m-                      }[m
[32m+[m[32m                      onChange={(e) => handleLineItemChange(index, "description", e.target.value)}[m
[32m+[m[32m                      placeholder={item.type === "labour" ? "e.g. Brake inspection" : "e.g. Brake pads"}[m
                       style={{[m
                         width: "100%",[m
                         border: "1px solid #d1d5db",[m
[31m-                        borderRadius: "4px",[m
[31m-                        padding: "4px 8px",[m
[32m+[m[32m                        borderRadius: "8px",[m
[32m+[m[32m                        padding: "6px 10px",[m
                         fontSize: "0.85rem",[m
                       }}[m
                     />[m
                   </td>[m
 [m
[31m-                  {/* Quantity */}[m
[31m-                  <td style={{ padding: "8px", textAlign: "right" }}>[m
[32m+[m[32m                  <td style={{ padding: "8px 12px", textAlign: "right" }}>[m
                     <input[m
                       type="text"[m
                       value={item.rawQuantity ?? ""}[m
[31m-                      onChange={(e) =>[m
[31m-                        handleLineItemChange([m
[31m-                          index,[m
[31m-                          "rawQuantity",[m
[31m-                          e.target.value[m
[31m-                        )[m
[31m-                      }[m
[32m+[m[32m                      onChange={(e) => handleLineItemChange(index, "rawQuantity", e.target.value)}[m
                       style={{[m
[31m-                        width: "80px",[m
[32m+[m[32m                        width: "90px",[m
                         border: "1px solid #d1d5db",[m
[31m-                        borderRadius: "4px",[m
[31m-                        padding: "4px 8px",[m
[32m+[m[32m                        borderRadius: "8px",[m
[32m+[m[32m                        padding: "6px 10px",[m
                         fontSize: "0.85rem",[m
                         textAlign: "right",[m
                       }}[m
[31m-                      placeholder={[m
[31m-                        item.type === "labour" ? "e.g. 1:25" : "Qty"[m
[31m-                      }[m
[32m+[m[32m                      placeholder={item.type === "labour" ? "e.g. 1:25" : "Qty"}[m
                     />[m
                   </td>[m
 [m
[31m-                  {/* Unit Price */}[m
[31m-                  <td style={{ padding: "8px", textAlign: "right" }}>[m
[32m+[m[32m                  <td style={{ padding: "8px 12px", textAlign: "right" }}>[m
                     <input[m
                       type="text"[m
                       value={item.rawUnitPrice ?? ""}[m
[31m-                      onChange={(e) =>[m
[31m-                        handleLineItemChange([m
[31m-                          index,[m
[31m-                          "rawUnitPrice",[m
[31m-                          e.target.value[m
[31m-                        )[m
[31m-                      }[m
[32m+[m[32m                      onChange={(e) => handleLineItemChange(index, "rawUnitPrice", e.target.value)}[m
                       style={{[m
[31m-                        width: "100px",[m
[32m+[m[32m                        width: "110px",[m
                         border: "1px solid #d1d5db",[m
[31m-                        borderRadius: "4px",[m
[31m-                        padding: "4px 8px",[m
[32m+[m[32m                        borderRadius: "8px",[m
[32m+[m[32m                        padding: "6px 10px",[m
                         fontSize: "0.85rem",[m
                         textAlign: "right",[m
                       }}[m
[36m@@ -1032,13 +890,9 @@[m [mconst resolvedInvoiceId = (() => {[m
                     />[m
                   </td>[m
 [m
[31m-                  {/* Line Total */}[m
[31m-                  <td style={{ padding: "8px", textAlign: "right" }}>[m
[31m-                    {item.lineTotal.toFixed(2)}[m
[31m-                  </td>[m
[32m+[m[32m                  <td style={{ padding: "8px 12px", textAlign: "right" }}>{item.lineTotal.toFixed(2)}</td>[m
 [m
[31m-                  {/* Remove */}[m
[31m-                  <td style={{ padding: "8px", textAlign: "right" }}>[m
[32m+[m[32m                  <td style={{ padding: "8px 12px", textAlign: "right" }}>[m
                     <button[m
                       type="button"[m
                       onClick={() => handleRemoveLineItem(index)}[m
[36m@@ -1059,267 +913,125 @@[m [mconst resolvedInvoiceId = (() => {[m
           </table>[m
         </div>[m
 [m
[31m-        {/* Totals block */}[m
[31m-        <div[m
[31m-          style={{[m
[31m-            marginTop: "16px",[m
[31m-            display: "flex",[m
[31m-            flexDirection: "column",[m
[31m-            alignItems: "flex-end",[m
[31m-            gap: "4px",[m
[31m-            fontSize: "0.9rem",[m
[31m-          }}[m
[31m-        >[m
[31m-          [m
[31m-          <div style={{ display: "flex", gap: "12px" }}>[m
[31m-            <span style={{ fontWeight: 600 }}>Subtotal:</span>[m
[31m-            <span>${displaySubtotal.toFixed(2)}</span>[m
[31m-          </div>[m
[31m-[m
[31m-          <div[m
[31m-            style={{ display: "flex", gap: "8px", alignItems: "center" }}[m
[31m-          >[m
[31m-            <span style={{ fontWeight: 600 }}>Tax Rate:</span>[m
[31m-            <input[m
[31m-              type="number"[m
[31m-              min={0}[m
[31m-              step="0.1"[m
[31m-              value={taxRate}[m
[31m-              onChange={(e) =>[m
[31m-                setTaxRate(Number(e.target.value) || 0)[m
[31m-              }[m
[31m-              style={{[m
[31m-                width: "80px",[m
[31m-                border: "1px solid #d1d5db",[m
[31m-                borderRadius: "4px",[m
[31m-                padding: "4px 8px",[m
[31m-                fontSize: "0.85rem",[m
[31m-                textAlign: "right",[m
[31m-              }}[m
[31m-            />[m
[31m-            <span>%</span>[m
[31m-          </div>[m
[31m-[m
[31m-          <div style={{ display: "flex", gap: "12px" }}>[m
[31m-            <span style={{ fontWeight: 600 }}>Tax Amount:</span>[m
[31m-            <span>${displayTaxAmount.toFixed(2)}</span>[m
[31m-          </div>[m
[31m-[m
[31m-          <div[m
[31m-            style={{[m
[31m-              display: "flex",[m
[31m-              gap: "12px",[m
[31m-              fontWeight: 700,[m
[31m-              fontSize: "1rem",[m
[31m-              marginTop: "4px",[m
[31m-            }}[m
[31m-          >[m
[31m-            <span>Total:</span>[m
[31m-            <span>${displayTotal.toFixed(2)}</span>[m
[31m-          </div>[m
[31m-        </div>[m
[31m-[m
[31m-        <div[m
[31m-  style={{[m
[31m-    marginTop: "16px",[m
[31m-    display: "flex",[m
[31m-    justifyContent: "flex-end",[m
[31m-    alignItems: "center",[m
[31m-    gap: "10px",[m
[31m-  }}[m
[31m->[m
[31m-  {hasUnsavedChanges && ([m
[31m-    <span[m
[31m-      style={{[m
[31m-        padding: "3px 10px",[m
[31m-        borderRadius: "999px",[m
[31m-        fontSize: "12px",[m
[31m-        border: "1px solid #f59e0b",[m
[31m-        color: "#b45309",[m
[31m-        background: "rgba(245, 158, 11, 0.10)",[m
[31m-        whiteSpace: "nowrap",[m
[31m-      }}[m
[31m-    >[m
[31m-      Unsaved changes[m
[31m-    </span>[m
[31m-  )}[m
[31m-[m
[31m-  <button[m
[31m-    type="button"[m
[31m-    onClick={handleSaveLineItems}[m
[31m-    disabled={saving}[m
[31m-    style={{[m
[31m-      padding: "8px 16px",[m
[31m-      borderRadius: "4px",[m
[31m-      border: "1px solid #4b5563",[m
[31m-      backgroundColor: saving ? "#e5e7eb" : "#111827",[m
[31m-      color: saving ? "#6b7280" : "#ffffff",[m
[31m-      fontSize: "0.9rem",[m
[31m-      cursor: saving ? "default" : "pointer",[m
[31m-    }}[m
[31m-  >[m
[31m-    {saving ? "Saving..." : "Save Line Items"}[m
[31m-  </button>[m
[31m-</div>[m
[31m-[m
[31m-      </section>[m
[31m-[m
[31m-      {/* FOOTER BUTTONS */}[m
[31m-      <footer[m
[31m-        style={{[m
[31m-          marginTop: "24px",[m
[31m-          display: "flex",[m
[31m-          flexDirection: "column",[m
[31m-          gap: "12px",[m
[31m-        }}[m
[31m-      >[m
[31m-        {/* Back Link */}[m
[31m-        <button[m
[31m-          type="button"[m
[31m-          onClick={() => navigate("/work-orders")}[m
[31m-          style={{ alignSelf: "flex-start" }}[m
[31m-        >[m
[31m-          â† Back to Work Orders[m
[31m-        </button>[m
[32m+[m[32m        {/* Totals + Save */}[m
[32m+[m[32m        <div style={{ marginTop: "1rem", display: "flex", justifyContent: "flex-end" }}>[m
[32m+[m[32m          <div style={{ minWidth: "300px", textAlign: "right" }}>[m
[32m+[m[32m            <div style={{ display: "flex", justifyContent: "flex-end", gap: "12px" }}>[m
[32m+[m[32m              <span style={{ fontWeight: 600 }}>Subtotal:</span>[m
[32m+[m[32m              <span>${displaySubtotal.toFixed(2)}</span>[m
[32m+[m[32m            </div>[m
 [m
[31m-        {/* Action Buttons Row */}[m
[31m-        <div[m
[31m-          style={{[m
[31m-            display: "flex",[m
[31m-            gap: "12px",[m
[31m-            flexWrap: "wrap",[m
[31m-          }}[m
[31m-        >[m
[31m-          {/* Edit always available */}[m
[31m-          <button type="button" onClick={handleEdit}>[m
[31m-            Edit[m
[31m-          </button>[m
[32m+[m[32m            <div style={{ display: "flex", justifyContent: "flex-end", gap: "8px", alignItems: "center", marginTop: "6px" }}>[m
[32m+[m[32m              <span style={{ fontWeight: 600 }}>Tax Rate:</span>[m
[32m+[m[32m              <input[m
[32m+[m[32m                type="number"[m
[32m+[m[32m                min={0}[m
[32m+[m[32m                step="0.1"[m
[32m+[m[32m                value={taxRate}[m
[32m+[m[32m                onChange={(e) => setTaxRate(Number(e.target.value) || 0)}[m
[32m+[m[32m                style={{[m
[32m+[m[32m                  width: "80px",[m
[32m+[m[32m                  border: "1px solid #d1d5db",[m
[32m+[m[32m                  borderRadius: "8px",[m
[32m+[m[32m                  padding: "6px 10px",[m
[32m+[m[32m                  fontSize: "0.85rem",[m
[32m+[m[32m                  textAlign: "right",[m
[32m+[m[32m                }}[m
[32m+[m[32m              />[m
[32m+[m[32m              <span>%</span>[m
[32m+[m[32m            </div>[m
 [m
[31m-{/* Invoice-related button */}[m
[31m-{INVOICE_ENABLED && ([m
[31m-  <>[m
[31m-    {/* CASE 1: Invoiced AND we know the invoiceId â†’ show View Invoice */}[m
[31m-    {isInvoiced && resolvedInvoiceId ? ([m
[31m-      <button[m
[31m-        type="button"[m
[31m-        onClick={() => navigate(`/invoices/${resolvedInvoiceId}`)}[m
[31m-        title="View the invoice for this work order."[m
[31m-      >[m
[31m-        View Invoice[m
[31m-      </button>[m
[31m-    ) : isInvoiced && !resolvedInvoiceId ? ([m
[31m-      // CASE 2: Invoiced but no invoiceId (older data)[m
[31m-      <button[m
[31m-        type="button"[m
[31m-        disabled[m
[31m-        title="An invoice already exists for this work order."[m
[31m-      >[m
[31m-        Invoice Created[m
[31m-      </button>[m
[31m-    ) : ([m
[31m-      // CASE 3: Only show Create Invoice when completed and no invoice[m
[31m-      isCompleted &&[m
[31m-      !hasInvoice && ([m
[31m-        <button[m
[31m-          type="button"[m
[31m-          onClick={handleCreateInvoice}[m
[31m-          disabled={!canCreateInvoice}[m
[31m-          title={[m
[31m-            !isCompleted[m
[31m-              ? "Complete the work order before creating an invoice."[m
[31m-              : "Create an invoice for this work order."[m
[31m-          }[m
[31m-        >[m
[31m-          {isCreatingInvoice ? "Creating Invoiceâ€¦" : "Create Invoice"}[m
[31m-        </button>[m
[31m-      )[m
[31m-    )}[m
[31m-  </>[m
[31m-)}[m
[32m+[m[32m            <div style={{ display: "flex", justifyContent: "flex-end", gap: "12px", marginTop: "6px" }}>[m
[32m+[m[32m              <span style={{ fontWeight: 600 }}>Tax Amount:</span>[m
[32m+[m[32m              <span>${displayTaxAmount.toFixed(2)}</span>[m
[32m+[m[32m            </div>[m
 [m
[32m+[m[32m            <div style={{ display: "flex", justifyContent: "flex-end", gap: "12px", fontWeight: 800, fontSize: "1rem", marginTop: "8px" }}>[m
[32m+[m[32m              <span>Total:</span>[m
[32m+[m[32m              <span>${displayTotal.toFixed(2)}</span>[m
[32m+[m[32m            </div>[m
 [m
[31m-          {/* Delete with inline confirmation */}[m
[31m-          <div[m
[31m-            style={{[m
[31m-              display: "flex",[m
[31m-              flexDirection: "column",[m
[31m-              gap: "8px",[m
[31m-            }}[m
[31m-          >[m
[31m-            <div[m
[31m-              style={{[m
[31m-                display: "flex",[m
[31m-                gap: "8px",[m
[31m-                alignItems: "center",[m
[31m-              }}[m
[31m-            >[m
[31m-              {!showDeleteConfirm ? ([m
[31m-                <button[m
[31m-                  type="button"[m
[31m-                  onClick={handleDelete}[m
[32m+[m[32m            <div style={{ marginTop: "12px", display: "flex", justifyContent: "flex-end", alignItems: "center", gap: "10px" }}>[m
[32m+[m[32m              {hasUnsavedChanges && ([m
[32m+[m[32m                <span[m
                   style={{[m
[31m-                    border: "1px solid #b91c1c",[m
[31m-                    color: "#b91c1c",[m
[32m+[m[32m                    padding: "3px 10px",[m
[32m+[m[32m                    borderRadius: "999px",[m
[32m+[m[32m                    fontSize: "12px",[m
[32m+[m[32m                    border: "1px solid #f59e0b",[m
[32m+[m[32m                    color: "#b45309",[m
[32m+[m[32m                    background: "rgba(245, 158, 11, 0.10)",[m
[32m+[m[32m                    whiteSpace: "nowrap",[m
                   }}[m
                 >[m
[31m-                  Delete Work Order[m
[31m-                </button>[m
[31m-              ) : ([m
[31m-                <>[m
[31m-                  <span[m
[31m-                    style={{[m
[31m-                      color: "#b91c1c",[m
[31m-                      fontSize: "0.9rem",[m
[31m-                    }}[m
[31m-                  >[m
[31m-                    Are you sure you want to delete this work order?[m
[31m-                  </span>[m
[31m-                  <button[m
[31m-                    type="button"[m
[31m-                    onClick={confirmDelete}[m
[31m-                    disabled={isDeleting}[m
[31m-                    style={{[m
[31m-                      border: "1px solid #b91c1c",[m
[31m-                      color: "#b91c1c",[m
[31m-                      background: "transparent",[m
[31m-                      padding: "6px 10px",[m
[31m-                      borderRadius: "6px",[m
[31m-                    }}[m
[31m-                  >[m
[31m-                    {isDeleting ? "Deletingâ€¦" : "Yes, delete"}[m
[31m-                  </button>[m
[31m-                  <button[m
[31m-                    type="button"[m
[31m-                    onClick={() => {[m
[31m-                      setShowDeleteConfirm(false);[m
[31m-                      setDeleteError(null);[m
[31m-                    }}[m
[31m-                    style={{[m
[31m-                      border: "1px solid #475569",[m
[31m-                      color: "#e5e7eb",[m
[31m-                      background: "transparent",[m
[31m-                      padding: "6px 10px",[m
[31m-                      borderRadius: "6px",[m
[31m-                    }}[m
[31m-                  >[m
[31m-                    Cancel[m
[31m-                  </button>[m
[31m-                </>[m
[32m+[m[32m                  Unsaved changes[m
[32m+[m[32m                </span>[m
               )}[m
[31m-            </div>[m
[31m-            {deleteError && ([m
[31m-              <div[m
[32m+[m
[32m+[m[32m              <button[m
[32m+[m[32m                type="button"[m
[32m+[m[32m                onClick={handleSaveLineItems}[m
[32m+[m[32m                disabled={saving}[m
                 style={{[m
[31m-                  color: "#ef4444",[m
[31m-                  fontSize: "0.9rem",[m
[32m+[m[32m                  padding: "10px 16px",[m
[32m+[m[32m                  borderRadius: "10px",[m
[32m+[m[32m                  border: "1px solid #4b5563",[m
[32m+[m[32m                  backgroundColor: saving ? "#e5e7eb" : "#111827",[m
[32m+[m[32m                  color: saving ? "#6b7280" : "#ffffff",[m
[32m+[m[32m                  fontSize: "0.95rem",[m
[32m+[m[32m                  cursor: saving ? "default" : "pointer",[m
                 }}[m
               >[m
[31m-                {deleteError}[m
[31m-              </div>[m
[31m-            )}[m
[32m+[m[32m                {saving ? "Saving..." : "Save Line Items"}[m
[32m+[m[32m              </button>[m
[32m+[m[32m            </div>[m
           </div>[m
         </div>[m
[31m-      </footer>[m
[32m+[m[32m      </div>[m
[32m+[m
[32m+[m[32m      {/* Delete confirm */}[m
[32m+[m[32m      {showDeleteConfirm ? ([m
[32m+[m[32m        <div style={{ marginTop: "1.25rem", border: "1px solid #fecaca", background: "#fee2e2", color: "#7f1d1d", borderRadius: "12px", padding: "0.9rem" }}>[m
[32m+[m[32m          <div style={{ fontWeight: 700, marginBottom: "0.35rem" }}>Delete this work order?</div>[m
[32m+[m[32m          <div style={{ fontSize: "0.9rem", marginBottom: "0.75rem" }}>This canâ€™t be undone.</div>[m
[32m+[m
[32m+[m[32m          <div style={{ display: "flex", gap: "10px", flexWrap: "wrap" }}>[m
[32m+[m[32m            <button[m
[32m+[m[32m              type="button"[m
[32m+[m[32m              onClick={confirmDelete}[m
[32m+[m[32m              disabled={isDeleting}[m
[32m+[m[32m              style={{[m
[32m+[m[32m                border: "1px solid #b91c1c",[m
[32m+[m[32m                color: "#b91c1c",[m
[32m+[m[32m                background: "transparent",[m
[32m+[m[32m                padding: "8px 12px",[m
[32m+[m[32m                borderRadius: "10px",[m
[32m+[m[32m              }}[m
[32m+[m[32m            >[m
[32m+[m[32m              {isDeleting ? "Deletingâ€¦" : "Yes, delete"}[m
[32m+[m[32m            </button>[m
[32m+[m
[32m+[m[32m            <button[m
[32m+[m[32m              type="button"[m
[32m+[m[32m              onClick={() => {[m
[32m+[m[32m                setShowDeleteConfirm(false);[m
[32m+[m[32m                setDeleteError(null);[m
[32m+[m[32m              }}[m
[32m+[m[32m              style={{[m
[32m+[m[32m                border: "1px solid #475569",[m
[32m+[m[32m                color: "#e5e7eb",[m
[32m+[m[32m                background: "transparent",[m
[32m+[m[32m                padding: "8px 12px",[m
[32m+[m[32m                borderRadius: "10px",[m
[32m+[m[32m              }}[m
[32m+[m[32m            >[m
[32m+[m[32m              Cancel[m
[32m+[m[32m            </button>[m
[32m+[m[32m          </div>[m
[32m+[m
[32m+[m[32m          {deleteError ? <div style={{ marginTop: "0.5rem", color: "#ef4444" }}>{deleteError}</div> : null}[m
[32m+[m[32m        </div>[m
[32m+[m[32m      ) : null}[m
     </div>[m
   );[m
 }[m
[1mdiff --git a/frontend/src/pages/WorkOrdersPage.tsx b/frontend/src/pages/WorkOrdersPage.tsx[m
[1mindex a311aae..ceafeb7 100644[m
[1m--- a/frontend/src/pages/WorkOrdersPage.tsx[m
[1m+++ b/frontend/src/pages/WorkOrdersPage.tsx[m
[36m@@ -1,196 +1,423 @@[m
 // src/pages/WorkOrdersPage.tsx[m
[31m-import { useEffect, useState } from "react";[m
[31m-import { useLocation, Link } from "react-router-dom";[m
[32m+[m[32mimport { useEffect, useMemo, useState } from "react";[m
[32m+[m[32mimport { useLocation, Link, useNavigate } from "react-router-dom";[m
 import type { WorkOrder } from "../types/workOrder";[m
 import type { Customer } from "../types/customer";[m
 import { fetchWorkOrders } from "../api/workOrders";[m
[32m+[m[32mimport { formatMoney } from "../utils/money";[m
 [m
 [m
 [m
 [m
[31m-function useQuery() {[m
[31m-    const { search } = useLocation();[m
[31m-    return new URLSearchParams(search);[m
[31m-}[m
[32m+[m[32mtype ViewFilter = "active" | "financial" | "archive" | "all";[m
 [m
[31m-  [m
[32m+[m[32mexport default function WorkOrdersPage() {[m
[32m+[m[32m  const navigate = useNavigate();[m
[32m+[m[32m  const location = useLocation();[m
[32m+[m
[32m+[m[32m  // URL params (stable)[m
[32m+[m[32m  const query = useMemo(() => new URLSearchParams(location.search), [location.search]);[m
[32m+[m[32m  const viewParam = query.get("view"); // e.g. financial[m
[32m+[m[32m  const customerId = query.get("customerId") || null;[m
[32m+[m
[32m+[m[32m  // State[m
[32m+[m[32m  const [view, setView] = useState<ViewFilter>(() => {[m
[32m+[m[32m    if (viewParam === "active" || viewParam === "financial" || viewParam === "archive" || viewParam === "all") {[m
[32m+[m[32m      return viewParam;[m
[32m+[m[32m    }[m
[32m+[m[32m    return "active";[m
[32m+[m[32m  });[m
 [m
[32m+[m[32m  const [workOrders, setWorkOrders] = useState<WorkOrder[]>([]);[m
[32m+[m[32m  const [loading, setLoading] = useState(true);[m
[32m+[m[32m  const [error, setError] = useState<string | null>(null);[m
 [m
[31m-export default function WorkOrdersPage() {[m
[31m-    const query = useQuery();[m
[31m-    const customerId = query.get("customerId");[m
[32m+[m[32m  const [sort, setSort] = useState<[m
[32m+[m[32m    | "createdAt-desc"[m
[32m+[m[32m    | "createdAt-asc"[m
[32m+[m[32m    | "status-asc"[m
[32m+[m[32m    | "status-desc"[m
[32m+[m[32m    | "customer-asc"[m
[32m+[m[32m    | "customer-desc"[m
[32m+[m[32m  >("createdAt-desc");[m
 [m
[31m-    const [workOrders, setWorkOrders] = useState<WorkOrder[]>([]);[m
[31m-    const [loading, setLoading] = useState(true);[m
[31m-    const [error, setError] = useState<string | null>(null);[m
[31m-  // ðŸ”¹ NEW: sort state[m
[31m-  [m
[32m+[m[32m  const [search, setSearch] = useState("");[m
 [m
[32m+[m[32m  // If URL view changes (Dashboard click again), sync it into state[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    if (viewParam === "active" || viewParam === "financial" || viewParam === "archive" || viewParam === "all") {[m
[32m+[m[32m      setView(viewParam);[m
[32m+[m[32m    }[m
[32m+[m[32m  }, [viewParam]);[m
[32m+[m
[32m+[m[32m  // Helpers[m
[32m+[m[32m  const formatCustomerName = (customer?: Customer) => {[m
[32m+[m[32m    if (!customer) return "No customer";[m
[32m+[m[32m    return ([m
[32m+[m[32m      customer.name ||[m
[32m+[m[32m      customer.fullName ||[m
[32m+[m[32m      `${customer.firstName ?? ""} ${customer.lastName ?? ""}`.trim() ||[m
[32m+[m[32m      "(No name)"[m
[32m+[m[32m    );[m
[32m+[m[32m  };[m
 [m
[31m-   const [sort, setSort] = useState<[m
[31m-  | "createdAt-desc"[m
[31m-  | "createdAt-asc"[m
[31m-  | "status-asc"[m
[31m-  | "status-desc"[m
[31m-  | "customer-asc"[m
[31m-  | "customer-desc"[m
[31m->("createdAt-desc");[m
[32m+[m[32m  function isValidMongoId(id: string) {[m
[32m+[m[32m    return /^[a-f\d]{24}$/i.test(id);[m
[32m+[m[32m  }[m
 [m
[31m-  const [search, setSearch] = useState("");[m
[32m+[m[32m  function resolveInvoiceId(wo: any): string | null {[m
[32m+[m[32m    const raw = wo?.invoiceId ?? wo?.invoice?._id ?? wo?.invoice?.id ?? null;[m
[32m+[m[32m    if (!raw) return null;[m
 [m
[31m-  [m
[32m+[m[32m    if (typeof raw === "string") return raw;[m
 [m
[31m-  type ViewFilter = "active" | "financial" | "archive" | "all";[m
[31m-  const [view, setView] = useState<ViewFilter>("active");[m
[32m+[m[32m    if (typeof raw === "object") {[m
[32m+[m[32m      if (typeof raw._id === "string") return raw._id;[m
[32m+[m[32m      if (raw._id && typeof raw._id.toString === "function") return raw._id.toString();[m
[32m+[m[32m      if (typeof raw.toString === "function") return raw.toString();[m
[32m+[m[32m    }[m
 [m
[32m+[m[32m    return null;[m
[32m+[m[32m  }[m
 [m
[32m+[m[32m  function handleView(wo: any) {[m
[32m+[m[32m    const inFinancialMode = view === "financial" || view === "archive";[m
[32m+[m[32m    const invoiceId = resolveInvoiceId(wo);[m
[32m+[m
[32m+[m[32m    if (inFinancialMode && invoiceId && isValidMongoId(invoiceId)) {[m
[32m+[m[32m      navigate(`/invoices/${invoiceId}`);[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    navigate(`/work-orders/${wo._id}`);[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  function formatStatusLabel(s?: string) {[m
[32m+[m[32m    if (!s) return "";[m
[32m+[m[32m    return s.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  function workPillClass(status?: string) {[m
[32m+[m[32m    const s = (status || "").toLowerCase();[m
[32m+[m[32m    if (s === "completed") return "bg-green-100 text-green-700";[m
[32m+[m[32m    if (s === "in_progress") return "bg-yellow-100 text-yellow-700";[m
[32m+[m[32m    if (s === "on_hold") return "bg-orange-100 text-orange-700";[m
[32m+[m[32m    if (s === "cancelled") return "bg-red-100 text-red-700";[m
[32m+[m[32m    return "bg-blue-100 text-blue-700";[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // One and only one invoice pill class function[m
[32m+[m[32m  function invoicePillClass(label?: string) {[m
[32m+[m[32m    const s = (label || "").toLowerCase();[m
[32m+[m[32m    if (s === "paid") return "bg-green-100 text-green-700";[m
[32m+[m[32m    if (s === "partial") return "bg-amber-100 text-amber-800";[m
[32m+[m[32m    if (s === "sent") return "bg-blue-100 text-blue-700";[m
[32m+[m[32m    if (s === "void") return "bg-red-100 text-red-700";[m
[32m+[m[32m    if (s === "draft") return "bg-slate-100 text-slate-700";[m
[32m+[m[32m    if (s === "no invoice") return "bg-slate-50 text-slate-500";[m
[32m+[m[32m    return "bg-slate-50 text-slate-500";[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  function getInvoiceDisplayLabel(inv?: any) {[m
[32m+[m[32m  if (!inv) return "â€”";[m
[32m+[m
[32m+[m[32m  // lifecycle-only states still matter[m
[32m+[m[32m  if (inv.status === "void") return "VOID";[m
[32m+[m[32m  if (inv.status === "draft") return "DRAFT";[m
[32m+[m
[32m+[m[32m  // âœ… ONE financial truth for money label[m
[32m+[m[32m  const fs = inv.financialStatus as "due" | "partial" | "paid" | undefined;[m
[32m+[m[32m  if (fs) return fs.toUpperCase(); // DUE / PARTIAL / PAID[m
[32m+[m
[32m+[m[32m  // fallback (shouldn't happen if backend is correct)[m
[32m+[m[32m  return "DUE";[m
[32m+[m[32m}[m
 [m
[31m-    // Helper: format customer name safely[m
[31m-    const formatCustomerName = (customer?: Customer) => {[m
[31m-        if (!customer) return "No customer";[m
[31m-        return ([m
[31m-            customer.name || // optional precomputed name[m
[31m-            customer.fullName ||[m
[31m-            `${customer.firstName ?? ""} ${customer.lastName ?? ""}`.trim() ||[m
[31m-            "(No name)"[m
[31m-        );[m
[31m-    };[m
   [m
[32m+[m[32m  function invoicePillClass(label: string) {[m
[32m+[m[32m  switch (label) {[m
[32m+[m[32m    case "PAID":[m
[32m+[m[32m      return "bg-green-50 text-green-700 border border-green-600";[m
[32m+[m[32m    case "PARTIAL":[m
[32m+[m[32m      return "bg-amber-50 text-amber-700 border border-amber-600";[m
[32m+[m[32m    case "SENT":[m
[32m+[m[32m      return "bg-blue-50 text-blue-700 border border-blue-600";[m
[32m+[m[32m    case "DRAFT":[m
[32m+[m[32m      return "bg-gray-100 text-gray-700 border border-gray-400";[m
[32m+[m[32m    case "VOID":[m
[32m+[m[32m      return "bg-red-50 text-red-700 border border-red-600";[m
[32m+[m[32m    case "NO INVOICE":[m
[32m+[m[32m    default:[m
[32m+[m[32m      return "bg-gray-50 text-gray-600 border border-gray-300";[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
 [m
 [m
[32m+[m[32m  // Fetch work orders (server sort where applicable)[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const loadWorkOrders = async () => {[m
[32m+[m[32m      try {[m
[32m+[m[32m        setLoading(true);[m
[32m+[m[32m        setError(null);[m
[32m+[m
[32m+[m[32m        const isCustomerSort = sort === "customer-asc" || sort === "customer-desc";[m
[32m+[m
[32m+[m[32m        let sortBy: "createdAt" | "status" | undefined;[m
[32m+[m[32m        let sortDir: "asc" | "desc" | undefined;[m
[32m+[m
[32m+[m[32m        if (!isCustomerSort) {[m
[32m+[m[32m          switch (sort) {[m
[32m+[m[32m            case "status-asc":[m
[32m+[m[32m              sortBy = "status";[m
[32m+[m[32m              sortDir = "asc";[m
[32m+[m[32m              break;[m
[32m+[m[32m            case "status-desc":[m
[32m+[m[32m              sortBy = "status";[m
[32m+[m[32m              sortDir = "desc";[m
[32m+[m[32m              break;[m
[32m+[m[32m            case "createdAt-asc":[m
[32m+[m[32m              sortBy = "createdAt";[m
[32m+[m[32m              sortDir = "asc";[m
[32m+[m[32m              break;[m
[32m+[m[32m            case "createdAt-desc":[m
[32m+[m[32m            default:[m
[32m+[m[32m              sortBy = "createdAt";[m
[32m+[m[32m              sortDir = "desc";[m
[32m+[m[32m              break;[m
[32m+[m[32m          }[m
[32m+[m[32m        }[m
 [m
[31m-useEffect(() => {[m
[31m-  const loadWorkOrders = async () => {[m
[31m-    try {[m
[31m-      setLoading(true);[m
[31m-      setError(null);[m
[31m-[m
[31m-      // If we're sorting by customer, do NOT refetch â€” we'll sort in render[m
[31m-      const isCustomerSort = sort === "customer-asc" || sort === "customer-desc";[m
[31m-[m
[31m-      let sortBy: "createdAt" | "status" | undefined;[m
[31m-      let sortDir: "asc" | "desc" | undefined;[m
[31m-[m
[31m-      if (!isCustomerSort) {[m
[31m-        switch (sort) {[m
[31m-          case "status-asc":[m
[31m-            sortBy = "status";[m
[31m-            sortDir = "asc";[m
[31m-            break;[m
[31m-          case "status-desc":[m
[31m-            sortBy = "status";[m
[31m-            sortDir = "desc";[m
[31m-            break;[m
[31m-          case "createdAt-asc":[m
[31m-            sortBy = "createdAt";[m
[31m-            sortDir = "asc";[m
[31m-            break;[m
[31m-          case "createdAt-desc":[m
[31m-          default:[m
[31m-            sortBy = "createdAt";[m
[31m-            sortDir = "desc";[m
[31m-            break;[m
[32m+[m[32m        const raw = await fetchWorkOrders({[m
[32m+[m[32m          customerId: customerId || undefined,[m
[32m+[m[32m          view,[m
[32m+[m[32m          ...(sortBy ? { sortBy } : {}),[m
[32m+[m[32m          ...(sortDir ? { sortDir } : {}),[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32mconst normalized = (raw || []).map((wo: any) => {[m
[32m+[m[32m  const inv = wo?.invoice ?? wo?.invoiceId; // or however you're choosing it[m
[32m+[m
[32m+[m[32m  return {[m
[32m+[m[32m    ...wo,[m
[32m+[m[32m    customer:[m
[32m+[m[32m      wo.customerId && typeof wo.customerId === "object"[m
[32m+[m[32m        ? wo.customerId[m
[32m+[m[32m        : undefined,[m
[32m+[m
[32m+[m[32m    // âœ… keep invoice normalized but DO NOT drop financialStatus[m
[32m+[m[32m    invoice: inv[m
[32m+[m[32m      ? {[m
[32m+[m[32m          _id: inv._id,[m
[32m+[m[32m          invoiceNumber: inv.invoiceNumber,[m
[32m+[m[32m          status: inv.status,[m
[32m+[m[32m          total: inv.total,[m
[32m+[m[32m          paidAmount: inv.paidAmount,[m
[32m+[m[32m          balanceDue: inv.balanceDue,[m
[32m+[m[32m          payments: inv.payments,[m
[32m+[m[32m          sentAt: inv.sentAt,[m
[32m+[m[32m          paidAt: inv.paidAt,[m
[32m+[m[32m          financialStatus: inv.financialStatus, // âœ… ADD THIS[m
         }[m
[32m+[m[32m      : undefined,[m
[32m+[m[32m  };[m
[32m+[m[32m});[m
[32m+[m
[32m+[m
[32m+[m[41m    [m
[32m+[m
[32m+[m[32m        setWorkOrders(normalized);[m
[32m+[m[32m      } catch (err: any) {[m
[32m+[m[32m        console.error("Error fetching work orders:", err);[m
[32m+[m[32m        setError(err.message || "Failed to load work orders");[m
[32m+[m[32m      } finally {[m
[32m+[m[32m        setLoading(false);[m
       }[m
[32m+[m[32m    };[m
 [m
[31m-      const raw = await fetchWorkOrders({[m
[31m-                  customerId: customerId || undefined,[m
[31m-                  view, // âœ… this is the key[m
[31m-                  ...(sortBy ? { sortBy } : {}),[m
[31m-                  ...(sortDir ? { sortDir } : {}),[m
[31m-  });[m
[32m+[m[32m    loadWorkOrders();[m
[32m+[m[32m  }, [customerId, sort, view]);[m
 [m
[32m+[m[32m  // Title[m
[32m+[m[32m  const title = customerId ? "Work Orders for Selected Customer" : "All Work Orders";[m
 [m
[32m+[m[32m  if (loading) return <div className="p-6">Loading work orders...</div>;[m
 [m
[31m-      const normalized: WorkOrder[] = raw.map((wo: any) => ({[m
[31m-            ...wo,[m
[31m-            customer:[m
[31m-              wo.customer ??[m
[31m-              (typeof wo.customerId === "object" ? wo.customerId : undefined),[m
[31m-            [m
[31m-            invoice:[m
[31m-              wo.invoice ??[m
[31m-              (typeof wo.invoiceId === "object" ? wo.invoiceId : undefined),[m
[31m-      }));[m
[31m-[m
[31m-      setWorkOrders(normalized);[m
[31m-    } catch (err: any) {[m
[31m-      console.error("Error fetching work orders:", err);[m
[31m-      setError(err.message || "Failed to load work orders");[m
[31m-    } finally {[m
[31m-      setLoading(false);[m
[31m-    }[m
[31m-  };[m
[32m+[m[32m  if (error) {[m
[32m+[m[32m    return <div className="p-6 text-red-600">There was a problem loading work orders: {error}</div>;[m
[32m+[m[32m  }[m
 [m
[31m-  loadWorkOrders();[m
[31m-}, [customerId, sort, view]);[m
[31m-  [m
[31m-  [m
[31m-  function formatStatusLabel(s?: string) {[m
[31m-  if (!s) return "";[m
[31m-  return s[m
[31m-    .replace(/_/g, " ")[m
[31m-    .replace(/\b\w/g, (c) => c.toUpperCase());[m
[31m-}[m
[32m+[m[32m  console.log("[WO] workOrders raw:", workOrders, "len:", Array.isArray(workOrders) ? workOrders.length : "not-array");[m
[32m+[m[32mconsole.log("[WO] view:", view, "search:", search, "sort:", sort);[m
 [m
[31m-function workPillClass(status?: string) {[m
[31m-  const s = (status || "").toLowerCase();[m
[31m-  if (s === "completed") return "bg-green-100 text-green-700";[m
[31m-  if (s === "in_progress") return "bg-yellow-100 text-yellow-700";[m
[31m-  if (s === "on_hold") return "bg-orange-100 text-orange-700";[m
[31m-  if (s === "cancelled") return "bg-red-100 text-red-700";[m
[31m-  return "bg-blue-100 text-blue-700"; // open/default[m
[31m-}[m
 [m
[31m-function invoicePillClass(status?: string) {[m
[31m-  const s = (status || "").toLowerCase();[m
[31m-  if (s === "paid") return "bg-green-100 text-green-700";[m
[31m-  if (s === "sent") return "bg-blue-100 text-blue-700";[m
[31m-  if (s === "void") return "bg-red-100 text-red-700";[m
[31m-  if (s === "draft") return "bg-slate-100 text-slate-700";[m
[31m-  return "bg-slate-50 text-slate-500";[m
[32m+[m[32m // Filtering/sorting (client-side)[m
[32m+[m[32m  const displayedWorkOrders = (() => {[m
[32m+[m[32m  let list = Array.isArray(workOrders) ? [...workOrders] : [];[m
[32m+[m
[32m+[m
[32m+[m[32m    if (view === "financial") {[m
[32m+[m[32m  const w0 = list?.[0];[m
[32m+[m[32m  console.log("[FIN SHAPE 0]", {[m
[32m+[m[32m    keys: w0 ? Object.keys(w0) : null,[m
[32m+[m[32m    invoiceKeys: w0?.invoice ? Object.keys(w0.invoice) : null,[m
[32m+[m[32m    invoiceIdType: typeof (w0 as any)?.invoiceId,[m
[32m+[m[32m    invoiceIdKeys:[m
[32m+[m[32m      (w0 as any)?.invoiceId && typeof (w0 as any).invoiceId === "object"[m
[32m+[m[32m        ? Object.keys((w0 as any).invoiceId)[m
[32m+[m[32m        : null,[m
[32m+[m[32m  });[m
[32m+[m[32m  console.log("[FIN RAW 0]", w0);[m
 }[m
 [m
 [m
[31m-  [m
[32m+[m[32m  console.log("[DEBUG] workOrders len:", Array.isArray(workOrders) ? workOrders.length : "not-array", workOrders);[m
 [m
 [m
[31m-    const title = customerId[m
[31m-        ? "Work Orders for Selected Customer"[m
[31m-        : "All Work Orders";[m
 [m
[31m-    if (loading) {[m
[31m-        return <div className="p-6">Loading work orders...</div>;[m
[31m-    }[m
[32m+[m[32m  const norm = (x: any) => String(x || "").trim().toLowerCase();[m
 [m
[31m-    if (error) {[m
[31m-        return ([m
[31m-            <div className="p-6 text-red-600">[m
[31m-                There was a problem loading work orders: {error}[m
[31m-            </div>[m
[31m-        );[m
[31m-    }[m
[32m+[m[32m  const getInv = (wo: any) =>[m
[32m+[m[32m  wo?.invoice ?? // âœ… prefer populated invoice (has financialStatus)[m
[32m+[m[32m  (wo as any)?.invoiceId ?? // fallback (often missing financialStatus)[m
[32m+[m[32m  (wo as any)?.latestInvoice ??[m
[32m+[m[32m  (Array.isArray((wo as any)?.invoices) ? (wo as any).invoices[0] : undefined);[m
[32m+[m
[32m+[m
[32m+[m[32m  const getLifecycle = (wo: any) => norm(getInv(wo)?.status); // draft | sent | void[m
[32m+[m[32m    const getFinancial = (wo: any) => norm(wo?.financialStatus ?? getInv(wo)?.financialStatus); // due | partial | paid[m
[32m+[m[41m    [m
[32m+[m[32m    if (view === "financial") console.log("[FIN quick counts]", {[m
[32m+[m[32m          due: list.filter((w:any) => getFinancial(w)==="due").length,[m
[32m+[m[32m          partial: list.filter((w:any) => getFinancial(w)==="partial").length,[m
[32m+[m[32m          paid: list.filter((w:any) => getFinancial(w)==="paid").length,[m
[32m+[m[32m        });[m
 [m
[31m- [m
[31m-const displayedWorkOrders = (() => {[m
[31m-  let list = [...workOrders];[m
 [m
[31m-  // ðŸ” Search by customer name[m
[31m-  const q = search.trim().toLowerCase();[m
[32m+[m[32m  const isArchived = (wo: any) => {[m
[32m+[m[32m    // âœ… archive is NOT money truth â€” it's closure + void[m
[32m+[m[32m    if (wo?.closedAt) return true;[m
[32m+[m[32m    if (getLifecycle(wo) === "void") return true;[m
[32m+[m[32m    return false;[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  const isFinancialOpen = (wo: any) => {[m
[32m+[m[32m    // âœ… financial list shows only open money: due/partial[m
[32m+[m[32m    const fs = getFinancial(wo);[m
[32m+[m[32m    if (!fs) return false;[m
[32m+[m[32m    return fs === "due" || fs === "partial";[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  // Search[m
[32m+[m[32m  const q = String(search || "").trim().toLowerCase();[m
   if (q) {[m
[31m-    list = list.filter((wo) =>[m
[31m-      formatCustomerName(wo.customer).toLowerCase().includes(q)[m
[32m+[m[32m    list = list.filter((wo: any) =>[m
[32m+[m[32m      formatCustomerName(wo?.customer).toLowerCase().includes(q)[m
     );[m
   }[m
 [m
[31m-  // ðŸ”¤ Customer Aâ€“Z / Zâ€“A sorting (frontend)[m
[32m+[m[32m    if (view === "financial") {[m
[32m+[m[32m  console.log("[DEBUG:PRE-FILTER:FINANCIAL]", {[m
[32m+[m[32m    total: list.length,[m
[32m+[m[32m    withInvoice: list.filter((w: any) => !!w?.invoice).length,[m
[32m+[m[32m    withAnyInvoiceLike:[m
[32m+[m[32m      list.filter([m
[32m+[m[32m        (w: any) =>[m
[32m+[m[32m          w?.invoice ||[m
[32m+[m[32m          w?.latestInvoice ||[m
[32m+[m[32m          (Array.isArray(w?.invoices) && w.invoices.length > 0)[m
[32m+[m[32m      ).length,[m
[32m+[m[32m    financialStatuses: list.map((w: any) => ({[m
[32m+[m[32m      id: w?._id,[m
[32m+[m[32m      fs:[m
[32m+[m[32m        w?.invoice?.financialStatus ??[m
[32m+[m[32m        w?.latestInvoice?.financialStatus ??[m
[32m+[m[32m        (Array.isArray(w?.invoices) ? w.invoices[0]?.financialStatus : undefined),[m
[32m+[m[32m    })),[m
[32m+[m[32m  });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m
[32m+[m[32m    if (view === "financial") {[m
[32m+[m[32m  console.log("[DEBUG:PRE-FILTER:FIN]", {[m
[32m+[m[32m    listLen: list.length,[m
[32m+[m[32m    sampleKeys0: list[0] ? Object.keys(list[0]) : null,[m
[32m+[m[32m    sampleInvoice0: list[0]?.invoice,[m
[32m+[m[32m    sampleLatestInvoice0: (list[0] as any)?.latestInvoice,[m
[32m+[m[32m    sampleInvoices0: (list[0] as any)?.invoices,[m
[32m+[m[32m  });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m
[32m+[m[32m    // View filter[m
[32m+[m[32m    list = list.filter((wo: any) => {[m
[32m+[m[32m      const inv =[m
[32m+[m[32m        wo?.invoice ??[m
[32m+[m[32m        (wo as any)?.latestInvoice ??[m
[32m+[m[32m        (Array.isArray((wo as any)?.invoices) ? (wo as any).invoices[0] : undefined);[m
[32m+[m
[32m+[m[32m      const lifecycle = String(inv?.status || "").trim().toLowerCase();        // draft | sent | void[m
[32m+[m[32m      const fs = String(getInv(wo)?.financialStatus || "")[m
[32m+[m[32m      .trim()[m
[32m+[m[32m      .toLowerCase(); // due | partial | paid[m
[32m+[m
[32m+[m[41m     [m
[32m+[m
[32m+[m[32m      // âœ… Archive definition: paid OR closed OR void[m
[32m+[m[32m      const archived = fs === "paid" || !!wo?.closedAt || lifecycle === "void";[m
[32m+[m
[32m+[m[32m      // âœ… DEBUG (SAFE): now lifecycle/fs exist[m
[32m+[m[32m      if (view === "financial") {[m
[32m+[m[32m        console.log("[DEBUG:FILTER:FIN]", {[m
[32m+[m[32m          id: wo?._id,[m
[32m+[m[32m          hasInv: !!inv,[m
[32m+[m[32m          lifecycle,[m
[32m+[m[32m          fs,[m
[32m+[m[32m          closedAt: !!wo?.closedAt,[m
[32m+[m[32m          archived,[m
[32m+[m[32m          passes: !archived && (fs === "due" || fs === "partial"),[m
[32m+[m[32m        });[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      switch (view) {[m
[32m+[m[32m        case "archive":[m
[32m+[m[32m          return archived;[m
[32m+[m
[32m+[m[32m        case "active":[m
[32m+[m[32m          return !archived;[m
[32m+[m
[32m+[m[32m        case "financial":[m
[32m+[m[32m          // âœ… Financial = open money only (due/partial), not archived, not void[m
[32m+[m[32m          return !archived && (fs === "due" || fs === "partial");[m
[32m+[m
[32m+[m[32m        case "all":[m
[32m+[m[32m        default:[m
[32m+[m[32m          return true;[m
[32m+[m[32m      }[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m
[32m+[m[32mif (view === "financial") {[m
[32m+[m[32m  console.log("[FIN RESULT]", {[m
[32m+[m[32m    afterFilter: list.length,[m
[32m+[m[32m    due: list.filter((w: any) => String(w?.financialStatus ?? w?.invoiceId?.financialStatus ?? w?.invoice?.financialStatus ?? "").toLowerCase() === "due").length,[m
[32m+[m[32m    partial: list.filter((w: any) => String(w?.financialStatus ?? w?.invoiceId?.financialStatus ?? w?.invoice?.financialStatus ?? "").toLowerCase() === "partial").length,[m
[32m+[m[32m    paid: list.filter((w: any) => String(w?.financialStatus ?? w?.invoiceId?.financialStatus ?? w?.invoice?.financialStatus ?? "").toLowerCase() === "paid").length,[m
[32m+[m[32m    closed: list.filter((w: any) => !!w?.closedAt).length,[m
[32m+[m[32m  });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m
[32m+[m
[32m+[m
[32m+[m
[32m+[m
[32m+[m[32m  // Customer sorting (frontend)[m
   if (sort === "customer-asc" || sort === "customer-desc") {[m
     const dir = sort === "customer-asc" ? 1 : -1;[m
 [m
[31m-    list.sort((a, b) => {[m
[31m-      const nameA = formatCustomerName(a.customer).toLowerCase();[m
[31m-      const nameB = formatCustomerName(b.customer).toLowerCase();[m
[31m-[m
[32m+[m[32m    list.sort((a: any, b: any) => {[m
[32m+[m[32m      const nameA = formatCustomerName(a?.customer).toLowerCase();[m
[32m+[m[32m      const nameB = formatCustomerName(b?.customer).toLowerCase();[m
       if (nameA < nameB) return -1 * dir;[m
       if (nameA > nameB) return 1 * dir;[m
       return 0;[m
[36m@@ -200,8 +427,34 @@[m [mconst displayedWorkOrders = (() => {[m
   return list;[m
 })();[m
 [m
[32m+[m[32m if (view === "financial") {[m
[32m+[m[32m  console.log("[RENDER CHECK SAMPLE IDS]", displayedWorkOrders.slice(0, 5).map((w: any) => w?._id));[m
[32m+[m[32m}[m
[32m+[m
 [m
[32m+[m[32m// ---- Financial helpers (backend truth only) ----[m
[32m+[m[32mtype InvoiceFinancialStatus = "paid" | "partial" | "due";[m
 [m
[32m+[m[32mfunction getInvoiceFinancialLabel([m
[32m+[m[32m  wo: any[m
[32m+[m[32m): "NO INVOICE" | "VOID" | "PAID" | "PARTIAL" | "SENT" {[m
[32m+[m[32m  const inv = wo?.invoice;[m
[32m+[m[32m  if (!inv) return "NO INVOICE";[m
[32m+[m
[32m+[m[32m  const lifecycle = String(inv.status || "").toLowerCase();[m
[32m+[m[32m  if (lifecycle === "void") return "VOID";[m
[32m+[m
[32m+[m[32m  const fin = inv.financialStatus as InvoiceFinancialStatus | undefined;[m
[32m+[m
[32m+[m[32m  if (fin === "paid") return "PAID";[m
[32m+[m[32m  if (fin === "partial") return "PARTIAL";[m
[32m+[m
[32m+[m[32m  // due â†’ use existing UI language[m
[32m+[m[32m  return "SENT";[m
[32m+[m[32m}[m
[32m+[m
[32m+[m
[32m+[m[32m  // âœ… JSX return starts after this...[m
 [m
 [m
 [m
[36m@@ -321,7 +574,7 @@[m [mreturn ([m
     </div>[m
     <div className="mt-6"></div>[m
     {/* â¬‡ï¸ everything below this stays exactly as you had it (no changes) */}[m
[31m-    {workOrders.length === 0 ? ([m
[32m+[m[32m    {displayedWorkOrders.length === 0 ? ([m
       <p className="text-sm text-slate-500">[m
         {customerId[m
           ? "No work orders found for this customer yet."[m
[36m@@ -353,69 +606,110 @@[m [mreturn ([m
                                 </tr>[m
                             </thead>[m
 [m
[31m-                            <tbody>[m
[31m-                                {displayedWorkOrders.map((wo) => ([m
[31m-[m
[31m-                                    <tr[m
[31m-                                        key={wo._id}[m
[31m-                                        className="border-b border-slate-100 hover:bg-slate-50"[m
[31m-                                    >[m
[31m-                                        <td className="px-4 py-2 whitespace-nowrap text-xs text-slate-500 font-mono">[m
[31m-                                            {wo._id}[m
[31m-                                        </td>[m
[31m-                                        <td className="px-4 py-2 whitespace-nowrap">[m
[31m-                                            {formatCustomerName(wo.customer)}[m
[31m-                                        </td>[m
[31m-                                        <td className="px-4 py-2 whitespace-nowrap">[m
[31m-                                            <Link[m
[31m-                                                to={`/work-orders/${wo._id}`}[m
[31m-                                                className="text-xs text-blue-600 hover:text-blue-800"[m
[31m-                                            >[m
[31m-                                                View[m
[31m-                    </Link>[m
[31m-                                        </td>[m
[31m-                                        <td className="px-4 py-2 whitespace-nowrap">[m
[31m-                                      <div className="flex items-center gap-2">[m
[31m-                                        {/* Pill 1: Work status */}[m
[31m-                                        <span[m
[31m-                                          className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${workPillClass([m
[31m-                                            wo.status[m
[31m-                                          )}`}[m
[31m-                                          title={`Work: ${formatStatusLabel(wo.status)}`}[m
[31m-                                        >[m
[31m-                                          {formatStatusLabel(wo.status)}[m
[31m-                                        </span>[m
[31m-[m
[31m-                                        {/* Pill 2: Invoice status (or "No Invoice" in financial/admin view) */}[m
[31m-                                        <span[m
[31m-                                          className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${invoicePillClass([m
[31m-                                            (wo as any).invoice?.status[m
[31m-                                          )}`}[m
[31m-                                          title={[m
[31m-                                            (wo as any).invoice?.status[m
[31m-                                              ? `Invoice: ${formatStatusLabel((wo as any).invoice.status)}`[m
[31m-                                              : "Invoice: None"[m
[31m-                                          }[m
[31m-                                        >[m
[31m-                                          {(wo as any).invoice?.status[m
[31m-                                            ? formatStatusLabel((wo as any).invoice.status)[m
[31m-                                            : "No Invoice"}[m
[31m-                                        </span>[m
[31m-                                      </div>[m
[31m-                                    </td>[m
[31m-[m
[31m-                                        <td className="px-4 py-2 whitespace-nowrap text-right">[m
[31m-                                            {(wo.total ?? 0).toLocaleString("en-CA", {[m
[31m-                                                style: "currency",[m
[31m-                                                currency: "CAD",[m
[31m-                                            })}[m
[31m-                                        </td>[m
[31m-                                        <td className="px-4 py-2 whitespace-nowrap text-xs text-slate-500">[m
[31m-                                            {new Date(wo.createdAt).toLocaleDateString("en-CA")}[m
[31m-                                        </td>[m
[31m-                                    </tr>[m
[31m-                                ))}[m
[31m-                            </tbody>[m
[32m+[m[41m     [m
[32m+[m[32m              <tbody>[m
[32m+[m[32m  {displayedWorkOrders.length === 0 ? ([m
[32m+[m[32m    <tr>[m
[32m+[m[32m      <td colSpan={6} className="px-4 py-6 text-sm text-slate-500">[m
[32m+[m[32m        No work orders found.[m
[32m+[m[32m      </td>[m
[32m+[m[32m    </tr>[m
[32m+[m[32m  ) : ([m
[32m+[m[32m    displayedWorkOrders.map((wo: any) => ([m
[32m+[m[32m      <tr[m
[32m+[m[32m        key={wo._id}[m
[32m+[m[32m        className="border-b border-slate-100 hover:bg-slate-50"[m
[32m+[m[32m      >[m
[32m+[m[32m        <td className="px-4 py-2 whitespace-nowrap text-xs text-slate-500 font-mono">[m
[32m+[m[32m          {wo._id}[m
[32m+[m[32m        </td>[m
[32m+[m
[32m+[m[32m        <td className="px-4 py-2 whitespace-nowrap">[m
[32m+[m[32m          {formatCustomerName(wo.customer)}[m
[32m+[m[32m        </td>[m
[32m+[m
[32m+[m[32m        <td className="px-4 py-2 whitespace-nowrap">[m
[32m+[m[32m          <button[m
[32m+[m[32m            type="button"[m
[32m+[m[32m            onClick={() => handleView(wo)}[m
[32m+[m[32m            style={{[m
[32m+[m[32m              display: "inline-flex",[m
[32m+[m[32m              alignItems: "center",[m
[32m+[m[32m              justifyContent: "center",[m
[32m+[m[32m              height: "28px",[m
[32m+[m[32m              padding: "0 20px",[m
[32m+[m[32m              borderRadius: "8px",[m
[32m+[m[32m              border: "1px solid #cbd5e1",[m
[32m+[m[32m              background: "#0a0337ff",[m
[32m+[m[32m              color: "#f9fafbff",[m
[32m+[m[32m              fontSize: "1rem",[m
[32m+[m[32m              fontWeight: 900,[m
[32m+[m[32m              cursor: "pointer",[m
[32m+[m[32m            }}[m
[32m+[m[32m          >[m
[32m+[m[32m            View[m
[32m+[m[32m          </button>[m
[32m+[m[32m        </td>[m
[32m+[m
[32m+[m[32m        {/* âœ… Financial status column (ONE truth) */}[m
[32m+[m[41m     [m
[32m+[m
[32m+[m[32m        <td className="px-4 py-2 whitespace-nowrap">[m
[32m+[m[32m  {(() => {[m
[32m+[m[32m    const inv = wo?.invoice;[m
[32m+[m[32m    if (!inv) return null;[m
[32m+[m
[32m+[m[32m    const fs = (inv.financialStatus as "due" | "partial" | "paid" | undefined) || undefined;[m
[32m+[m
[32m+[m[32m    const label =[m
[32m+[m[32m      fs === "paid"[m
[32m+[m[32m        ? "PAID "[m
[32m+[m[32m        : fs === "partial"[m
[32m+[m[32m        ? "PARTIAL "[m
[32m+[m[32m        : fs === "due"[m
[32m+[m[32m        ? "DUE "[m
[32m+[m[32m        : "â€” ";[m
[32m+[m
[32m+[m[32m    const paidAmt = Number(inv.paidAmount || 0);[m
[32m+[m[32m    const bal = Number(inv.balanceDue || 0);[m
[32m+[m[32m    const total = Number(inv.total || 0);[m
[32m+[m
[32m+[m[32m    // âœ… Detail text without repeating the label word[m
[32m+[m[32m    const detail =[m
[32m+[m[32m      fs === "partial"[m
[32m+[m[32m        ? `${formatMoney(paidAmt)} â€¢ Bal ${formatMoney(bal)}`[m
[32m+[m[32m        : fs === "due"[m
[32m+[m[32m        ? `${formatMoney(total)} â€¢ Bal ${formatMoney(bal)}`[m
[32m+[m[32m        : fs === "paid"[m
[32m+[m[32m        ? `${formatMoney(total)}`[m
[32m+[m[32m        : "";[m
[32m+[m
[32m+[m[32m    return ([m
[32m+[m[32m  <div className="flex items-center gap-2">[m
[32m+[m[32m    <span className="font-semibold">{label}</span>[m
[32m+[m[32m    {detail ? ([m
[32m+[m[32m      <span className="text-slate-600">{detail}</span>[m
[32m+[m[32m    ) : null}[m
[32m+[m[32m  </div>[m
[32m+[m[32m);[m
[32m+[m[32m  })()}[m
[32m+[m[32m</td>[m
[32m+[m
[32m+[m
[32m+[m[32m        <td className="px-4 py-2 whitespace-nowrap text-right">[m
[32m+[m[32m          {formatMoney(wo.total ?? 0)}[m
[32m+[m[32m        </td>[m
[32m+[m
[32m+[m[32m        <td className="px-4 py-2 whitespace-nowrap text-xs text-slate-500">[m
[32m+[m[32m          {wo.createdAt ? new Date(wo.createdAt).toLocaleDateString("en-CA") : "â€”"}[m
[32m+[m[32m        </td>[m
[32m+[m[32m      </tr>[m
[32m+[m[32m    ))[m
[32m+[m[32m  )}[m
[32m+[m[32m</tbody>[m
[32m+[m
[32m+[m
[32m+[m[41m                          [m
                         </table>[m
                     </div>[m
                 )}[m
[1mdiff --git a/frontend/src/types/invoice.ts b/frontend/src/types/invoice.ts[m
[1mindex a47ce6f..4e02a3a 100644[m
[1m--- a/frontend/src/types/invoice.ts[m
[1m+++ b/frontend/src/types/invoice.ts[m
[36m@@ -1,8 +1,9 @@[m
[31m-// frontend/src/types/invoice.ts[m
[32m+[m[32m//frontend/src/types/invoice.ts[m
 import type { WorkOrderLineItem, WorkOrderVehicle } from "./workOrder";[m
 import type { Customer } from "./customer";[m
 [m
 export type InvoiceStatus = "draft" | "sent" | "paid" | "void";[m
[32m+[m[32mexport type FinancialStatus = "paid" | "partial" | "due";[m
 [m
 export interface InvoiceLineItem {[m
   type?: WorkOrderLineItem["type"];[m
[36m@@ -12,9 +13,8 @@[m [mexport interface InvoiceLineItem {[m
   lineTotal: number;[m
 }[m
 [m
[31m-// Snapshot of customer at the time of invoicing[m
 export interface InvoiceCustomerSnapshot {[m
[31m-  customerId: string;               // for linking back if needed[m
[32m+[m[32m  customerId: string;[m
   firstName?: string;[m
   lastName?: string;[m
   phone?: string;[m
[36m@@ -22,29 +22,34 @@[m [mexport interface InvoiceCustomerSnapshot {[m
   address?: string;[m
 }[m
 [m
[32m+[m[32mexport type InvoiceEmailStatus = "never_sent" | "sending" | "sent" | "failed";[m
 [m
[31m-  export type InvoiceEmailStatus = "never_sent" | "sending" | "sent" | "failed";[m
[32m+[m[32mexport type InvoiceEmailMeta = {[m
[32m+[m[32m  status: InvoiceEmailStatus;[m
[32m+[m[32m  lastTo?: string;[m
[32m+[m[32m  lastSentAt?: string;[m
[32m+[m[32m  lastMessageId?: string;[m
[32m+[m[32m  lastError?: string;[m
[32m+[m[32m  attempts?: number;[m
[32m+[m[32m};[m
 [m
[31m-  export type InvoiceEmailMeta = {[m
[31m-    status: InvoiceEmailStatus;[m
[31m-    lastTo?: string;[m
[31m-    lastSentAt?: string;     // ISO string from API[m
[31m-    lastMessageId?: string;[m
[31m-    lastError?: string;[m
[31m-    attempts?: number;[m
[31m-  };[m
[31m-[m
[31m-// Main Invoice type[m
 export interface Invoice {[m
   _id: string;[m
[31m-  invoiceNumber: string;            // human-visible number, e.g. "1001" or "2025-001"[m
[31m-  status: "draft" | "sent" | "paid" | "void";[m
[32m+[m[32m  invoiceNumber: string;[m
[32m+[m
[32m+[m[32m  // lifecycle[m
[32m+[m[32m  status: InvoiceStatus;[m
[32m+[m
[32m+[m[32m  // âœ… canonical financial truth (from backend)[m
[32m+[m[32m  financialStatus: FinancialStatus;[m
[32m+[m[32m  paidAmount: number;[m
[32m+[m[32m  balanceDue: number;[m
 [m
[31m-  workOrderId: string | { _id: string };  // for quick reference[m
[32m+[m[32m  workOrderId: string | { _id: string };[m
   customerSnapshot: InvoiceCustomerSnapshot;[m
   vehicleSnapshot?: WorkOrderVehicle;[m
 [m
[31m-  issueDate: string;                // ISO strings[m
[32m+[m[32m  issueDate: string;[m
   dueDate?: string;[m
 [m
   lineItems: InvoiceLineItem[];[m
[36m@@ -59,7 +64,7 @@[m [mexport interface Invoice {[m
   createdAt?: string;[m
   updatedAt?: string;[m
 [m
[31m-  // Optional population for UI niceness later (not required by backend)[m
[32m+[m[32m  // optional populated helpers[m
   workOrder?: {[m
     _id: string;[m
     status: string;[m
[36m@@ -67,7 +72,3 @@[m [mexport interface Invoice {[m
   customer?: Customer;[m
   email?: InvoiceEmailMeta;[m
 }[m
[31m-[m
[31m-[m
[31m-[m
[31m-[m
